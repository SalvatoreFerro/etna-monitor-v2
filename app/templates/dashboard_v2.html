{% extends "layout.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_v2.css') }}?v={{ STATIC_ASSET_VERSION }}">
<meta name="theme-color" content="#041021">
{% endblock %}

{% block content %}
{% set telegram_connected = (user.telegram_chat_id or user.chat_id) and user.telegram_opt_in %}
{% set threshold_configured = user.has_premium_access and user.threshold is not none %}
<div class="dashboard-v2">
  <header class="dashboard-app-bar" role="banner">
    <div class="app-bar-left">
      <a class="app-bar-brand" href="/" aria-label="EtnaMonitor home">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Logo EtnaMonitor" class="app-bar-logo" />
        <span class="app-bar-title">EtnaMonitor</span>
      </a>
      <span class="app-bar-context">Dashboard</span>
      <nav class="app-bar-nav" aria-label="Navigazione rapida">
        <a href="{{ url_for('main.index') }}">Home</a>
        <a href="{{ url_for('main.index') }}#grafico-etna">Grafico</a>
        <a href="{{ url_for('community.community_landing') }}">Community</a>
      </nav>
    </div>
    <div class="app-bar-actions">
      <a class="btn btn-ghost btn-sm" href="{{ url_for('dashboard.settings') }}">Impostazioni</a>
      <a class="btn btn-secondary btn-sm" href="{{ url_for('main.logout') }}">Logout</a>
    </div>
  </header>

  <section class="dashboard-layout" aria-label="Dashboard Utente">
    <section class="dashboard-status card" id="tremor-status" aria-label="Stato">
      <header class="card-header">
        <h2>Stato</h2>
        <p class="muted">KPI live con trend, soglia attiva e ultimo aggiornamento.</p>
      </header>
      <div class="kpi-grid" role="group" aria-label="Metriche principali">
        <div class="kpi-card">
          <span class="kpi-label">Tremore</span>
          <div class="kpi-value-row">
            <span class="kpi-value" id="current-value">--</span>
            <span class="kpi-unit">mV</span>
          </div>
          <span class="status-indicator" id="status-indicator">
            <span id="status-text">--</span>
          </span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Trend</span>
          <span class="trend-indicator" id="trend-status">--</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Soglia attiva</span>
          <span
            class="kpi-value kpi-value--small"
            id="active-threshold"
            data-threshold="{{ '%.2f'|format(active_threshold) }}"
            data-source="{{ threshold_source }}"
            data-debug="{{ '1' if debug_alerts_enabled else '0' }}"
          >
            {{ "%.2f"|format(active_threshold) }} mV ({% if threshold_source == 'user/custom' %}personalizzata{% else %}default{% endif %})
          </span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Ultimo update</span>
          <span class="kpi-value kpi-value--small" id="last-updated">Ultimo aggiornamento: --</span>
        </div>
      </div>
      {% if debug_alerts_enabled %}
      <p class="muted" id="debug-threshold">
        DEBUG: threshold_used_for_badge={{ "%.2f"|format(active_threshold) }} | source={{ threshold_source }} | current={{ "%.2f"|format(latest_value) }}
      </p>
      {% endif %}
    </section>

    <section class="dashboard-chart card card--plot" id="tremor-chart" aria-label="Grafico tremore">
      <header class="chart-header">
        <div>
          <h2>Grafico</h2>
          <p class="muted">Serie storica del tremore in tempo reale.</p>
        </div>
        <div class="chart-header-actions">
          <label for="time-range" class="sr-only">Seleziona intervallo temporale per il grafico</label>
          <select id="time-range" class="input-base" aria-label="Selettore intervallo temporale">
            <option value="288">Ultime 24 ore</option>
            <option value="864">Ultimi 3 giorni</option>
            <option value="2016" selected>Ultimi 7 giorni</option>
          </select>
          {% if user.has_premium_access %}
          <button id="update-btn" class="btn btn-premium btn-sm">Aggiorna</button>
          {% endif %}
        </div>
      </header>

      <div class="chart-toolbar">
        <div class="chart-actions">
          {% if user.has_premium_access %}
          <button id="export-csv" class="btn btn-secondary btn-sm glass" aria-label="Esporta dati come file CSV">CSV</button>
          <button id="export-png" class="btn btn-secondary btn-sm glass" aria-label="Esporta grafico come immagine PNG">PNG</button>
          {% endif %}
        </div>
        <div class="chart-interaction-controls" role="group" aria-label="Controlli analisi grafico">
          <button
            type="button"
            id="dashboard-analyze-toggle"
            class="btn btn-secondary btn-sm chart-interaction-toggle"
            aria-pressed="false"
          >
            Analizza
          </button>
          <button
            type="button"
            id="dashboard-reset-view"
            class="btn btn-ghost btn-sm chart-interaction-reset"
          >
            Reset vista
          </button>
        </div>
      </div>

      <p id="dashboard-analyze-hint" class="chart-interaction-hint" role="status" aria-live="polite">
        Suggerimento: premi Analizza e trascina sul grafico per selezionare un intervallo.
      </p>
      <span id="dashboard-analyze-status" class="chart-mode-indicator" aria-live="polite" aria-hidden="true">
        Modalit√† analisi attiva
      </span>

      <div class="plot-wrap inner">
        <div
          id="tremor-plot"
          class="chart-container"
          role="img"
          tabindex="0"
          aria-label="Grafico dati tremore vulcanico"
        ></div>
      </div>
    </section>

    <!-- TASK 1: Gamification Hero Section -->
    <section class="dashboard-gamification-hero card" id="gamification-overview" aria-label="Il tuo progresso">
      <header class="card-header">
        <h2>üéÆ Il tuo progresso</h2>
        <p class="muted">Il tuo livello, punti e badge sbloccati.</p>
      </header>
      
      <div class="gamification-kpi-grid">
        <!-- KPI 1: Level -->
        <div class="gamification-kpi-card">
          <span class="kpi-label">Level attuale</span>
          <div class="kpi-value-row">
            <span class="kpi-value">Level {{ user_level }}</span>
          </div>
          <span class="gamification-level-title">{{ user_level_description.split('¬∑')[1].strip() if '¬∑' in user_level_description else user_level_description }}</span>
        </div>

        <!-- KPI 2: Punti -->
        <div class="gamification-kpi-card">
          <span class="kpi-label">Punti totali</span>
          <div class="kpi-value-row">
            {% if user_points > 0 %}
              <span class="kpi-value">{{ user_points }}</span>
              <span class="kpi-unit">pts</span>
            {% else %}
              <span class="kpi-value kpi-value--small">Progressi in corso</span>
            {% endif %}
          </div>
        </div>

        <!-- KPI 3: Badge -->
        <div class="gamification-kpi-card">
          <span class="kpi-label">Badge sbloccati</span>
          <div class="kpi-value-row">
            <span class="kpi-value">{{ badge_count }}</span>
            <span class="kpi-unit">/ {{ total_badges }}</span>
          </div>
          {% if badges_missing > 0 %}
            <span class="gamification-badge-missing">{{ badges_missing }} da sbloccare</span>
          {% else %}
            <span class="gamification-badge-complete">Tutti sbloccati!</span>
          {% endif %}
        </div>
      </div>

      <!-- Progress Bar Section -->
      <div class="gamification-progress-section">
        <div class="gamification-progress-bar-wrapper">
          <div class="gamification-progress-bar" role="progressbar" aria-valuenow="{{ level_progress|round(0, 'floor')|int }}" aria-valuemin="0" aria-valuemax="100">
            <div class="gamification-progress-fill" style="width: {{ level_progress }}%"></div>
          </div>
          <span class="gamification-progress-label">{{ level_progress|round(0, 'floor')|int }}%</span>
        </div>
        <p class="gamification-hint">{{ next_level_hint }}</p>
      </div>
    </section>

    <section class="dashboard-actions" aria-label="Azioni e impostazioni">
      <header class="card-header">
        <h2>Azioni / Impostazioni</h2>
        <p class="muted">Sezioni compatte da aprire solo quando servono.</p>
      </header>

      <div class="accordion">
        <details class="accordion-item" id="account-section">
          <summary><span class="accordion-title">Account</span></summary>
          <div class="accordion-body">
            {% if user.has_premium_access %}
              <span class="badge premium">üü¢ Premium attivo</span>
              <p class="muted">Accesso completo: soglia personalizzata, log eventi, alert illimitati.</p>
            {% else %}
              <span class="badge free">‚ö™ Free</span>
              <p class="muted">Grafico realtime + 1 alert di prova.</p>
            {% endif %}
            <p class="account-email">{{ user.email }}</p>
            {% if not user.has_premium_access %}
              <a class="btn btn-premium btn-sm" href="{{ url_for('billing.donate') }}">Attiva Premium (PayPal)</a>
              <p class="helper-text">Donazione PayPal (min. ‚Ç¨9,99) ¬∑ Inserisci email di registrazione</p>
              <p class="helper-text">PayPal: salvoferro16@gmail.com</p>
            {% endif %}
            <div class="account-actions">
              <a class="btn btn-secondary btn-sm" href="{{ url_for('dashboard.settings') }}">Impostazioni account</a>
              <a class="btn btn-ghost btn-sm" href="{{ url_for('main.logout') }}">Logout</a>
            </div>
          </div>
        </details>

        <details class="accordion-item" id="alert-settings">
          <summary><span class="accordion-title">Telegram</span></summary>
          <div class="accordion-body">
            {% if telegram_connected %}
              <span class="telegram-badge telegram-badge--connected">Connesso</span>
              <p class="muted">Chat ID: {{ user.telegram_chat_id or user.chat_id }}</p>
              <form method="POST" action="{{ url_for('dashboard.disconnect_telegram') }}">
                <button type="submit" class="btn btn-secondary btn-sm">Disconnetti</button>
              </form>
              <a class="btn btn-ghost btn-sm" href="https://t.me/etna_turi_bot" target="_blank" rel="noopener">Apri bot</a>
            {% else %}
              <span class="telegram-badge telegram-badge--disconnected">Non collegato</span>
              <p class="muted">Collega il bot per ricevere notifiche Telegram.</p>
              <form method="POST" action="{{ url_for('dashboard.generate_telegram_link') }}" class="telegram-form" target="_blank">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-secondary btn-sm">Collega Telegram</button>
              </form>
            {% endif %}
          </div>
        </details>

        <details class="accordion-item" id="threshold-settings">
          <summary><span class="accordion-title">Soglia</span></summary>
          <div class="accordion-body">
            {% if user.has_premium_access %}
              <div class="threshold-controls">
                <label for="threshold-slider">Soglia personalizzata</label>
                <div class="slider-container">
                  <input type="range" id="threshold-slider" min="0.1" max="10" step="0.1" value="{{ '%.2f'|format(active_threshold) }}" aria-label="Cursore soglia" aria-describedby="threshold-help">
                  <input type="number" id="threshold-input" min="0.1" max="10" step="0.1" value="{{ '%.2f'|format(active_threshold) }}" aria-label="Valore soglia" aria-describedby="threshold-help">
                </div>
                <p id="threshold-help" class="help-text">Imposta una soglia tra 0.1 e 10 mV.</p>
                <button id="save-threshold" class="btn btn-premium btn-sm">Salva</button>
              </div>
            {% else %}
              <p class="muted">Soglia fissa: {{ "%.2f"|format(active_threshold) }} mV.</p>
              <p class="muted">Sblocca la soglia personalizzata con Premium.</p>
              <a class="btn btn-premium btn-sm" href="{{ url_for('billing.donate') }}">Passa a Premium</a>
            {% endif %}
          </div>
        </details>

        <details class="accordion-item" id="recent-events">
          <summary><span class="accordion-title">Log eventi</span></summary>
          <div class="accordion-body">
            {% if user.has_premium_access %}
              {% if recent_events %}
              <ul class="events-list" id="events-list">
                {% for event in recent_events %}
                  <li>
                    <div class="event-meta">
                      <span class="event-date">{{ event.timestamp.strftime('%d/%m %H:%M') }}</span>
                      <span class="event-type">{{ event.event_type.replace('_', ' ').title() }}</span>
                    </div>
                    <div class="event-body">
                      <span class="event-value">
                        {% if event.value %}
                          {{ "%.2f"|format(event.value) }} mV
                        {% else %}
                          ‚Äî
                        {% endif %}
                      </span>
                      <span class="event-message">{{ event.message }}</span>
                    </div>
                  </li>
                {% endfor %}
              </ul>
              {% else %}
                <p class="muted">Nessun evento significativo nelle ultime 24 ore.</p>
              {% endif %}
            {% else %}
              <p class="muted">Disponibile solo per utenti Premium.</p>
              <a class="btn btn-premium btn-sm" href="{{ url_for('billing.donate') }}">Attiva Premium</a>
            {% endif %}
          </div>
        </details>

        <details class="accordion-item" id="account-settings">
          <summary><span class="accordion-title">Impostazioni account</span></summary>
          <div class="accordion-body">
            <p class="muted">Email registrata: {{ user.email }}</p>
            <a class="btn btn-secondary btn-sm" href="{{ url_for('dashboard.settings') }}">Gestisci email / password</a>
          </div>
        </details>

        <details class="accordion-item" id="prediction-game">
          <summary>
            <span class="accordion-title">Prediction Game</span>
            <span class="accordion-meta">Gioca</span>
          </summary>
          <div class="accordion-body prediction-card">
            <p class="muted">Prevedi l‚Äôandamento del tremore tra 24 ore e accumula punti.</p>
            {% if active_prediction %}
              <div class="prediction-status">
                <span class="prediction-badge prediction-badge--active">Previsione attiva</span>
                <p class="prediction-choice">Hai scelto: <strong>{{ active_prediction.prediction }}</strong></p>
                <p class="muted">
                  Si risolve automaticamente il
                  <span data-prediction-resolves="{{ active_prediction.resolves_at.isoformat() }}">
                    {{ active_prediction.resolves_at.strftime('%d/%m/%Y %H:%M') }}
                  </span>.
                </p>
                <p class="prediction-countdown" data-prediction-countdown data-resolves-at="{{ active_prediction.resolves_at.isoformat() }}">
                  Countdown in arrivo‚Ä¶
                </p>
                <p class="muted">Sar√† valutata automaticamente con i dati INGV.</p>
              </div>
            {% else %}
              <form class="prediction-form" data-prediction-form>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="prediction" value="">
                <div class="prediction-actions" role="group" aria-label="Scegli previsione">
                  <button type="button" class="btn btn-secondary btn-sm" data-prediction-choice="UP">UP</button>
                  <button type="button" class="btn btn-secondary btn-sm" data-prediction-choice="FLAT">FLAT</button>
                  <button type="button" class="btn btn-secondary btn-sm" data-prediction-choice="DOWN">DOWN</button>
                </div>
                <p class="muted prediction-helper">Una sola previsione attiva alla volta.</p>
                <p class="prediction-feedback" data-prediction-feedback role="status" aria-live="polite"></p>
              </form>
            {% endif %}
            <a class="btn btn-ghost btn-sm prediction-link" href="{{ url_for('predictions.leaderboard_page') }}">
              Vai alla classifica
            </a>
          </div>
        </details>

        {% if missions_enabled %}
        <details class="accordion-item" id="missions-section">
          <summary>
            <span class="accordion-title">üéØ Missioni attive</span>
            <span class="accordion-meta">
              {% if user_missions %}
                {% set active_count = user_missions | selectattr('is_active') | list | length %}
                {{ active_count }} attive
              {% else %}
                0 attive
              {% endif %}
            </span>
          </summary>
          <div class="accordion-body missions-card">
            <p class="muted">Completa missioni giornaliere e settimanali per guadagnare punti e salire di livello.</p>
            {% if user_missions %}
              <ul class="missions-list">
                {% for mission in user_missions %}
                  <li class="mission-item {% if mission.is_completed %}mission-item--completed{% elif mission.is_expired %}mission-item--expired{% else %}mission-item--active{% endif %}">
                    <div class="mission-header">
                      <span class="mission-icon" aria-hidden="true">{{ mission.icon }}</span>
                      <div class="mission-info">
                        <strong class="mission-label">{{ mission.label }}</strong>
                        <p class="mission-description muted">{{ mission.description }}</p>
                        {% if mission.hint %}
                          <p class="mission-hint muted">{{ mission.hint }}</p>
                        {% endif %}
                      </div>
                      <span class="mission-points">+{{ mission.points }} pts</span>
                    </div>
                    <div class="mission-progress">
                      <div class="mission-progress-bar">
                        {% set progress_pct = (mission.progress.current / mission.progress.total * 100) | round(0, 'floor') %}
                        <span class="mission-progress-fill" style="width: {{ progress_pct }}%"></span>
                      </div>
                      <span class="mission-progress-text">
                        {% if mission.progress_label %}
                          {{ mission.progress_label }}
                        {% else %}
                          {{ mission.progress.current }}/{{ mission.progress.total }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="mission-status">
                      {% if mission.is_completed %}
                        <span class="mission-badge mission-badge--completed">‚úì Completata</span>
                        {% if mission.auto_claim %}
                          <span class="mission-expires muted">Ricompensa assegnata automaticamente</span>
                        {% elif mission.is_claimed %}
                          <span class="mission-expires muted">Ricompensa gi√† riscattata</span>
                        {% else %}
                          <button 
                            class="btn btn-premium btn-sm mission-claim-btn" 
                            data-mission-id="{{ mission.id }}"
                            data-mission-claim
                          >
                            Riscatta +{{ mission.points }} pts
                          </button>
                        {% endif %}
                      {% elif mission.is_expired %}
                        <span class="mission-badge mission-badge--expired">Scaduta</span>
                      {% else %}
                        <span class="mission-badge mission-badge--active">In corso</span>
                        <span class="mission-expires muted">Scade: {{ mission.expires_at[:10] }}</span>
                      {% endif %}
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="missions-empty">
                <p class="missions-cta-title">üî• Nessuna missione attiva</p>
                <p class="muted">Fai una previsione oggi per sbloccare la prima missione!</p>
                <button 
                  class="btn btn-premium btn-sm missions-cta-btn" 
                  onclick="document.getElementById('prediction-game').scrollIntoView({behavior: 'smooth'}); document.getElementById('prediction-game').open = true;"
                >
                  Gioca ora
                </button>
              </div>
            {% endif %}
          </div>
        </details>
        {% endif %}

        <details class="accordion-item" id="badge-levels">
          <summary>
            <span class="accordion-title">üèÜ Badge & Trofei</span>
            <span class="accordion-meta">{{ badge_count }}/{{ total_badges }}</span>
          </summary>
          <div class="accordion-body badge-summary-card">
            <p class="muted">Sblocca badge completando missioni, facendo previsioni e monitorando l'Etna.</p>
            
            {% if user_badges %}
              <div class="badges-section">
                <h3 class="badges-section-title">Badge sbloccati</h3>
                <div class="badge-grid">
                  {% for badge in user_badges %}
                    <div class="badge-grid-item badge-grid-item--unlocked">
                      <span class="badge-grid-icon" aria-hidden="true">{{ badge.icon }}</span>
                      <strong class="badge-grid-label">{{ badge.label }}</strong>
                      <p class="badge-grid-description muted">{{ badge.description }}</p>
                      {% if badge.earned_at %}
                        <span class="badge-grid-date">{{ badge.earned_at.strftime('%d/%m/%Y') }}</span>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            {% if badges_missing > 0 %}
              <div class="badges-section badges-section--locked">
                <h3 class="badges-section-title">Prossimi badge</h3>
                <div class="badge-grid badge-grid--locked">
                  {% set unlocked_codes = user_badges | map(attribute='code') | list %}
                  {% if 'WATCHER_7D' not in unlocked_codes %}
                    <div class="badge-grid-item badge-grid-item--locked">
                      <span class="badge-grid-icon badge-grid-icon--locked" aria-hidden="true">üîí</span>
                      <strong class="badge-grid-label">Watcher 7 giorni</strong>
                      <p class="badge-grid-description muted">Accedi per 7 giorni consecutivi</p>
                      {% set watcher_7 = watcher_progress.get('WATCHER_7D') %}
                      {% if watcher_7 %}
                        {% set remaining_7 = watcher_7.total - watcher_7.current %}
                        <div class="badge-progress">
                          <div class="mission-progress-bar">
                            {% set progress_pct = (watcher_7.current / watcher_7.total * 100) | round(0, 'floor') %}
                            <span class="mission-progress-fill" style="width: {{ progress_pct }}%"></span>
                          </div>
                          <span class="badge-progress-text muted">
                            {{ watcher_7.current }}/{{ watcher_7.total }} giorni ¬∑ Mancano {{ remaining_7 }} giorni
                          </span>
                        </div>
                      {% endif %}
                    </div>
                  {% endif %}
                  {% if 'WATCHER_30D' not in unlocked_codes %}
                    <div class="badge-grid-item badge-grid-item--locked">
                      <span class="badge-grid-icon badge-grid-icon--locked" aria-hidden="true">üîí</span>
                      <strong class="badge-grid-label">Watcher 30 giorni</strong>
                      <p class="badge-grid-description muted">Accedi per 30 giorni consecutivi</p>
                      {% set watcher_30 = watcher_progress.get('WATCHER_30D') %}
                      {% if watcher_30 %}
                        {% set remaining_30 = watcher_30.total - watcher_30.current %}
                        <div class="badge-progress">
                          <div class="mission-progress-bar">
                            {% set progress_pct = (watcher_30.current / watcher_30.total * 100) | round(0, 'floor') %}
                            <span class="mission-progress-fill" style="width: {{ progress_pct }}%"></span>
                          </div>
                          <span class="badge-progress-text muted">
                            {{ watcher_30.current }}/{{ watcher_30.total }} giorni ¬∑ Mancano {{ remaining_30 }} giorni
                          </span>
                        </div>
                      {% endif %}
                    </div>
                  {% endif %}
                  {% if 'PREMIUM_SUPPORTER' not in unlocked_codes %}
                    <div class="badge-grid-item badge-grid-item--locked">
                      <span class="badge-grid-icon badge-grid-icon--locked" aria-hidden="true">üîí</span>
                      <strong class="badge-grid-label">Premium supporter</strong>
                      <p class="badge-grid-description muted">Attiva un piano Premium</p>
                    </div>
                  {% endif %}
                  {% if 'ALERT_TRIGGERED' not in unlocked_codes %}
                    <div class="badge-grid-item badge-grid-item--locked">
                      <span class="badge-grid-icon badge-grid-icon--locked" aria-hidden="true">üîí</span>
                      <strong class="badge-grid-label">Alert attivato</strong>
                      <p class="badge-grid-description muted">Ricevi almeno un alert</p>
                    </div>
                  {% endif %}
                  {% if 'MISSION_COMPLETE' not in unlocked_codes %}
                    <div class="badge-grid-item badge-grid-item--locked">
                      <span class="badge-grid-icon badge-grid-icon--locked" aria-hidden="true">üîí</span>
                      <strong class="badge-grid-label">Completista</strong>
                      <p class="badge-grid-description muted">Completa almeno 5 missioni</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if not user_badges and badges_missing == total_badges %}
              <div class="badge-empty">
                <p class="muted">Inizia a monitorare per sbloccare i badge.</p>
              </div>
            {% endif %}
          </div>
        </details>

        <!-- TASK 4: CTA Loop for Retention -->
        <div class="gamification-cta-loop card">
          <div class="cta-loop-header">
            <span class="cta-loop-icon">üìå</span>
            <h3 class="cta-loop-title">Suggerimento di oggi</h3>
          </div>
          <div class="cta-loop-content">
            {% if not active_prediction %}
              <p class="cta-loop-message">üéØ Gioca ora e guadagna punti facendo una previsione!</p>
              <button 
                class="btn btn-premium btn-sm cta-loop-btn" 
                onclick="document.getElementById('prediction-game').scrollIntoView({behavior: 'smooth'}); document.getElementById('prediction-game').open = true;"
              >
                Vai al Prediction Game
              </button>
            {% else %}
              <p class="cta-loop-message">‚è≥ Hai una previsione attiva. Torna quando si risolve per vedere l'esito!</p>
            {% endif %}
            
            {% if missions_enabled and not user_missions %}
              <p class="cta-loop-message">üî• Nessuna missione attiva? Fai una previsione per attivarle!</p>
            {% endif %}
          </div>
        </div>
      </div>
    </section>
  </section>
</div>

<div
  id="tremor-focus-modal"
  class="chart-focus-modal"
  role="dialog"
  aria-label="Modalit√† focus grafico tremore"
  aria-hidden="true"
>
  <div class="chart-focus-backdrop" data-focus-close></div>
  <div class="chart-focus-panel" role="document">
    <header class="chart-focus-header">
      <div>
        <span class="chart-focus-title">Tremore vulcanico</span>
        <span class="chart-focus-subtitle">Modalit√† Focus</span>
      </div>
      <div class="chart-focus-actions">
        <button type="button" class="btn btn-ghost btn-sm" id="focus-reset-view">Reset vista</button>
        <button type="button" class="btn btn-secondary btn-sm" id="focus-close">Chiudi</button>
      </div>
    </header>
    <div id="tremor-plot-focus" class="chart-focus-plot" role="img" aria-label="Grafico tremore in modalit√† focus"></div>
  </div>
</div>

<div id="toast-container" class="toast-container"></div>

<script src="{{ url_for('static', filename='vendor/plotly.min.js') }}" nonce="{{ csp_nonce() }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}?v={{ STATIC_ASSET_VERSION }}" nonce="{{ csp_nonce() }}"></script>
<script src="{{ url_for('static', filename='js/prediction_game.js') }}?v={{ STATIC_ASSET_VERSION }}" nonce="{{ csp_nonce() }}"></script>
{% endblock %}
