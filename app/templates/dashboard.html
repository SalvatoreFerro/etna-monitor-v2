{% extends "layout.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-fixes.css') }}">
<meta name="theme-color" content="#007aff">
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="dashboard-header">
    <div class="user-info">
      <h1>Dashboard</h1>
      <div class="user-badge">
        <span class="badge {{ 'premium' if user.premium else 'free' }}">
          {{ 'Premium ⭐' if user.premium else 'Free' }}
        </span>
      </div>
    </div>
    
    <div class="dashboard-controls">
      <button id="theme-toggle" class="btn btn-secondary" aria-label="Toggle between light and dark theme" tabindex="0">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="5"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
      </button>
      
      <div class="ingv-mode-toggle">
        <label class="toggle-switch" for="ingv-mode">
          <input type="checkbox" id="ingv-mode" aria-describedby="ingv-mode-desc" />
          <span class="toggle-slider" aria-hidden="true"></span>
        </label>
        <span class="toggle-label" id="ingv-mode-desc">INGV Mode</span>
      </div>
    </div>
  </div>

  <div class="chart-section card-premium animate-premium-fade">
    <div class="chart-header">
      <h2>Volcanic Tremor Monitoring</h2>
      <div class="chart-info">
        <span id="last-updated">Last updated: --</span>
        <span id="data-points">-- points</span>
      </div>
    </div>
    
    <div class="chart-controls">
      {% if user.premium %}
      <button id="update-btn" class="btn btn-premium">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
        </svg>
        Update Now
      </button>
      {% endif %}
      
      <div class="time-range-selector">
        <label for="time-range" class="sr-only">Select time range for chart</label>
        <select id="time-range" class="input-base" aria-label="Time range selector">
          <option value="24h">Last 24 hours</option>
          <option value="3d">Last 3 days</option>
          <option value="7d" selected>Last 7 days</option>
          <option value="all">All data</option>
        </select>
      </div>
      
      {% if user.premium %}
      <div class="export-controls" role="group" aria-label="Export options">
        <button id="export-csv" class="btn btn-secondary btn-sm glass" aria-label="Export data as CSV file">CSV</button>
        <button id="export-png" class="btn btn-secondary btn-sm glass" aria-label="Export chart as PNG image">PNG</button>
      </div>
      {% endif %}
    </div>
    
    <div id="tremor-plot" class="chart-container" role="img" aria-label="Volcanic tremor data chart"></div>
    
    <div class="chart-legend">
      <div class="legend-item">
        <span class="legend-color" style="background: #4ade80;"></span>
        <span>Tremor Signal</span>
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background: #ef4444;"></span>
        <span>Threshold</span>
      </div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="status-card card-premium animate-premium-slide">
      <h3>Current Status</h3>
      <div class="status-display">
        <div class="current-value">
          <span id="current-value">--</span>
          <span class="unit">mV</span>
        </div>
        <div class="status-indicator" id="status-indicator">
          <span id="status-text">--</span>
        </div>
      </div>
    </div>

    <div class="threshold-card card-premium animate-premium-slide">
      <h3>Threshold Settings</h3>
      {% if user.premium %}
      <div class="threshold-controls">
        <label for="threshold-slider">Custom Threshold</label>
        <div class="slider-container">
          <input type="range" id="threshold-slider" min="0.1" max="10" step="0.1" value="{{ user.threshold or 2.0 }}" aria-label="Threshold slider" aria-describedby="threshold-help">
          <input type="number" id="threshold-input" min="0.1" max="10" step="0.1" value="{{ user.threshold or 2.0 }}" aria-label="Threshold value input" aria-describedby="threshold-help">
          <div id="threshold-help" class="sr-only">Set custom threshold between 0.1 and 10 mV for alerts</div>
        </div>
        <button id="save-threshold" class="btn btn-premium btn-sm">Save</button>
      </div>
      {% else %}
      <div class="upgrade-prompt">
        <p>Fixed threshold: {{ user.threshold or 2.0 }} mV</p>
        <a href="/pricing" class="btn btn-premium btn-sm">Upgrade for Custom Thresholds</a>
      </div>
      {% endif %}
    </div>

    <div class="refresh-card card-premium animate-premium-slide">
      <h3>Auto-refresh</h3>
      <div class="refresh-controls">
        <label for="auto-refresh" class="sr-only">Auto-refresh interval</label>
        <select id="auto-refresh" aria-label="Auto-refresh interval selector">
          <option value="0">Off</option>
          <option value="180000">3 minutes</option>
          <option value="300000" selected>5 minutes</option>
          <option value="600000">10 minutes</option>
          <option value="1800000">30 minutes</option>
        </select>
        <div class="refresh-status">
          <span id="refresh-countdown">--</span>
        </div>
      </div>
    </div>
  </div>

  {% if user.premium %}
  <div class="premium-section">
    <div class="alerts-card card-premium animate-premium-fade">
      <h3>Alert Settings</h3>
      <div class="alert-controls">
        <label class="checkbox-label">
          <input type="checkbox" id="email-alerts" {% if user.email_alerts %}checked{% endif %} 
                 onchange="toggleAlert('email', this.checked)">
          <span>Email notifications</span>
        </label>
        
        <div class="telegram-section">
          <h4>Telegram Notifications</h4>
          {% if user.chat_id %}
            <div class="telegram-connected">
              <span class="status-indicator connected">✓ Connected</span>
              <p>Chat ID: {{ user.chat_id }}</p>
              <form method="POST" action="{{ url_for('dashboard.disconnect_telegram') }}" style="display: inline;">
                <button type="submit" class="btn btn-secondary btn-sm">Disconnect</button>
              </form>
            </div>
          {% else %}
            <div class="telegram-setup">
              <p>Connect your Telegram account to receive instant alerts:</p>
              <ol>
                <li>Start a chat with <a href="https://t.me/etna_turi_bot" target="_blank">@etna_turi_bot</a></li>
                <li>Send the command <code>/start</code></li>
                <li>Copy your Chat ID and paste it below</li>
              </ol>
              <form method="POST" action="{{ url_for('dashboard.connect_telegram') }}">
                <div class="form-group">
                  <label for="chat_id">Telegram Chat ID:</label>
                  <input type="text" id="chat_id" name="chat_id" class="input-base" 
                         placeholder="e.g., 123456789" required>
                </div>
                <button type="submit" class="btn btn-premium">Connect Telegram</button>
              </form>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="events-card card-premium animate-premium-fade">
      <h3>Recent Events</h3>
      <div class="events-list" id="events-list">
         {% for event in recent_events %}
           <div class="event-item">
             <span class="event-time">{{ event.timestamp.strftime('%d/%m %H:%M') }}</span>
             <span class="event-type">{{ event.event_type.replace('_', ' ').title() }}</span>
             {% if event.value %}
               <span class="event-value">{{ "%.2f"|format(event.value) }} mV</span>
             {% endif %}
           </div>
         {% else %}
           <p class="no-events">Nessun evento sismico significativo nelle ultime 24 ore</p>
         {% endfor %}
      </div>
    </div>
  </div>
  {% else %}
  <div class="upgrade-section">
    <div class="upgrade-card card-premium">
      <h3>Upgrade to Premium</h3>
      <p>Get access to Telegram notifications, custom thresholds, and event history.</p>
      <a href="/pricing" class="btn btn-premium">Upgrade Now</a>
    </div>
  </div>
  {% endif %}
</div>

<div id="loading-overlay" class="loading-overlay" style="display: none;">
  <div class="loading-spinner"></div>
  <p>Caricamento dati da INGV, attendere...</p>
</div>

<div id="toast-container" class="toast-container"></div>

<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
