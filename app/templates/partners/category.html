{% extends 'layout.html' %}

{% block title %}{{ category.name }} â€“ Directory partner EtnaMonitor{% endblock %}

{% block content %}
<section class="page page--partner-category" aria-labelledby="partner-category-title">
  <header class="partner-category__hero">
    <div class="container">
      <p class="partner-category__eyebrow">Directory partner</p>
      <h1 id="partner-category-title">{{ category.name }}</h1>
      {% if category.description %}
        <p class="partner-category__subtitle">{{ category.description }}</p>
      {% else %}
        <p class="partner-category__subtitle">Selezione curata dei partner EtnaMonitor con attivazione entro 24 h dal pagamento.</p>
      {% endif %}
      <dl class="partner-category__stats">
        <div>
          <dt>Slot occupati</dt>
          <dd>{{ partners|length }}/{{ category.max_slots }}</dd>
        </div>
        <div>
          <dt>Ultimo aggiornamento</dt>
          <dd>
            {% if partners and partners[0].approved_at %}
              {{ partners[0].approved_at.strftime('%d %B %Y') }}
            {% else %}
              N/D
            {% endif %}
          </dd>
        </div>
      </dl>
    </div>
  </header>

  <div class="container partner-category__body">
    {% if is_full %}
      <aside class="partner-category__banner" role="status">
        <strong>ðŸŸ¡ Categoria completa ({{ category.max_slots }}/{{ category.max_slots }}).</strong>
        <span>Lascia il contatto per la lista d'attesa e ti avvisiamo appena si libera uno slot.</span>
      </aside>
    {% endif %}

    <div class="partner-category__grid">
      {% for partner in partners %}
        <article class="partner-card" data-animate>
          <div class="partner-card__media" aria-hidden="true">
            {% if partner.logo_path %}
              <img
                src="{{ url_for('static', filename=partner.logo_path) }}"
                alt="Logo {{ partner.name }}"
                loading="lazy"
                decoding="async"
              />
            {% else %}
              <span>{{ partner.name[:1] }}</span>
            {% endif %}
          </div>

          <div class="partner-card__body">
            <h2 class="partner-card__title">
              {% if partner.featured %}<span class="partner-card__badge">Featured</span>{% endif %}
              <a href="{{ url_for('partners.partner_detail', slug=partner.category.slug, partner_slug=partner.slug) }}">{{ partner.name }}</a>
            </h2>
            <div class="partner-card__meta">
              {% if partner.city %}
                <span><i class="fas fa-map-marker-alt" aria-hidden="true"></i> {{ partner.city }}</span>
              {% endif %}
              <span><i class="fas fa-award" aria-hidden="true"></i> {{ category.name }}</span>
            </div>
            {% set description = partner.short_desc or partner.long_desc or '' %}
            <p class="partner-card__desc">{{ description|truncate(160) }}</p>
            <div class="partner-card__actions">
              <a class="btn btn-primary btn-sm" href="{{ url_for('partners.partner_detail', slug=partner.category.slug, partner_slug=partner.slug) }}">Dettagli</a>
              {% if contact_actions[partner.id] %}
                <div class="partner-card__quick">
                  {% for action in contact_actions[partner.id][:2] %}
                    <a class="btn btn-ghost btn-sm" href="{{ action.href }}">{{ action.label }}</a>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </article>
      {% else %}
        <p class="partner-category__empty">Nessun partner attivo in questa categoria al momento.</p>
      {% endfor %}
    </div>

    {% if waitlist_enabled %}
      <section class="partner-waitlist" aria-labelledby="partner-waitlist-title">
        <h2 id="partner-waitlist-title">Unisciti alla lista d'attesa</h2>
        <form method="post" action="{{ url_for('partners.join_waitlist', slug=category.slug) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <div class="form-grid">
            <label>
              <span>Nome e cognome *</span>
              <input type="text" name="name" required maxlength="180" />
            </label>
            <label>
              <span>Email *</span>
              <input type="email" name="email" required maxlength="255" />
            </label>
            <label>
              <span>Telefono</span>
              <input type="text" name="phone" maxlength="64" />
            </label>
          </div>
          <label class="partner-waitlist__notes">
            <span>Note</span>
            <textarea name="notes" rows="3"></textarea>
          </label>
          <button type="submit" class="btn btn-primary">Inviami aggiornamenti</button>
        </form>
      </section>
    {% endif %}
  </div>
</section>

{% if structured_data %}
  <script type="application/ld+json">{{ structured_data|tojson }}</script>
{% endif %}
{% endblock %}
