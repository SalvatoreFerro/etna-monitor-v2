{% extends "layout.html" %}

{% block content %}
  <section class="container ga4-diagnostics" aria-labelledby="ga4-diagnostics-title">
    <div class="content">
      <h1 id="ga4-diagnostics-title">GA4 Diagnostics</h1>
      <p id="ga4-gtag-status" role="status">Verifica stato gtag…</p>
      <p id="ga4-datalayer-length">DataLayer length: (in caricamento…)</p>
      <p>
        <a href="{{ url_for('main.index') }}?dbg=1" class="btn btn-primary">Apri home con debug</a>
      </p>
    </div>
  </section>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script nonce="{{ csp_nonce() }}">
    (function () {
      const statusEl = document.getElementById('ga4-gtag-status');
      const dlLengthEl = document.getElementById('ga4-datalayer-length');

      const gtagAvailable = typeof window.gtag === 'function';
      if (statusEl) {
        statusEl.textContent = gtagAvailable
          ? '✅ window.gtag è definito'
          : '⚠️ window.gtag non è definito';
      }

      const dataLayerLength = Array.isArray(window.dataLayer)
        ? window.dataLayer.length
        : 'n/a';
      if (dlLengthEl) {
        dlLengthEl.textContent = `DataLayer length: ${dataLayerLength}`;
      }
    })();
  </script>
{% endblock %}
