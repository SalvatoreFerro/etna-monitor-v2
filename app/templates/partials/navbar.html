{% set current_destination = request.full_path.rstrip('?') if request.query_string else request.path %}
{% set community_links = [
  {'label': 'Blog', 'url': url_for('community.blog_index'), 'endpoint': 'community.blog_index'},
  {'label': 'Forum', 'url': url_for('community.forum_home'), 'endpoint': 'community.forum_home'},
  {'label': 'Feedback', 'url': url_for('community.feedback_portal'), 'endpoint': 'community.feedback_portal'},
] %}
{% set nav_links = [
  {'label': 'Etna 3D', 'url': url_for('main.etna3d'), 'endpoint': 'main.etna3d'},
  {'label': 'Webcam Etna', 'url': url_for('main.webcam_etna'), 'endpoint': 'main.webcam_etna'},
  {'label': 'Community', 'children': community_links},
] %}

{% if config.PARTNER_DIRECTORY_ENABLED %}
  {% set experience_children = [
    {'label': 'Guide autorizzate', 'url': url_for('category.category_view', slug='guide'), 'endpoint': 'category.category_view', 'slug': 'guide'},
    {'label': 'Hotel', 'url': url_for('category.category_view', slug='hotel'), 'endpoint': 'category.category_view', 'slug': 'hotel'},
    {'label': 'Ristoranti', 'url': url_for('category.category_view', slug='ristoranti'), 'endpoint': 'category.category_view', 'slug': 'ristoranti'}
  ] %}
  {% set nav_links = [{'label': 'Etna Experience', 'children': experience_children}] + nav_links %}
{% endif %}

{% if not session.user_id %}
  {% set nav_links = nav_links + [
    {
      'label': 'Accedi con Google',
      'url': url_for('auth.auth_google', next=current_destination),
      'endpoint': 'auth.auth_google',
      'extra_class': 'site-nav__link--mobile-only site-nav__link--cta',
      'icon_src': url_for('static', filename='images/google-g.svg')
    }
  ] %}
{% else %}
  {% set nav_links = nav_links + [
    {
      'label': 'Dashboard',
      'url': url_for('dashboard.dashboard_home'),
      'endpoint': 'dashboard.dashboard_home',
      'extra_class': 'site-nav__link--mobile-only'
    },
    {
      'label': 'Esci',
      'url': url_for('auth.logout'),
      'endpoint': 'auth.logout',
      'extra_class': 'site-nav__link--mobile-only site-nav__link--danger',
      'icon': 'fa-solid fa-right-from-bracket'
    }
  ] %}
{% endif %}

{% set ordered_links = nav_links %}
{% set secondary_links = [] %}

<nav class="site-nav" role="navigation" aria-label="Navigazione principale">
  <div class="container site-nav__inner">
    <a class="site-nav__brand" href="/" aria-label="EtnaMonitor home">
      <span class="site-nav__mark" aria-hidden="true">EM</span>
      <span class="site-nav__wordmark">EtnaMonitor</span>
    </a>

    <button
      class="site-nav__toggle"
      type="button"
      aria-label="Apri il menu di navigazione"
      aria-controls="primary-navigation"
      aria-expanded="false"
      data-site-nav-toggle
    >
      <span class="site-nav__toggle-lines" aria-hidden="true"></span>
    </button>

    <noscript>
      <style>
        .site-nav__toggle {
          display: none !important;
        }

        .site-nav__menu[hidden][data-site-nav-menu] {
          display: grid !important;
          position: static !important;
          padding: var(--space-4) !important;
          background: rgba(8, 13, 32, 0.98) !important;
          border: 1px solid rgba(100, 116, 139, 0.25) !important;
          border-radius: var(--radius-xl) !important;
          box-shadow: var(--shadow-lg) !important;
        }

        @media (min-width: 1024px) {
          .site-nav__menu[hidden][data-site-nav-menu] {
            display: flex !important;
            padding: 0 !important;
            background: transparent !important;
            border: 0 !important;
            box-shadow: none !important;
          }
        }
      </style>
    </noscript>

    <div class="site-nav__menu is-open" id="primary-navigation" data-site-nav-menu aria-hidden="false">
      <div class="site-nav__links-wrapper">
        <ul class="site-nav__links">
          {% for link in ordered_links %}
            {% set priority = link.get('priority') %}
            <li class="site-nav__item{{ ' site-nav__item--has-children' if link.children }}{{ ' site-nav__item--secondary' if priority == 'secondary' }}">
              {% if link.children %}
                <details class="site-nav__dropdown" data-site-nav-dropdown>
                  <summary class="site-nav__link {{ link.extra_class or '' }}">
                    <span class="site-nav__link-label">{{ link.label }}</span>
                    <i class="fas fa-chevron-down" aria-hidden="true"></i>
                  </summary>
                  <ul class="site-nav__submenu" role="menu">
                    {% for child in link.children %}
                      {% set is_child_active = request.endpoint == child.endpoint and (child.slug is not defined or request.view_args.get('slug') == child.slug) %}
                      <li>
                        <a role="menuitem" class="site-nav__sublink {{ 'is-active' if is_child_active }}" href="{{ child.url }}">{{ child.label }}</a>
                      </li>
                    {% endfor %}
                  </ul>
                </details>
            {% else %}
              <a class="site-nav__link {{ link.extra_class or '' }} {{ 'is-active' if request.endpoint == link.endpoint }}" href="{{ link.url }}">
                {% if link.icon_src %}
                  <span class="site-nav__link-icon" aria-hidden="true"><img src="{{ link.icon_src }}" alt="" loading="lazy" decoding="async" /></span>
                {% elif link.icon %}
                  <span class="site-nav__link-icon" aria-hidden="true"><i class="{{ link.icon }}"></i></span>
                {% endif %}
                <span class="site-nav__link-label">{{ link.label }}</span>
              </a>
              {% endif %}
            </li>
          {% endfor %}
          {% if secondary_links %}
            <li class="site-nav__item site-nav__item--overflow">
              <details class="site-nav__dropdown" data-site-nav-dropdown>
                <summary class="site-nav__link">
                  <span class="site-nav__link-label">Altri</span>
                  <i class="fas fa-chevron-down" aria-hidden="true"></i>
                </summary>
                <ul class="site-nav__submenu" role="menu">
                  {% for link in secondary_links %}
                    <li>
                      {% if link.children %}
                        <details class="site-nav__submenu-dropdown">
                          <summary class="site-nav__sublink">
                            <span>{{ link.label }}</span>
                            <i class="fas fa-chevron-down" aria-hidden="true"></i>
                          </summary>
                          <ul class="site-nav__submenu-list" role="group">
                            {% for child in link.children %}
                              {% set is_child_active = request.endpoint == child.endpoint and (child.slug is not defined or request.view_args.get('slug') == child.slug) %}
                              <li>
                                <a role="menuitem" class="site-nav__sublink {{ 'is-active' if is_child_active }}" href="{{ child.url }}">{{ child.label }}</a>
                              </li>
                            {% endfor %}
                          </ul>
                        </details>
                      {% else %}
                        <a role="menuitem" class="site-nav__sublink {{ 'is-active' if request.endpoint == link.endpoint }}" href="{{ link.url }}">{{ link.label }}</a>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </details>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>

    <div class="site-nav__actions">
      {% if session.user_id %}
        {% set display_name = (current_user.name if current_user else None) or (current_user.email if current_user else None) or 'Utente' %}
        <a class="btn btn-secondary btn-sm" href="{{ url_for('dashboard.dashboard_home') }}">Dashboard</a>
        <a class="btn btn-primary btn-sm" href="{{ url_for('auth.logout') }}">Esci</a>
        <span class="muted site-nav__user" aria-hidden="true">{{ display_name }}</span>
      {% else %}
        <form class="site-nav__auth-form" action="{{ url_for('auth.auth_google') }}" method="post">
          <input type="hidden" name="next" value="{{ request.full_path if request.query_string else request.path }}" />
          <button type="submit" class="btn btn-ghost btn-sm">Accedi</button>
        </form>
        <a class="btn btn-primary btn-sm" href="{{ url_for('main.pricing') }}">Piani</a>
      {% endif %}
    </div>
  </div>
</nav>
