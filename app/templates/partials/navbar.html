{% set current_destination = request.full_path.rstrip('?') if request.query_string else request.path %}
{% set nav_links = [
  {'label': 'Home', 'url': url_for('main.index'), 'endpoint': 'main.index'},
  {'label': 'Progetto', 'url': url_for('main.progetto'), 'endpoint': 'main.progetto'},
  {'label': 'Team', 'url': url_for('main.team'), 'endpoint': 'main.team'},
  {'label': 'Etna 3D', 'url': url_for('main.etna3d'), 'endpoint': 'main.etna3d'},
  {'label': 'Experience', 'url': url_for('experience.experience_home'), 'endpoint': 'experience.experience_home'},
  ] %}
{% if not session.user_id %}
  {% set nav_links = nav_links + [
    {
      'label': 'Accedi con Google',
      'url': url_for('auth.auth_google', next=current_destination),
      'endpoint': 'auth.auth_google',
      'extra_class': 'site-nav__link--mobile-only site-nav__link--cta',
      'icon': 'fa-brands fa-google'
    }
  ] %}
{% endif %}

<nav class="site-nav" role="navigation" aria-label="Navigazione principale">
  <div class="container site-nav__inner">
    <a class="site-nav__brand" href="/" aria-label="EtnaMonitor home">
      <span class="site-nav__mark">EtnaMonitor</span>
      <span>EtnaMonitor</span>
    </a>

    <button
      class="site-nav__toggle"
      type="button"
      aria-label="Apri il menu di navigazione"
      aria-controls="primary-navigation"
      aria-expanded="false"
      data-site-nav-toggle
    >
      <span class="site-nav__toggle-lines" aria-hidden="true"></span>
    </button>

    <div class="site-nav__menu" id="primary-navigation" data-site-nav-menu aria-hidden="true" hidden>
      <ul class="site-nav__links">
        {% for link in nav_links %}
          <li>
            <a class="site-nav__link {{ link.extra_class or '' }} {{ 'is-active' if request.endpoint == link.endpoint }}" href="{{ link.url }}">
              {% if link.icon %}
                <span class="site-nav__link-icon" aria-hidden="true"><i class="{{ link.icon }}"></i></span>
              {% endif %}
              <span class="site-nav__link-label">{{ link.label }}</span>
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>

    <div class="site-nav__actions">
      {% if session.user_id %}
        {% set display_name = (current_user.name if current_user else None) or (current_user.email if current_user else None) or 'Utente' %}
        <a class="btn btn-ghost btn-sm" href="{{ url_for('dashboard.dashboard_home') }}">Dashboard</a>
        <a class="btn btn-primary btn-sm" href="{{ url_for('auth.logout') }}">Esci</a>
        <span class="muted site-nav__user" aria-hidden="true">{{ display_name }}</span>
      {% else %}
        <form class="site-nav__auth-form" action="{{ url_for('auth.auth_google') }}" method="post">
          <input type="hidden" name="next" value="{{ request.full_path if request.query_string else request.path }}" />
          <button type="submit" class="btn btn-ghost btn-sm">Accedi</button>
        </form>
        <a class="btn btn-primary btn-sm" href="{{ url_for('main.pricing') }}">Piani</a>
      {% endif %}
    </div>
  </div>
</nav>
