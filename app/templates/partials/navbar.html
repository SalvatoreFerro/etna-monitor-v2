{% set current_destination = request.full_path.rstrip('?') if request.query_string else request.path %}
{% set community_links = [
  {'label': 'Blog', 'url': url_for('community.blog_index'), 'endpoint': 'community.blog_index'},
  {'label': 'Forum', 'url': url_for('community.forum_home'), 'endpoint': 'community.forum_home'},
  {'label': 'Feedback', 'url': url_for('community.feedback_portal'), 'endpoint': 'community.feedback_portal'},
] %}
{% set nav_links = [
  {'label': 'Experience', 'url': url_for('experience.experience_home'), 'endpoint': 'experience.experience_home'},
  {'label': 'Etna 3D', 'url': url_for('main.etna3d'), 'endpoint': 'main.etna3d'},
  {'label': 'Webcam Etna', 'url': url_for('main.webcam_etna'), 'endpoint': 'main.webcam_etna'},
  {'label': 'Community', 'children': community_links},
] %}

{% if not session.user_id %}
  {% set nav_links = nav_links + [
    {
      'label': 'Accedi con Google',
      'url': url_for('auth.auth_google', next=current_destination),
      'endpoint': 'auth.auth_google',
      'extra_class': 'site-nav__link--mobile-only site-nav__link--cta',
      'icon_src': url_for('static', filename='images/google-g.svg')
    }
  ] %}
{% else %}
  {% set nav_links = nav_links + [
    {
      'label': 'Dashboard',
      'url': url_for('dashboard.dashboard_home'),
      'endpoint': 'dashboard.dashboard_home'
    },
    {
      'label': 'Esci',
      'url': url_for('auth.logout'),
      'endpoint': 'auth.logout',
      'extra_class': 'site-nav__link--mobile-only site-nav__link--danger',
      'icon': 'fa-solid fa-right-from-bracket'
    }
  ] %}
{% endif %}

<nav class="site-nav" role="navigation" aria-label="Navigazione principale">
  <div class="container site-nav__inner">
    <a class="site-nav__brand" href="/" aria-label="EtnaMonitor home">
      <span class="site-nav__mark">EtnaMonitor</span>
      <span>EtnaMonitor</span>
    </a>

    <button
      class="site-nav__toggle"
      type="button"
      aria-label="Apri il menu di navigazione"
      aria-controls="primary-navigation"
      aria-expanded="false"
      data-site-nav-toggle
    >
      <span class="site-nav__toggle-lines" aria-hidden="true"></span>
    </button>

    <div class="site-nav__menu" id="primary-navigation" data-site-nav-menu aria-hidden="true" hidden>
      <ul class="site-nav__links">
        {% for link in nav_links %}
          <li class="{{ 'site-nav__item--has-children' if link.children }}">
            {% if link.children %}
              <details class="site-nav__dropdown" data-site-nav-dropdown>
                <summary class="site-nav__link {{ link.extra_class or '' }}">
                  <span class="site-nav__link-label">{{ link.label }}</span>
                  <i class="fas fa-chevron-down" aria-hidden="true"></i>
                </summary>
                <ul class="site-nav__submenu" role="menu">
                  {% for child in link.children %}
                    <li>
                      <a role="menuitem" class="site-nav__sublink {{ 'is-active' if request.endpoint == child.endpoint }}" href="{{ child.url }}">{{ child.label }}</a>
                    </li>
                  {% endfor %}
                </ul>
              </details>
            {% else %}
              <a class="site-nav__link {{ link.extra_class or '' }} {{ 'is-active' if request.endpoint == link.endpoint }}" href="{{ link.url }}">
                {% if link.icon_src %}
                  <span class="site-nav__link-icon" aria-hidden="true"><img src="{{ link.icon_src }}" alt="" loading="lazy" decoding="async" /></span>
                {% elif link.icon %}
                  <span class="site-nav__link-icon" aria-hidden="true"><i class="{{ link.icon }}"></i></span>
                {% endif %}
                <span class="site-nav__link-label">{{ link.label }}</span>
              </a>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>

    <div class="site-nav__actions">
      <button type="button" class="btn btn-ghost btn-sm" data-onboarding-trigger><i class="fas fa-compass"></i> Guida rapida</button>
      {% if session.user_id %}
        {% set display_name = (current_user.name if current_user else None) or (current_user.email if current_user else None) or 'Utente' %}
        <a class="btn btn-secondary btn-sm" href="{{ url_for('dashboard.dashboard_home') }}">Dashboard</a>
        <a class="btn btn-primary btn-sm" href="{{ url_for('auth.logout') }}">Esci</a>
        <span class="muted site-nav__user" aria-hidden="true">{{ display_name }}</span>
      {% else %}
        <form class="site-nav__auth-form" action="{{ url_for('auth.auth_google') }}" method="post">
          <input type="hidden" name="next" value="{{ request.full_path if request.query_string else request.path }}" />
          <button type="submit" class="btn btn-ghost btn-sm">Accedi</button>
        </form>
        <a class="btn btn-primary btn-sm" href="{{ url_for('main.pricing') }}">Piani</a>
      {% endif %}
    </div>
  </div>
</nav>
