{% extends "layout.html" %}

{% block head_extra %}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    .hotspots-header {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      margin: var(--space-6) 0 var(--space-5);
    }

    .hotspots-header h1 {
      margin-bottom: 0;
      font-size: clamp(1.8rem, 1.2rem + 1.6vw, 2.6rem);
      letter-spacing: -0.02em;
    }

    .hotspots-subtitle {
      font-size: var(--font-size-md);
      color: var(--color-text);
      max-width: 720px;
    }

    .hotspots-source {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .hotspots-source a {
      color: #7dd3fc;
      text-decoration: none;
    }

    .hotspots-source a:hover {
      text-decoration: underline;
    }

    .hotspots-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .hotspots-meta span {
      padding: 0.2rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.55);
    }

    .hotspots-note {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      padding: var(--space-4) var(--space-5);
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.7));
      border: 1px solid rgba(148, 163, 184, 0.15);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .hotspots-note strong {
      color: var(--color-text);
    }

    .hotspots-grid {
      display: grid;
      gap: var(--space-6);
    }

    .hotspots-panel {
      background: var(--color-surface);
      border-radius: var(--radius-xl);
      padding: var(--space-5);
      border: 1px solid rgba(148, 163, 184, 0.1);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.35);
    }

    .hotspots-status {
      display: grid;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .hotspots-kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--space-4);
    }

    .hotspots-kpi {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      background: linear-gradient(150deg, rgba(15, 23, 42, 0.85), rgba(30, 41, 59, 0.55));
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      min-height: 96px;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.35s ease, transform 0.35s ease, box-shadow 0.35s ease;
    }

    .hotspots-kpi.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    .hotspots-kpi span {
      color: var(--color-text-secondary);
      font-size: var(--font-size-xs);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .hotspots-kpi strong {
      font-size: clamp(1.3rem, 1.1rem + 0.8vw, 2rem);
      font-weight: var(--font-weight-semibold);
      color: #e2e8f0;
    }

    .hotspots-kpi-note {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      line-height: 1.5;
    }

    .hotspots-message {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(30, 41, 59, 0.6);
      color: var(--color-text-secondary);
    }

    .hotspots-banner {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #fecaca;
      font-size: var(--font-size-sm);
    }

    .hotspots-map-shell {
      position: relative;
      padding: var(--space-2);
      border-radius: calc(var(--radius-lg) + 6px);
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.08);
    }

    .hotspots-map-label {
      position: absolute;
      bottom: var(--space-4);
      left: var(--space-4);
      z-index: 3;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: var(--color-text-secondary);
      font-size: var(--font-size-xs);
      letter-spacing: 0.02em;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .hotspots-map-label.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    #hotspots-map {
      width: 100%;
      height: 420px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 16px 35px rgba(15, 23, 42, 0.45);
    }

    .hotspots-firms-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.7);
      color: #e2e8f0;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      text-decoration: none;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.45);
    }

    .hotspots-firms-badge img {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: #0f172a;
    }

    .hotspots-firms-control {
      margin: 0.4rem;
    }

    .hotspots-map-stack {
      display: grid;
      gap: var(--space-4);
    }

    .hotspots-legend {
      display: grid;
      gap: var(--space-2);
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      background: rgba(15, 23, 42, 0.7);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .hotspots-legend-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
    }

    .legend-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }

    .legend-dot--high {
      background: #ef4444;
    }

    .legend-dot--mid {
      background: #f97316;
    }

    .legend-dot--low {
      background: #facc15;
    }

    .hotspots-loader {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: var(--space-3);
      background: rgba(15, 23, 42, 0.75);
      border-radius: var(--radius-lg);
      z-index: 2;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .hotspots-loader.is-visible {
      opacity: 1;
      pointer-events: auto;
    }

    .loader-ring {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 3px solid rgba(148, 163, 184, 0.25);
      border-top-color: #38bdf8;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .hotspots-list {
      display: grid;
      gap: var(--space-4);
    }

    .hotspots-filter {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .hotspots-filter label {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      cursor: pointer;
    }

    .hotspots-filter input {
      accent-color: #38bdf8;
    }

    .hotspots-card {
      border-radius: var(--radius-lg);
      background: linear-gradient(160deg, rgba(15, 23, 42, 0.85), rgba(30, 41, 59, 0.45));
      border: 1px solid rgba(148, 163, 184, 0.18);
      padding: var(--space-4) var(--space-4);
      display: grid;
      gap: var(--space-4);
      cursor: pointer;
      transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease, opacity 0.25s ease;
    }

    .hotspots-card:hover,
    .hotspots-card.is-active {
      transform: translateY(-2px);
      border-color: rgba(56, 189, 248, 0.5);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.4);
    }

    .hotspots-card--peak {
      border-color: rgba(248, 113, 113, 0.6);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.5), 0 0 0 1px rgba(248, 113, 113, 0.15);
    }

    .hotspots-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
    }

    .hotspots-card-title {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .hotspots-card-title strong {
      display: block;
      color: var(--color-text);
      font-weight: var(--font-weight-semibold);
    }

    .hotspots-pill {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2xs);
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: var(--font-size-xs);
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #0f172a;
      background: #facc15;
    }

    .hotspots-pill--mid {
      background: #fb923c;
    }

    .hotspots-pill--high {
      background: #f87171;
      color: #0f172a;
    }

    .hotspots-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--space-3);
      font-size: var(--font-size-sm);
    }

    .hotspots-card-grid span {
      color: var(--color-text-secondary);
      display: block;
      font-size: var(--font-size-xs);
      margin-bottom: 0.2rem;
    }

    .hotspots-card a {
      color: #7dd3fc;
      text-decoration: none;
      font-size: var(--font-size-xs);
    }

    .hotspots-cta {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2xs);
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.6);
      background: rgba(14, 116, 144, 0.2);
      font-weight: var(--font-weight-semibold);
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .hotspots-cta:hover {
      background: rgba(56, 189, 248, 0.22);
      border-color: rgba(125, 211, 252, 0.85);
    }

    .hotspots-fade {
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.35s ease, transform 0.35s ease;
    }

    .hotspots-fade.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    .hotspots-empty {
      padding: var(--space-5);
      border-radius: var(--radius-lg);
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: var(--color-text-secondary);
      text-align: center;
    }

    .hotspots-disclaimer {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      line-height: 1.6;
    }

    .leaflet-interactive.hotspots-marker {
      filter: drop-shadow(0 0 6px rgba(250, 204, 21, 0.65));
    }

    .leaflet-interactive.hotspots-marker--mid {
      filter: drop-shadow(0 0 6px rgba(249, 115, 22, 0.7));
    }

    .leaflet-interactive.hotspots-marker--high {
      filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.7));
    }

    .leaflet-popup.hotspots-popup .leaflet-popup-content-wrapper {
      background: rgba(15, 23, 42, 0.95);
      color: var(--color-text);
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.6);
    }

    .leaflet-popup.hotspots-popup .leaflet-popup-tip {
      background: rgba(15, 23, 42, 0.95);
    }

    .hotspots-popup {
      font-size: var(--font-size-sm);
      padding: var(--space-2);
      line-height: 1.5;
    }

    .hotspots-popup-title {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-2);
    }

    .hotspots-popup-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }

    .hotspots-popup-label {
      color: var(--color-text-secondary);
      display: block;
      margin-bottom: 0.15rem;
    }

    .hotspots-popup .hotspots-cta {
      margin-top: var(--space-2);
      font-size: var(--font-size-xs);
    }

    .hotspots-seo {
      display: grid;
      gap: var(--space-5);
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      line-height: 1.6;
    }

    .hotspots-seo h2 {
      margin-bottom: var(--space-2);
      color: var(--color-text);
      font-size: clamp(1.2rem, 1rem + 0.6vw, 1.5rem);
    }

    .hotspots-seo-grid {
      display: grid;
      gap: var(--space-4);
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .hotspots-seo h3 {
      margin-bottom: var(--space-2);
      color: var(--color-text);
      font-size: var(--font-size-sm);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    @media (max-width: 900px) {
      #hotspots-map {
        height: 340px;
      }
    }

    @media (max-width: 768px) {
      #hotspots-map {
        height: 280px;
      }

      .hotspots-card-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <section class="container container--wide">
    <div class="hotspots-header">
      <h1>Hotspot termici satellitari sull’Etna</h1>
      <p class="hotspots-subtitle">
        Monitoraggio immediato delle anomalie termiche rilevate dai satelliti NASA FIRMS nelle ultime 24 ore.
      </p>
      <p class="hotspots-source">
        Fonte: <a href="https://firms.modaps.eosdis.nasa.gov/" target="_blank" rel="noopener">NASA FIRMS (VIIRS)</a>
      </p>
      <div class="hotspots-meta">
        <span>Fonte: NASA FIRMS</span>
        <span>Aggiornamento automatico</span>
        <span>Copertura 24h</span>
      </div>
      <div class="hotspots-note">
        <strong>Cosa stai vedendo</strong>
        <span>
          Ogni punto rappresenta un’anomalia termica rilevata dal satellite. È un segnale di attenzione, non una
          previsione di eruzione.
        </span>
      </div>
    </div>

    <div class="hotspots-status">
      <div class="hotspots-kpis hotspots-fade" id="hotspots-kpis">
        <div class="hotspots-kpi">
          <span>Ultimo aggiornamento</span>
          <strong id="hotspots-updated">—</strong>
        </div>
        <div class="hotspots-kpi">
          <span>Hotspot rilevati</span>
          <strong id="hotspots-count">—</strong>
          <div class="hotspots-kpi-note" id="hotspots-count-note"></div>
        </div>
      </div>
      <div class="hotspots-message hotspots-fade" id="hotspots-message" hidden>
        Nessuna anomalia termica significativa nelle ultime 24 ore.
      </div>
      <div class="hotspots-banner hotspots-fade" id="hotspots-error" hidden>
        Errore nel recupero dati satellitari.
      </div>
    </div>

    <div class="hotspots-grid">
      <div class="hotspots-panel">
        <div class="hotspots-map-stack">
          <div class="hotspots-map-shell">
            <div class="hotspots-loader" id="hotspots-loader">
              <div class="loader-ring" aria-hidden="true"></div>
              <div class="muted">Stiamo sincronizzando i dati satellitari…</div>
            </div>
            <div id="hotspots-map" aria-label="Mappa hotspot termici Etna"></div>
            <div class="hotspots-map-label" id="hotspots-map-label">
              Concentrazione di anomalie termiche nell’area sommitale dell’Etna
            </div>
          </div>
          <div class="hotspots-legend">
            <div class="hotspots-legend-title">Legenda intensità</div>
            <div class="legend-row"><span class="legend-dot legend-dot--high"></span> Intensità alta</div>
            <div class="legend-row"><span class="legend-dot legend-dot--mid"></span> Intensità media</div>
            <div class="legend-row"><span class="legend-dot legend-dot--low"></span> Intensità bassa</div>
            <div>Ogni punto = area di circa 375 m</div>
          </div>
        </div>
      </div>

      <div class="hotspots-panel">
        <div class="hotspots-filter">
          <label for="hotspots-filter-main">
            <input type="checkbox" id="hotspots-filter-main" />
            Mostra solo hotspot principali
          </label>
          <span>Filtro per intensità medio-alta.</span>
        </div>
        <div class="hotspots-list" id="hotspots-list"></div>
      </div>
    </div>

    <div class="hotspots-panel" style="margin-top: var(--space-6);">
      <div class="hotspots-seo">
        <div>
          <h2>Hotspot termici satellitari sull’Etna</h2>
          <p>
            Gli hotspot termici sono punti in cui i satelliti rilevano temperature superficiali più elevate del
            contesto circostante. I dati NASA FIRMS aiutano a osservare in modo oggettivo le anomalie termiche sull’Etna
            e a seguire l’evoluzione dell’attività nel tempo.
          </p>
          <p>
            Queste informazioni sono uno strumento di monitoraggio rapido: indicano possibili aree calde, ma non
            costituiscono una previsione di eventi eruttivi né sostituiscono le comunicazioni ufficiali degli enti
            scientifici.
          </p>
          <p>
            La pagina aggiorna automaticamente le rilevazioni satellitari più recenti, offrendo un quadro sintetico
            delle anomalie termiche dell’Etna oggi.
          </p>
        </div>
        <div class="hotspots-seo-grid">
          <div>
            <h3>Cos’è un hotspot FIRMS</h3>
            <p>
              FIRMS (Fire Information for Resource Management System) combina osservazioni satellitari VIIRS e MODIS
              per individuare anomalie termiche. Un hotspot indica un segnale rilevato, non un evento confermato.
            </p>
          </div>
          <div>
            <h3>Ogni quanto vengono aggiornati i dati satellitari</h3>
            <p>
              I passaggi dei satelliti consentono aggiornamenti più volte al giorno. La disponibilità dipende
              dall’orbita e dalle condizioni atmosferiche.
            </p>
          </div>
          <div>
            <h3>Limiti dell’osservazione satellitare</h3>
            <p>
              Copertura nuvolosa, fumo o angolo di osservazione possono ridurre la sensibilità. I dati vanno letti come
              indicatori di tendenza e non come conferme definitive.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="hotspots-panel" style="margin-top: var(--space-6);">
      <p class="hotspots-disclaimer">
        Disclaimer: i dati FIRMS sono indicativi e servono per monitoraggio ambientale. Non rappresentano una
        previsione né una conferma certa di attività eruttiva.
      </p>
    </div>
  </section>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script nonce="{{ csp_nonce() }}">
    const mapCenter = { lat: {{ map_center.lat }}, lon: {{ map_center.lon }} };

    const loader = document.getElementById('hotspots-loader');
    const message = document.getElementById('hotspots-message');
    const errorBanner = document.getElementById('hotspots-error');
    const updatedEl = document.getElementById('hotspots-updated');
    const countEl = document.getElementById('hotspots-count');
    const countNoteEl = document.getElementById('hotspots-count-note');
    const listEl = document.getElementById('hotspots-list');
    const kpisEl = document.getElementById('hotspots-kpis');
    const mapLabel = document.getElementById('hotspots-map-label');
    const filterToggle = document.getElementById('hotspots-filter-main');

    const kpiCards = document.querySelectorAll('.hotspots-kpi');

    const numberFormat = new Intl.NumberFormat('it-IT', { maximumFractionDigits: 2 });
    const neutralZoom = 10;

    let allItems = [];

    const map = window.L
      ? L.map('hotspots-map', {
          scrollWheelZoom: false,
          zoomControl: true,
          minZoom: 9,
          maxZoom: 16,
        })
      : null;

    if (map) {
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        maxZoom: 16,
      }).addTo(map);

      map.setView([mapCenter.lat, mapCenter.lon], neutralZoom, { animate: false });

      const firmsControl = L.control({ position: 'topleft' });
      firmsControl.onAdd = () => {
        const container = L.DomUtil.create('div', 'hotspots-firms-control');
        container.innerHTML = `
          <a
            class="hotspots-firms-badge"
            href="https://firms.modaps.eosdis.nasa.gov/"
            target="_blank"
            rel="noopener"
            title="Fonte dati: NASA FIRMS"
          >
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e5/NASA_logo.svg" alt="NASA" />
            NASA FIRMS
          </a>
        `;
        L.DomEvent.disableClickPropagation(container);
        return container;
      };
      firmsControl.addTo(map);
    }

    const markersLayer = map ? L.layerGroup().addTo(map) : null;

    const setLoaderVisible = (visible) => {
      if (!loader) {
        return;
      }
      loader.classList.toggle('is-visible', visible);
    };

    const setFadeVisible = (element, visible) => {
      if (!element) {
        return;
      }
      element.hidden = !visible;
      requestAnimationFrame(() => {
        element.classList.toggle('is-visible', visible);
      });
    };

    const setMapLabelVisible = (visible) => {
      if (!mapLabel) {
        return;
      }
      mapLabel.classList.toggle('is-visible', visible);
    };

    const markerColor = (brightness) => {
      if (brightness == null) {
        return '#facc15';
      }
      if (brightness >= 340) {
        return '#ef4444';
      }
      if (brightness >= 325) {
        return '#f97316';
      }
      return '#facc15';
    };

    const markerClass = (brightness) => {
      if (brightness == null) {
        return 'hotspots-marker';
      }
      if (brightness >= 340) {
        return 'hotspots-marker hotspots-marker--high';
      }
      if (brightness >= 325) {
        return 'hotspots-marker hotspots-marker--mid';
      }
      return 'hotspots-marker';
    };

    const intensityLabel = (brightness, unit) => {
      if (brightness == null) {
        return '—';
      }
      return `${numberFormat.format(brightness)} ${unit || ''}`.trim();
    };

    const frpLabel = (frp) => (frp == null ? '—' : `${numberFormat.format(frp)} MW`);

    const relativeTime = (dateString) => {
      if (!dateString) {
        return { label: 'Non disponibile', iso: '' };
      }
      const date = new Date(dateString);
      if (Number.isNaN(date.getTime())) {
        return { label: dateString, iso: dateString };
      }
      const diffMs = date.getTime() - Date.now();
      const rtf = new Intl.RelativeTimeFormat('it', { numeric: 'auto' });
      const diffSeconds = Math.round(diffMs / 1000);
      const absSeconds = Math.abs(diffSeconds);
      if (absSeconds < 60) {
        return { label: rtf.format(diffSeconds, 'second'), iso: dateString };
      }
      const diffMinutes = Math.round(diffSeconds / 60);
      if (Math.abs(diffMinutes) < 60) {
        return { label: rtf.format(diffMinutes, 'minute'), iso: dateString };
      }
      const diffHours = Math.round(diffMinutes / 60);
      if (Math.abs(diffHours) < 24) {
        return { label: rtf.format(diffHours, 'hour'), iso: dateString };
      }
      const diffDays = Math.round(diffHours / 24);
      return { label: rtf.format(diffDays, 'day'), iso: dateString };
    };

    const clearList = () => {
      if (listEl) {
        listEl.innerHTML = '';
      }
    };

    const setEmptyState = (text) => {
      clearList();
      if (listEl) {
        const empty = document.createElement('div');
        empty.className = 'hotspots-empty hotspots-fade is-visible';
        empty.textContent = text || 'Nessuna anomalia rilevata nelle ultime 24 ore. Nessun segnale anomalo rilevante.';
        listEl.appendChild(empty);
      }
    };

    const updateMarkers = (items) => {
      if (!markersLayer || !map) {
        return { markerMap: new Map() };
      }
      markersLayer.clearLayers();
      const markerMap = new Map();
      const bounds = L.latLngBounds([]);
      let hasPoints = false;

      items.forEach((item, index) => {
        const brightness = item?.intensity?.brightness ?? null;
        const color = markerColor(brightness);
        const marker = L.circleMarker([item.lat, item.lon], {
          radius: 8,
          color: '#f8fafc',
          fillColor: color,
          weight: 2.2,
          fillOpacity: 0.85,
          className: markerClass(brightness),
        });

        const tooltip = `${intensityLabel(brightness, item?.intensity?.unit)} • ${frpLabel(
          item?.intensity?.frp
        )}`;
        marker.bindTooltip(tooltip, { direction: 'top', opacity: 0.9 });

        const timeInfo = relativeTime(item.time_utc);
        const popup = `
          <div class="hotspots-popup">
            <div class="hotspots-popup-title">Anomalia termica rilevata</div>
            <div class="hotspots-popup-grid">
              <div>
                <span class="hotspots-popup-label">Intensità</span>
                ${intensityLabel(brightness, item?.intensity?.unit)}
              </div>
              <div>
                <span class="hotspots-popup-label">FRP</span>
                ${frpLabel(item?.intensity?.frp)}
              </div>
              <div>
                <span class="hotspots-popup-label">Confidence</span>
                ${item.confidence}
              </div>
              <div>
                <span class="hotspots-popup-label">Satellite</span>
                ${item.satellite}
              </div>
              <div>
                <span class="hotspots-popup-label">Status</span>
                ${item.status}
              </div>
              <div>
                <span class="hotspots-popup-label">Rilevato</span>
                <span title="${timeInfo.iso}">${timeInfo.label}</span>
              </div>
            </div>
            <a class="hotspots-cta" href="${item.maps_url}" target="_blank" rel="noopener">Apri su Google Maps</a>
          </div>
        `;
        marker.bindPopup(popup, { className: 'hotspots-popup' });
        marker.addTo(markersLayer);
        markerMap.set(index, marker);
        bounds.extend([item.lat, item.lon]);
        hasPoints = true;
      });

      if (hasPoints) {
        map.fitBounds(bounds, { padding: [28, 28], maxZoom: 13, animate: false });
      }

      return { markerMap };
    };

    const renderList = (items, markerMap, maxBrightness) => {
      if (!listEl) {
        return;
      }
      listEl.innerHTML = '';

      if (items.length === 0) {
        setEmptyState('Nessun hotspot principale nelle ultime 24 ore.');
        return;
      }

      items.forEach((item, index) => {
        const brightness = item?.intensity?.brightness ?? null;
        const card = document.createElement('div');
        const isPeak = maxBrightness != null && brightness === maxBrightness;
        card.className = `hotspots-card hotspots-fade${isPeak ? ' hotspots-card--peak' : ''}`;
        const colorClass = brightness >= 340 ? 'hotspots-pill--high' : brightness >= 325 ? 'hotspots-pill--mid' : '';
        const pillText = brightness >= 340 ? 'Alta' : brightness >= 325 ? 'Media' : 'Bassa';
        const pillTitle = `Intensità ${pillText.toLowerCase()}`;
        const timeInfo = relativeTime(item.time_utc);

        card.innerHTML = `
          <div class="hotspots-card-header">
            <div class="hotspots-card-title">
              Rilevato
              <strong title="${timeInfo.iso}">${timeInfo.label}</strong>
            </div>
            <span class="hotspots-pill ${colorClass}" title="${pillTitle}" aria-label="${pillTitle}">${pillText}</span>
          </div>
          <div class="hotspots-card-grid">
            <div>
              <span>Intensità</span>
              ${intensityLabel(brightness, item?.intensity?.unit)}
            </div>
            <div>
              <span>FRP</span>
              ${frpLabel(item?.intensity?.frp)}
            </div>
            <div>
              <span>Confidence</span>
              ${item.confidence}
            </div>
            <div>
              <span>Satellite</span>
              ${item.satellite}
            </div>
            <div>
              <span>Status</span>
              ${item.status}
            </div>
          </div>
          <div>
            <a class="hotspots-cta" href="${item.maps_url}" target="_blank" rel="noopener">Apri su Google Maps</a>
          </div>
        `;

        const marker = markerMap.get(index);
        const defaultStyle = marker
          ? {
              radius: marker.options.radius,
              weight: marker.options.weight,
              fillOpacity: marker.options.fillOpacity,
            }
          : null;

        const highlightMarker = () => {
          if (!marker) {
            return;
          }
          marker.setStyle({ radius: 10, weight: 3, fillOpacity: 1 });
          card.classList.add('is-active');
        };

        const resetMarker = () => {
          if (!marker || !defaultStyle) {
            return;
          }
          marker.setStyle(defaultStyle);
          card.classList.remove('is-active');
        };

        card.addEventListener('mouseenter', highlightMarker);
        card.addEventListener('mouseleave', resetMarker);
        card.addEventListener('click', (event) => {
          if (event.target.closest('a')) {
            return;
          }
          if (marker && map) {
            map.setView([item.lat, item.lon], 13, { animate: true });
            marker.openPopup();
          }
        });

        listEl.appendChild(card);
        requestAnimationFrame(() => {
          card.classList.add('is-visible');
        });
      });
    };

    const filteredItems = () => {
      if (filterToggle && filterToggle.checked) {
        return allItems.filter((item) => (item?.intensity?.brightness ?? 0) >= 325);
      }
      return allItems;
    };

    const renderHotspots = () => {
      const filtered = filteredItems();
      const maxBrightness = allItems.reduce((max, item) => {
        const brightness = item?.intensity?.brightness ?? 0;
        return brightness > max ? brightness : max;
      }, 0);
      const { markerMap } = updateMarkers(filtered);
      renderList(filtered, markerMap, maxBrightness || null);
    };

    const applyData = (data) => {
      const items = Array.isArray(data.items_24h) ? data.items_24h : [];
      const sorted = [...items].sort((a, b) => {
        const brightnessA = a?.intensity?.brightness ?? 0;
        const brightnessB = b?.intensity?.brightness ?? 0;
        return brightnessB - brightnessA;
      });

      const updateInfo = relativeTime(data.last_fetch_at);
      updatedEl.textContent = updateInfo.label;
      updatedEl.title = updateInfo.iso;
      const totalCount = data.count_24h ?? sorted.length ?? 0;
      const lastFetchCount = data.last_fetch_count ?? 0;
      countEl.textContent = numberFormat.format(totalCount);
      if (countNoteEl) {
        if (totalCount > 0) {
          if (lastFetchCount === 0 && data.last_nonzero_at) {
            const lastNonzero = relativeTime(data.last_nonzero_at);
            countNoteEl.textContent = `Ultimo passaggio satellitare: 0 hotspot — ultimo hotspot rilevato: ${lastNonzero.label}`;
            countNoteEl.title = lastNonzero.iso || '';
          } else {
            countNoteEl.textContent = 'Attività termica superficiale rilevata dai satelliti.';
            countNoteEl.title = '';
          }
        } else {
          countNoteEl.textContent = 'Nessuna anomalia termica significativa nelle ultime 24 ore.';
          countNoteEl.title = '';
        }
      }
      if (filterToggle) {
        filterToggle.disabled = totalCount === 0;
        if (totalCount === 0) {
          filterToggle.checked = false;
        }
      }

      setFadeVisible(kpisEl, true);
      kpiCards.forEach((card, index) => {
        setTimeout(() => card.classList.add('is-visible'), 60 * index);
      });

      allItems = sorted;
      setMapLabelVisible(totalCount > 0);

      if (!data.available || totalCount === 0 || sorted.length === 0) {
        setFadeVisible(message, true);
        setEmptyState('Nessuna anomalia termica significativa nelle ultime 24 ore.');
        if (markersLayer) {
          markersLayer.clearLayers();
        }
        if (map) {
          map.setView([mapCenter.lat, mapCenter.lon], neutralZoom, { animate: false });
        }
        return;
      }

      setFadeVisible(message, false);

      renderHotspots();
    };

    const fetchHotspots = async () => {
      setLoaderVisible(true);
      setFadeVisible(errorBanner, false);
      try {
        const response = await fetch('/api/hotspots/latest', { headers: { Accept: 'application/json' } });
        if (!response.ok) {
          throw new Error('Errore risposta');
        }
        const data = await response.json();
        applyData(data);
      } catch (error) {
        setFadeVisible(errorBanner, true);
        setEmptyState();
        setMapLabelVisible(false);
        if (filterToggle) {
          filterToggle.disabled = true;
          filterToggle.checked = false;
        }
      } finally {
        setLoaderVisible(false);
      }
    };

    if (filterToggle) {
      filterToggle.addEventListener('change', () => {
        renderHotspots();
      });
    }

    fetchHotspots();
  </script>
  <script type="application/ld+json" nonce="{{ csp_nonce() }}">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "Cos’è un hotspot termico?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "È un’anomalia termica rilevata dai satelliti che segnala una possibile area più calda del contesto circostante."
          }
        },
        {
          "@type": "Question",
          "name": "Gli hotspot indicano un’eruzione imminente?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "No. Gli hotspot sono indicatori di attività superficiale e non costituiscono una previsione di eventi eruttivi."
          }
        },
        {
          "@type": "Question",
          "name": "Ogni quanto vengono aggiornati i dati?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "I dati FIRMS si aggiornano a ogni nuovo passaggio satellitare, tipicamente più volte al giorno."
          }
        },
        {
          "@type": "Question",
          "name": "Qual è la fonte dei dati?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Le rilevazioni provengono dal sistema NASA FIRMS, basato su osservazioni satellitari VIIRS e MODIS."
          }
        }
      ]
    }
  </script>
{% endblock %}
