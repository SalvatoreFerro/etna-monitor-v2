{% extends "layout.html" %}
{% set is_authenticated = current_user and current_user.is_authenticated %}
{% set has_telegram = is_authenticated and (current_user.telegram_chat_id or current_user.chat_id) and current_user.telegram_opt_in %}
{% if not is_authenticated %}
  {% set telegram_cta_url = url_for('auth.login') %}
{% elif has_telegram %}
  {% set telegram_cta_url = url_for('dashboard.dashboard_home') %}
{% else %}
  {% set telegram_cta_url = url_for('dashboard.dashboard_home') ~ '#alert-settings' %}
{% endif %}
{% set graph_live_url = url_for('main.index') ~ '#grafico-etna' %}

{% block head_extra %}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/hotspots.css') }}?v={{ STATIC_ASSET_VERSION }}" />
{% endblock %}

{% block content %}
  {% from "partials/leaflet_map.html" import etna_map_shell, etna_hotspots_legend %}
  <section class="container container--wide">
    <div class="hotspots-header">
      <h1>Hotspot termici satellitari sull‚ÄôEtna</h1>
      <span class="hotspots-new-badge">üõ∞Ô∏è Nuovo: hotspot satellitari in tempo quasi reale</span>
      <p class="hotspots-subtitle">
        Monitoraggio immediato delle anomalie termiche rilevate dai satelliti NASA FIRMS nelle ultime 24 ore.
      </p>
      <p class="hotspots-source">
        Fonte: <a href="https://firms.modaps.eosdis.nasa.gov/" target="_blank" rel="noopener">NASA FIRMS (VIIRS)</a>
      </p>
      <div class="hotspots-meta">
        <span>Fonte: NASA FIRMS</span>
        <span>Aggiornamento automatico</span>
        <span>Copertura 24h</span>
      </div>
      <div class="hotspots-note">
        <strong>Cosa stai vedendo</strong>
        <span>
          Gli hotspot indicano anomalie termiche viste da satellite. Non sono previsioni di eruzione, ma segnali di
          possibile attivit√† superficiale.
        </span>
      </div>
      <div class="hotspots-callouts">
        <div class="hotspots-callout">
          <strong>Avvisi Telegram</strong>
          <span>Ti avvisiamo quando cambiano gli hotspot pi√π rilevanti, cos√¨ non perdi gli aggiornamenti chiave.</span>
          {% if has_telegram %}
            <span>Notifiche Telegram gi√† attive: controlla la dashboard per i dettagli.</span>
          {% endif %}
          <div class="hero__actions">
            <a
              class="btn btn-primary"
              href="{{ telegram_cta_url }}"
              data-cta="telegram_primary"
              data-location="hotspots"
            >Ricevi avvisi su Telegram</a>
            <a
              class="btn btn-secondary"
              href="{{ graph_live_url }}"
              data-cta="graph_live_secondary"
              data-location="hotspots"
            >Apri il grafico live</a>
          </div>
          <span class="muted">Gratis con un account EtnaMonitor.</span>
        </div>
      </div>
    </div>

    <div class="hotspots-status">
      <p class="hotspots-source">I KPI sintetizzano le ultime 24 ore per leggere subito l‚Äôandamento termico.</p>
      <div class="hotspots-kpis hotspots-fade" id="hotspots-kpis">
        <div class="hotspots-kpi">
          <span>Ultimo aggiornamento</span>
          <strong id="hotspots-updated">‚Äî</strong>
        </div>
        <div class="hotspots-kpi">
          <span>Hotspot FIRMS (24h)</span>
          <strong id="hotspots-count-all">‚Äî</strong>
          <div class="hotspots-kpi-note" id="hotspots-count-note"></div>
        </div>
        <div class="hotspots-kpi">
          <span>Hotspot significativi</span>
          <strong id="hotspots-count-significant">‚Äî</strong>
          <div class="hotspots-kpi-note">Filtro EtnaMonitor (intensit√† medio-alta).</div>
        </div>
      </div>
      <div class="hotspots-message hotspots-fade" id="hotspots-message" hidden>
        Nessuna anomalia termica significativa nelle ultime 24 ore.
      </div>
      <div class="hotspots-banner hotspots-fade" id="hotspots-error" hidden>
        Errore nel recupero dati satellitari.
      </div>
    </div>

    <div class="hotspots-grid">
      <div class="hotspots-panel">
        {% call etna_map_shell(
          'hotspots-map',
          'hotspots-map-label',
          'hotspots-loader',
          'Concentrazione di anomalie termiche nell‚Äôarea sommitale dell‚ÄôEtna',
          aria_label='Mappa hotspot termici Etna'
        ) %}
          {{ etna_hotspots_legend() }}
        {% endcall %}
        <p class="hotspots-source">Clicca un punto per dettagli e intensit√†: la mappa evidenzia le anomalie pi√π recenti.</p>
      </div>

      <div class="hotspots-panel">
        <div class="hotspots-filter">
          <div class="hotspots-filter-label">Visualizzazione</div>
          <div class="hotspots-toggle" role="group" aria-label="Filtro hotspot">
            <button type="button" class="hotspots-toggle-button is-active" data-mode="all">
              Tutti (FIRMS)
            </button>
            <button type="button" class="hotspots-toggle-button" data-mode="significant">
              Significativi
            </button>
          </div>
          <span>Confronta i punti FIRMS con il filtro EtnaMonitor.</span>
        </div>
        <div class="hotspots-list" id="hotspots-list"></div>
      </div>
    </div>

    <div class="hotspots-panel hotspots-panel--spaced">
      <p>
        Vuoi avvisi pi√π frequenti e storico esteso? <a href="{{ url_for('main.pricing') }}" data-cta="premium_soft" data-location="hotspots">Scopri Premium.</a>
      </p>
    </div>

    <div class="hotspots-panel hotspots-panel--spaced">
      <div class="hotspots-seo">
        <div>
          <h2>Hotspot termici satellitari sull‚ÄôEtna</h2>
          <p>
            Gli hotspot termici sono punti in cui i satelliti rilevano temperature superficiali pi√π elevate del
            contesto circostante. I dati NASA FIRMS aiutano a osservare in modo oggettivo le anomalie termiche sull‚ÄôEtna
            e a seguire l‚Äôevoluzione dell‚Äôattivit√† nel tempo.
          </p>
          <p>
            Queste informazioni sono uno strumento di monitoraggio rapido: indicano possibili aree calde, ma non
            costituiscono una previsione di eventi eruttivi n√© sostituiscono le comunicazioni ufficiali degli enti
            scientifici.
          </p>
          <p>
            La pagina aggiorna automaticamente le rilevazioni satellitari pi√π recenti, offrendo un quadro sintetico
            delle anomalie termiche dell‚ÄôEtna oggi.
          </p>
        </div>
        <div class="hotspots-seo-grid">
          <div>
            <h3>Cos‚Äô√® un hotspot FIRMS</h3>
            <p>
              FIRMS (Fire Information for Resource Management System) combina osservazioni satellitari VIIRS e MODIS
              per individuare anomalie termiche. Un hotspot indica un segnale rilevato, non un evento confermato.
            </p>
          </div>
          <div>
            <h3>Ogni quanto vengono aggiornati i dati satellitari</h3>
            <p>
              I passaggi dei satelliti consentono aggiornamenti pi√π volte al giorno. La disponibilit√† dipende
              dall‚Äôorbita e dalle condizioni atmosferiche.
            </p>
          </div>
          <div>
            <h3>Limiti dell‚Äôosservazione satellitare</h3>
            <p>
              Copertura nuvolosa, fumo o angolo di osservazione possono ridurre la sensibilit√†. I dati vanno letti come
              indicatori di tendenza e non come conferme definitive.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="hotspots-panel hotspots-panel--spaced">
      <p class="hotspots-disclaimer">
        Disclaimer: i dati FIRMS sono indicativi e servono per monitoraggio ambientale. Non rappresentano una
        previsione n√© una conferma certa di attivit√† eruttiva.
      </p>
    </div>
  </section>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="{{ url_for('static', filename='js/leaflet_common.js') }}?v={{ STATIC_ASSET_VERSION }}"></script>
  <script nonce="{{ csp_nonce() }}">
    if (window.etnaTrackEvent) {
      window.etnaTrackEvent('hotspot_page_view', { location: 'hotspots' });
    }

    const mapCenter = { lat: {{ map_center.lat }}, lon: {{ map_center.lon }} };

    const loader = document.getElementById('hotspots-loader');
    const message = document.getElementById('hotspots-message');
    const errorBanner = document.getElementById('hotspots-error');
    const updatedEl = document.getElementById('hotspots-updated');
    const countAllEl = document.getElementById('hotspots-count-all');
    const countSignificantEl = document.getElementById('hotspots-count-significant');
    const countNoteEl = document.getElementById('hotspots-count-note');
    const listEl = document.getElementById('hotspots-list');
    const kpisEl = document.getElementById('hotspots-kpis');
    const mapLabel = document.getElementById('hotspots-map-label');
    const toggleButtons = document.querySelectorAll('.hotspots-toggle-button');

    const kpiCards = document.querySelectorAll('.hotspots-kpi');

    const numberFormat = new Intl.NumberFormat('it-IT', { maximumFractionDigits: 2 });
    const neutralZoom = 10;

    let rawItems = [];
    let significantItems = [];
    let allItems = [];
    let activeMode = 'all';

    const map =
      window.EtnaLeaflet && window.L
        ? window.EtnaLeaflet.createEtnaMap('hotspots-map', {
            center: [mapCenter.lat, mapCenter.lon],
            zoom: neutralZoom,
            addFirmsBadge: true,
          })
        : null;

    const markersLayer = map ? L.layerGroup().addTo(map) : null;

    const setLoaderVisible = (visible) => {
      if (!loader) {
        return;
      }
      loader.classList.toggle('is-visible', visible);
    };

    const setFadeVisible = (element, visible) => {
      if (!element) {
        return;
      }
      element.hidden = !visible;
      requestAnimationFrame(() => {
        element.classList.toggle('is-visible', visible);
      });
    };

    const setMapLabelVisible = (visible) => {
      if (!mapLabel) {
        return;
      }
      mapLabel.classList.toggle('is-visible', visible);
    };

    const intensityLabel = (brightness, unit) => {
      if (brightness == null) {
        return '‚Äî';
      }
      return `${numberFormat.format(brightness)} ${unit || ''}`.trim();
    };

    const frpLabel = (frp) => (frp == null ? '‚Äî' : `${numberFormat.format(frp)} MW`);

    const relativeTime = (dateString) => {
      if (!dateString) {
        return { label: 'Non disponibile', iso: '' };
      }
      const date = new Date(dateString);
      if (Number.isNaN(date.getTime())) {
        return { label: dateString, iso: dateString };
      }
      const diffMs = date.getTime() - Date.now();
      const rtf = new Intl.RelativeTimeFormat('it', { numeric: 'auto' });
      const diffSeconds = Math.round(diffMs / 1000);
      const absSeconds = Math.abs(diffSeconds);
      if (absSeconds < 60) {
        return { label: rtf.format(diffSeconds, 'second'), iso: dateString };
      }
      const diffMinutes = Math.round(diffSeconds / 60);
      if (Math.abs(diffMinutes) < 60) {
        return { label: rtf.format(diffMinutes, 'minute'), iso: dateString };
      }
      const diffHours = Math.round(diffMinutes / 60);
      if (Math.abs(diffHours) < 24) {
        return { label: rtf.format(diffHours, 'hour'), iso: dateString };
      }
      const diffDays = Math.round(diffHours / 24);
      return { label: rtf.format(diffDays, 'day'), iso: dateString };
    };

    const clearList = () => {
      if (listEl) {
        listEl.innerHTML = '';
      }
    };

    const setEmptyState = (text) => {
      clearList();
      if (listEl) {
        const empty = document.createElement('div');
        empty.className = 'hotspots-empty hotspots-fade is-visible';
        empty.textContent = text || 'Nessuna anomalia rilevata nelle ultime 24 ore. Nessun segnale anomalo rilevante.';
        listEl.appendChild(empty);
      }
    };

    const updateMarkers = (items) => {
      if (!markersLayer || !map || !window.EtnaLeaflet) {
        return { markerMap: new Map() };
      }

      const result = window.EtnaLeaflet.addHotspotsLayer(map, items, {
        layer: markersLayer,
        fitBounds: true,
        maxZoom: 13,
        onMarker: (marker, item) => {
          const brightness = item?.intensity?.brightness ?? null;
          const tooltip = `${intensityLabel(brightness, item?.intensity?.unit)} ‚Ä¢ ${frpLabel(
            item?.intensity?.frp
          )}`;
          marker.bindTooltip(tooltip, { direction: 'top', opacity: 0.9 });

          const timeInfo = relativeTime(item.time_utc);
          const popup = `
            <div class="hotspots-popup">
              <div class="hotspots-popup-title">Anomalia termica rilevata</div>
              <div class="hotspots-popup-grid">
                <div>
                  <span class="hotspots-popup-label">Intensit√†</span>
                  ${intensityLabel(brightness, item?.intensity?.unit)}
                </div>
                <div>
                  <span class="hotspots-popup-label">FRP</span>
                  ${frpLabel(item?.intensity?.frp)}
                </div>
                <div>
                  <span class="hotspots-popup-label">Confidence</span>
                  ${item.confidence}
                </div>
                <div>
                  <span class="hotspots-popup-label">Satellite</span>
                  ${item.satellite}
                </div>
                <div>
                  <span class="hotspots-popup-label">Status</span>
                  ${item.status}
                </div>
                <div>
                  <span class="hotspots-popup-label">Rilevato</span>
                  <span title="${timeInfo.iso}">${timeInfo.label}</span>
                </div>
              </div>
              <a class="hotspots-cta" href="${item.maps_url}" target="_blank" rel="noopener">Apri su Google Maps</a>
            </div>
          `;
          marker.bindPopup(popup, { className: 'hotspots-popup' });
        },
      });

      return { markerMap: result.markerMap };
    };

    const renderList = (items, markerMap, maxBrightness) => {
      if (!listEl) {
        return;
      }
      listEl.innerHTML = '';

      if (items.length === 0) {
        const emptyText =
          activeMode === 'significant'
            ? 'Nessun hotspot significativo nelle ultime 24 ore.'
            : 'Nessun hotspot FIRMS nelle ultime 24 ore.';
        setEmptyState(emptyText);
        return;
      }

      items.forEach((item, index) => {
        const brightness = item?.intensity?.brightness ?? null;
        const card = document.createElement('div');
        const isPeak = maxBrightness != null && brightness === maxBrightness;
        card.className = `hotspots-card hotspots-fade${isPeak ? ' hotspots-card--peak' : ''}`;
        const colorClass = brightness >= 340 ? 'hotspots-pill--high' : brightness >= 325 ? 'hotspots-pill--mid' : '';
        const pillText = brightness >= 340 ? 'Alta' : brightness >= 325 ? 'Media' : 'Bassa';
        const pillTitle = `Intensit√† ${pillText.toLowerCase()}`;
        const timeInfo = relativeTime(item.time_utc);

        card.innerHTML = `
          <div class="hotspots-card-header">
            <div class="hotspots-card-title">
              Rilevato
              <strong title="${timeInfo.iso}">${timeInfo.label}</strong>
            </div>
            <span class="hotspots-pill ${colorClass}" title="${pillTitle}" aria-label="${pillTitle}">${pillText}</span>
          </div>
          <div class="hotspots-card-grid">
            <div>
              <span>Intensit√†</span>
              ${intensityLabel(brightness, item?.intensity?.unit)}
            </div>
            <div>
              <span>FRP</span>
              ${frpLabel(item?.intensity?.frp)}
            </div>
            <div>
              <span>Confidence</span>
              ${item.confidence}
            </div>
            <div>
              <span>Satellite</span>
              ${item.satellite}
            </div>
            <div>
              <span>Status</span>
              ${item.status}
            </div>
          </div>
          <div>
            <a class="hotspots-cta" href="${item.maps_url}" target="_blank" rel="noopener">Apri su Google Maps</a>
          </div>
        `;

        const marker = markerMap.get(index);
        const defaultStyle = marker
          ? {
              radius: marker.options.radius,
              weight: marker.options.weight,
              fillOpacity: marker.options.fillOpacity,
            }
          : null;

        const highlightMarker = () => {
          if (!marker) {
            return;
          }
          marker.setStyle({ radius: 10, weight: 3, fillOpacity: 1 });
          card.classList.add('is-active');
        };

        const resetMarker = () => {
          if (!marker || !defaultStyle) {
            return;
          }
          marker.setStyle(defaultStyle);
          card.classList.remove('is-active');
        };

        card.addEventListener('mouseenter', highlightMarker);
        card.addEventListener('mouseleave', resetMarker);
        card.addEventListener('click', (event) => {
          if (event.target.closest('a')) {
            return;
          }
          if (marker && map) {
            map.setView([item.lat, item.lon], 13, { animate: true });
            marker.openPopup();
          }
        });

        listEl.appendChild(card);
        requestAnimationFrame(() => {
          card.classList.add('is-visible');
        });
      });
    };

    const renderHotspots = () => {
      const filtered = allItems;
      const maxBrightness = allItems.reduce((max, item) => {
        const brightness = item?.intensity?.brightness ?? 0;
        return brightness > max ? brightness : max;
      }, 0);
      const { markerMap } = updateMarkers(filtered);
      renderList(filtered, markerMap, maxBrightness || null);
    };

    const applyData = (data) => {
      const raw = Array.isArray(data.items_24h_raw) ? data.items_24h_raw : Array.isArray(data.items) ? data.items : [];
      const significant = Array.isArray(data.items_24h_significant) ? data.items_24h_significant : raw;
      const activeItems = activeMode === 'significant' ? significant : raw;
      const sorted = [...activeItems].sort((a, b) => {
        const brightnessA = a?.intensity?.brightness ?? 0;
        const brightnessB = b?.intensity?.brightness ?? 0;
        return brightnessB - brightnessA;
      });

      const updateInfo = relativeTime(data.last_fetch_at);
      updatedEl.textContent = updateInfo.label;
      updatedEl.title = updateInfo.iso;
      const totalCount = data.count_24h_raw ?? data.count_all ?? data.count_24h ?? raw.length ?? 0;
      const significantCount = data.count_24h_significant ?? data.count_significant ?? significant.length ?? 0;
      const lastFetchCount = data.last_fetch_count ?? 0;
      countAllEl.textContent = numberFormat.format(totalCount);
      countSignificantEl.textContent = numberFormat.format(significantCount);
      if (countNoteEl) {
        if (totalCount > 0) {
          if (lastFetchCount === 0 && data.last_nonzero_at) {
            const lastNonzero = relativeTime(data.last_nonzero_at);
            countNoteEl.textContent = `Ultimo passaggio satellitare: 0 hotspot ‚Äî ultimo hotspot rilevato: ${lastNonzero.label}`;
            countNoteEl.title = lastNonzero.iso || '';
          } else if (significantCount === 0) {
            countNoteEl.textContent = 'Hotspot deboli o poco significativi presenti.';
            countNoteEl.title = '';
          } else {
            countNoteEl.textContent = 'Attivit√† termica superficiale rilevata dai satelliti.';
            countNoteEl.title = '';
          }
        } else {
          countNoteEl.textContent = 'Nessuna anomalia termica nelle ultime 24 ore.';
          countNoteEl.title = '';
        }
      }
      toggleButtons.forEach((button) => {
        button.disabled = totalCount === 0 && button.dataset.mode === 'significant';
      });

      setFadeVisible(kpisEl, true);
      kpiCards.forEach((card, index) => {
        setTimeout(() => card.classList.add('is-visible'), 60 * index);
      });

      rawItems = raw;
      significantItems = significant;
      allItems = sorted;
      setMapLabelVisible(totalCount > 0);

      if (!data.available || totalCount === 0 || sorted.length === 0) {
        setFadeVisible(message, true);
        if (totalCount === 0) {
          setEmptyState('Nessuna anomalia termica nelle ultime 24 ore.');
        } else if (activeMode === 'significant') {
          setEmptyState('Hotspot deboli o poco significativi presenti.');
        } else {
          setEmptyState('Nessuna anomalia termica nelle ultime 24 ore.');
        }
        if (markersLayer) {
          markersLayer.clearLayers();
        }
        if (map) {
          map.setView([mapCenter.lat, mapCenter.lon], neutralZoom, { animate: false });
        }
        return;
      }

      setFadeVisible(message, false);

      renderHotspots();
    };

    const fetchHotspots = async () => {
      setLoaderVisible(true);
      setFadeVisible(errorBanner, false);
      try {
        const response = await fetch(`/api/hotspots/latest?mode=${activeMode}`, { headers: { Accept: 'application/json' } });
        if (!response.ok) {
          throw new Error('Errore risposta');
        }
        const data = await response.json();
        applyData(data);
      } catch (error) {
        setFadeVisible(errorBanner, true);
        setEmptyState();
        setMapLabelVisible(false);
        toggleButtons.forEach((button) => {
          button.disabled = true;
        });
      } finally {
        setLoaderVisible(false);
      }
    };

    toggleButtons.forEach((button) => {
      button.addEventListener('click', () => {
        if (button.disabled) {
          return;
        }
        toggleButtons.forEach((btn) => btn.classList.remove('is-active'));
        button.classList.add('is-active');
        activeMode = button.dataset.mode || 'all';
        fetchHotspots();
      });
    });

    fetchHotspots();
  </script>
  <script type="application/ld+json" nonce="{{ csp_nonce() }}">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "Cos‚Äô√® un hotspot termico?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "√à un‚Äôanomalia termica rilevata dai satelliti che segnala una possibile area pi√π calda del contesto circostante."
          }
        },
        {
          "@type": "Question",
          "name": "Gli hotspot indicano un‚Äôeruzione imminente?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "No. Gli hotspot sono indicatori di attivit√† superficiale e non costituiscono una previsione di eventi eruttivi."
          }
        },
        {
          "@type": "Question",
          "name": "Ogni quanto vengono aggiornati i dati?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "I dati FIRMS si aggiornano a ogni nuovo passaggio satellitare, tipicamente pi√π volte al giorno."
          }
        },
        {
          "@type": "Question",
          "name": "Qual √® la fonte dei dati?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Le rilevazioni provengono dal sistema NASA FIRMS, basato su osservazioni satellitari VIIRS e MODIS."
          }
        }
      ]
    }
  </script>
{% endblock %}
