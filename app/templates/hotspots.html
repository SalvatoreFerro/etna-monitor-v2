{% extends "layout.html" %}

{% block head_extra %}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    .hotspots-header {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      margin: var(--space-6) 0 var(--space-5);
    }

    .hotspots-header h1 {
      margin-bottom: 0;
    }

    .hotspots-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .hotspots-note {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.7));
      border: 1px solid rgba(148, 163, 184, 0.15);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .hotspots-note strong {
      color: var(--color-text);
    }

    .hotspots-grid {
      display: grid;
      gap: var(--space-6);
    }

    .hotspots-panel {
      background: var(--color-surface);
      border-radius: var(--radius-xl);
      padding: var(--space-5);
      border: 1px solid rgba(148, 163, 184, 0.1);
      box-shadow: var(--shadow-lg);
    }

    .hotspots-status {
      display: grid;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .hotspots-kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--space-4);
    }

    .hotspots-kpi {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .hotspots-kpi span {
      color: var(--color-text-secondary);
      font-size: var(--font-size-xs);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .hotspots-kpi strong {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
    }

    .hotspots-message {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(30, 41, 59, 0.6);
      color: var(--color-text-secondary);
    }

    .hotspots-banner {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #fecaca;
      font-size: var(--font-size-sm);
    }

    .hotspots-map-shell {
      position: relative;
    }

    #hotspots-map {
      width: 100%;
      height: 420px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .hotspots-map-stack {
      display: grid;
      gap: var(--space-4);
    }

    .hotspots-legend {
      display: grid;
      gap: var(--space-2);
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      background: rgba(15, 23, 42, 0.65);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .legend-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }

    .legend-dot--high {
      background: #ef4444;
    }

    .legend-dot--mid {
      background: #f97316;
    }

    .legend-dot--low {
      background: #facc15;
    }

    .hotspots-loader {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: var(--space-3);
      background: rgba(15, 23, 42, 0.75);
      border-radius: var(--radius-lg);
      z-index: 2;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .hotspots-loader.is-visible {
      opacity: 1;
      pointer-events: auto;
    }

    .loader-ring {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 3px solid rgba(148, 163, 184, 0.25);
      border-top-color: #38bdf8;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .hotspots-list {
      display: grid;
      gap: var(--space-4);
    }

    .hotspots-card {
      border-radius: var(--radius-lg);
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.18);
      padding: var(--space-4);
      display: grid;
      gap: var(--space-3);
      cursor: pointer;
      transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
    }

    .hotspots-card:hover,
    .hotspots-card.is-active {
      transform: translateY(-2px);
      border-color: rgba(56, 189, 248, 0.5);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.4);
    }

    .hotspots-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
    }

    .hotspots-card-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
    }

    .hotspots-pill {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2xs);
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: var(--font-size-xs);
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #0f172a;
      background: #facc15;
    }

    .hotspots-pill--mid {
      background: #fb923c;
    }

    .hotspots-pill--high {
      background: #f87171;
      color: #0f172a;
    }

    .hotspots-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--space-3);
      font-size: var(--font-size-sm);
    }

    .hotspots-card-grid span {
      color: var(--color-text-secondary);
      display: block;
      font-size: var(--font-size-xs);
      margin-bottom: 0.2rem;
    }

    .hotspots-card a {
      color: #7dd3fc;
      text-decoration: none;
      font-size: var(--font-size-xs);
    }

    .hotspots-fade {
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.35s ease, transform 0.35s ease;
    }

    .hotspots-fade.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    .hotspots-empty {
      padding: var(--space-5);
      border-radius: var(--radius-lg);
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: var(--color-text-secondary);
      text-align: center;
    }

    .hotspots-disclaimer {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      line-height: 1.6;
    }

    @media (max-width: 900px) {
      #hotspots-map {
        height: 340px;
      }
    }

    @media (max-width: 768px) {
      #hotspots-map {
        height: 300px;
      }

      .hotspots-card-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <section class="container container--wide">
    <div class="hotspots-header">
      <h1>Anomalie termiche satellitari (Etna)</h1>
      <p class="muted">Dati NASA FIRMS • aggiornamento automatico • segnale indipendente dal tremore</p>
      <div class="hotspots-note">
        <strong>Cosa significa</strong>
        <span>
          Un hotspot è un pixel satellitare con temperatura anomala. Non è una previsione e non identifica con
          certezza una bocca eruttiva.
        </span>
      </div>
    </div>

    <div class="hotspots-status">
      <div class="hotspots-kpis hotspots-fade" id="hotspots-kpis">
        <div class="hotspots-kpi">
          <span>Ultimo aggiornamento</span>
          <strong id="hotspots-updated">—</strong>
        </div>
        <div class="hotspots-kpi">
          <span>Hotspot rilevati</span>
          <strong id="hotspots-count">—</strong>
        </div>
      </div>
      <div class="hotspots-message hotspots-fade" id="hotspots-message" hidden>
        Nessuna anomalia rilevata nelle ultime 24h.
      </div>
      <div class="hotspots-banner hotspots-fade" id="hotspots-error" hidden>
        Errore nel recupero dati satellitari.
      </div>
    </div>

    <div class="hotspots-grid">
      <div class="hotspots-panel">
        <div class="hotspots-map-stack">
          <div class="hotspots-map-shell">
            <div class="hotspots-loader" id="hotspots-loader">
              <div class="loader-ring" aria-hidden="true"></div>
              <div class="muted">Aggiornamento dati satellitari in corso…</div>
            </div>
            <div id="hotspots-map" aria-label="Mappa hotspot termici Etna"></div>
          </div>
          <div class="hotspots-legend">
            <div class="legend-row"><span class="legend-dot legend-dot--high"></span> Intensità alta</div>
            <div class="legend-row"><span class="legend-dot legend-dot--mid"></span> Intensità media</div>
            <div class="legend-row"><span class="legend-dot legend-dot--low"></span> Intensità bassa</div>
            <div>Ogni punto = area (pixel) ~375 m</div>
          </div>
        </div>
      </div>

      <div class="hotspots-panel">
        <div class="hotspots-list" id="hotspots-list"></div>
      </div>
    </div>

    <div class="hotspots-panel" style="margin-top: var(--space-6);">
      <p class="hotspots-disclaimer">
        Disclaimer: i dati FIRMS sono indicativi e servono per monitoraggio ambientale. Non rappresentano una
        previsione né una conferma certa di attività eruttiva.
      </p>
    </div>
  </section>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script nonce="{{ csp_nonce() }}">
    const mapCenter = { lat: 37.75, lon: 15.0 };

    const loader = document.getElementById('hotspots-loader');
    const message = document.getElementById('hotspots-message');
    const errorBanner = document.getElementById('hotspots-error');
    const updatedEl = document.getElementById('hotspots-updated');
    const countEl = document.getElementById('hotspots-count');
    const listEl = document.getElementById('hotspots-list');
    const kpisEl = document.getElementById('hotspots-kpis');

    const numberFormat = new Intl.NumberFormat('it-IT', { maximumFractionDigits: 2 });

    const map = window.L
      ? L.map('hotspots-map', { scrollWheelZoom: false, zoomControl: true }).setView(
          [mapCenter.lat, mapCenter.lon],
          11
        )
      : null;

    if (map) {
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        maxZoom: 16,
      }).addTo(map);
    }

    const markersLayer = map ? L.layerGroup().addTo(map) : null;

    const setLoaderVisible = (visible) => {
      if (!loader) {
        return;
      }
      loader.classList.toggle('is-visible', visible);
    };

    const setFadeVisible = (element, visible) => {
      if (!element) {
        return;
      }
      element.hidden = !visible;
      requestAnimationFrame(() => {
        element.classList.toggle('is-visible', visible);
      });
    };

    const markerColor = (brightness) => {
      if (brightness == null) {
        return '#facc15';
      }
      if (brightness >= 340) {
        return '#ef4444';
      }
      if (brightness >= 325) {
        return '#f97316';
      }
      return '#facc15';
    };

    const intensityLabel = (brightness, unit) => {
      if (brightness == null) {
        return '—';
      }
      return `${numberFormat.format(brightness)} ${unit || ''}`.trim();
    };

    const frpLabel = (frp) => (frp == null ? '—' : `${numberFormat.format(frp)} MW`);

    const clearList = () => {
      if (listEl) {
        listEl.innerHTML = '';
      }
    };

    const setEmptyState = () => {
      clearList();
      if (listEl) {
        const empty = document.createElement('div');
        empty.className = 'hotspots-empty hotspots-fade is-visible';
        empty.textContent = 'Nessuna anomalia rilevata nelle ultime 24h.';
        listEl.appendChild(empty);
      }
    };

    const updateMarkers = (items) => {
      if (!markersLayer || !map) {
        return { markerMap: new Map() };
      }
      markersLayer.clearLayers();
      const markerMap = new Map();
      const bounds = [];

      items.forEach((item, index) => {
        const brightness = item?.intensity?.brightness ?? null;
        const color = markerColor(brightness);
        const marker = L.circleMarker([item.lat, item.lon], {
          radius: 7,
          color,
          fillColor: color,
          weight: 2,
          fillOpacity: 0.8,
        });

        const tooltip = `${intensityLabel(brightness, item?.intensity?.unit)} • ${frpLabel(
          item?.intensity?.frp
        )}`;
        marker.bindTooltip(tooltip, { direction: 'top', opacity: 0.9 });

        const popup = [
          `<strong>Intensità:</strong> ${intensityLabel(brightness, item?.intensity?.unit)}`,
          `<strong>FRP:</strong> ${frpLabel(item?.intensity?.frp)}`,
          `<strong>Confidence:</strong> ${item.confidence}`,
          `<strong>Satellite:</strong> ${item.satellite}`,
          `<strong>Status:</strong> ${item.status}`,
          `<strong>Time UTC:</strong> ${item.time_utc}`,
          `<a href="${item.maps_url}" target="_blank" rel="noopener">Apri su Google Maps</a>`,
        ].join('<br>');
        marker.bindPopup(popup);
        marker.addTo(markersLayer);
        markerMap.set(index, marker);
        bounds.push([item.lat, item.lon]);
      });

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [24, 24] });
      } else {
        map.setView([mapCenter.lat, mapCenter.lon], 11, { animate: false });
      }

      return { markerMap };
    };

    const renderList = (items, markerMap) => {
      if (!listEl) {
        return;
      }
      listEl.innerHTML = '';

      items.forEach((item, index) => {
        const brightness = item?.intensity?.brightness ?? null;
        const card = document.createElement('div');
        card.className = 'hotspots-card hotspots-fade';
        const colorClass = brightness >= 340 ? 'hotspots-pill--high' : brightness >= 325 ? 'hotspots-pill--mid' : '';
        const pillText = brightness >= 340 ? 'Alta' : brightness >= 325 ? 'Media' : 'Bassa';

        card.innerHTML = `
          <div class="hotspots-card-header">
            <div class="hotspots-card-title">${item.time_utc}</div>
            <span class="hotspots-pill ${colorClass}">${pillText}</span>
          </div>
          <div class="hotspots-card-grid">
            <div>
              <span>Intensità</span>
              ${intensityLabel(brightness, item?.intensity?.unit)}
            </div>
            <div>
              <span>FRP</span>
              ${frpLabel(item?.intensity?.frp)}
            </div>
            <div>
              <span>Confidence</span>
              ${item.confidence}
            </div>
            <div>
              <span>Satellite</span>
              ${item.satellite}
            </div>
            <div>
              <span>Status</span>
              ${item.status}
            </div>
          </div>
          <div>
            <a href="${item.maps_url}" target="_blank" rel="noopener">Apri su Google Maps</a>
          </div>
        `;

        const marker = markerMap.get(index);
        const defaultStyle = marker
          ? {
              radius: marker.options.radius,
              weight: marker.options.weight,
              fillOpacity: marker.options.fillOpacity,
            }
          : null;

        const highlightMarker = () => {
          if (!marker) {
            return;
          }
          marker.setStyle({ radius: 10, weight: 3, fillOpacity: 1 });
          card.classList.add('is-active');
        };

        const resetMarker = () => {
          if (!marker || !defaultStyle) {
            return;
          }
          marker.setStyle(defaultStyle);
          card.classList.remove('is-active');
        };

        card.addEventListener('mouseenter', highlightMarker);
        card.addEventListener('mouseleave', resetMarker);
        card.addEventListener('click', (event) => {
          if (event.target.closest('a')) {
            return;
          }
          if (marker && map) {
            map.setView([item.lat, item.lon], 13, { animate: true });
            marker.openPopup();
          }
        });

        listEl.appendChild(card);
        requestAnimationFrame(() => {
          card.classList.add('is-visible');
        });
      });
    };

    const applyData = (data) => {
      const items = Array.isArray(data.items) ? data.items : [];
      const sorted = [...items].sort((a, b) => {
        const brightnessA = a?.intensity?.brightness ?? 0;
        const brightnessB = b?.intensity?.brightness ?? 0;
        return brightnessB - brightnessA;
      });

      updatedEl.textContent = data.updated_at || 'Non disponibile';
      countEl.textContent = numberFormat.format(data.count ?? sorted.length ?? 0);

      setFadeVisible(kpisEl, true);

      if (!data.available || sorted.length === 0) {
        setFadeVisible(message, true);
        setEmptyState();
        if (markersLayer) {
          markersLayer.clearLayers();
        }
        return;
      }

      setFadeVisible(message, false);

      const { markerMap } = updateMarkers(sorted);
      renderList(sorted, markerMap);
    };

    const fetchHotspots = async () => {
      setLoaderVisible(true);
      setFadeVisible(errorBanner, false);
      try {
        const response = await fetch('/api/hotspots/latest', { headers: { Accept: 'application/json' } });
        if (!response.ok) {
          throw new Error('Errore risposta');
        }
        const data = await response.json();
        applyData(data);
      } catch (error) {
        setFadeVisible(errorBanner, true);
        setEmptyState();
      } finally {
        setLoaderVisible(false);
      }
    };

    fetchHotspots();
  </script>
{% endblock %}
