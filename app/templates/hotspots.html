{% extends "layout.html" %}

{% block head_extra %}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    .hotspots-header {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      margin: var(--space-6) 0 var(--space-5);
    }

    .hotspots-header h1 {
      margin-bottom: 0;
    }

    .hotspots-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .hotspots-note {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.7));
      border: 1px solid rgba(148, 163, 184, 0.15);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .hotspots-note strong {
      color: var(--color-text);
    }

    .hotspots-grid {
      display: grid;
      gap: var(--space-6);
    }

    .hotspots-panel {
      background: var(--color-surface);
      border-radius: var(--radius-xl);
      padding: var(--space-5);
      border: 1px solid rgba(148, 163, 184, 0.1);
      box-shadow: var(--shadow-lg);
    }

    .hotspots-kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
    }

    .hotspots-kpi {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .hotspots-kpi span {
      color: var(--color-text-secondary);
      font-size: var(--font-size-xs);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .hotspots-kpi strong {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
    }

    .hotspots-status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2xs);
      padding: 0.25rem 0.65rem;
      border-radius: var(--radius-md);
      font-size: var(--font-size-xs);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(148, 163, 184, 0.2);
      color: #e2e8f0;
    }

    .hotspots-status-badge--none {
      background: rgba(148, 163, 184, 0.2);
      color: #e2e8f0;
    }

    .hotspots-status-badge--localized {
      background: rgba(34, 197, 94, 0.2);
      color: #86efac;
    }

    .hotspots-status-badge--persistent {
      background: rgba(234, 179, 8, 0.2);
      color: #fde68a;
    }

    #hotspots-map {
      width: 100%;
      height: 420px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .hotspots-map-stack {
      display: grid;
      gap: var(--space-4);
    }

    .hotspots-legend {
      display: grid;
      gap: var(--space-2);
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      background: rgba(15, 23, 42, 0.65);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .legend-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }

    .legend-dot--new {
      background: #34d399;
    }

    .legend-dot--persistent {
      background: #fbbf24;
    }

    .hotspots-controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-3);
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
    }

    .hotspots-toggle {
      display: inline-flex;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      overflow: hidden;
    }

    .hotspots-toggle button {
      border: none;
      padding: 0.4rem 0.9rem;
      background: transparent;
      color: var(--color-text-secondary);
      font-size: var(--font-size-xs);
      cursor: pointer;
    }

    .hotspots-toggle button.active {
      background: rgba(59, 130, 246, 0.2);
      color: #bfdbfe;
    }

    .hotspots-filter select {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: var(--color-text);
      padding: 0.45rem 0.6rem;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
    }

    .hotspots-table-wrapper {
      overflow-x: auto;
    }

    .hotspots-table {
      width: 100%;
      border-collapse: collapse;
    }

    .hotspots-table th,
    .hotspots-table td {
      padding: var(--space-3);
      text-align: left;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      font-size: var(--font-size-sm);
    }

    .hotspots-table th {
      color: var(--color-text-secondary);
      font-weight: var(--font-weight-semibold);
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(6px);
      z-index: 1;
    }

    .hotspots-table tbody tr:nth-child(even) {
      background: rgba(30, 41, 59, 0.35);
    }

    .hotspots-table tbody tr:hover {
      background: rgba(59, 130, 246, 0.12);
    }

    .hotspots-table a.button-link {
      padding: 0.3rem 0.6rem;
      border-radius: var(--radius-sm);
      background: rgba(59, 130, 246, 0.15);
      color: #bfdbfe;
      text-decoration: none;
      font-size: var(--font-size-xs);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2xs);
    }

    .hotspot-status {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2xs);
      padding: 0.2rem 0.5rem;
      border-radius: var(--radius-md);
      font-size: var(--font-size-xs);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .hotspot-status--new {
      background: rgba(34, 197, 94, 0.2);
      color: #6ee7b7;
    }

    .hotspot-status--persistent {
      background: rgba(234, 179, 8, 0.2);
      color: #fcd34d;
    }

    .hotspots-empty {
      padding: var(--space-5);
      border-radius: var(--radius-lg);
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: var(--color-text-secondary);
    }

    .hotspots-disclaimer {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      #hotspots-map {
        height: 320px;
      }

      .hotspots-controls {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <section class="container container--wide">
    <div class="hotspots-header">
      <h1>Anomalie termiche satellitari (Etna)</h1>
      <p class="muted">Dati NASA FIRMS • aggiornamento automatico • segnale indipendente dal tremore</p>
      <div class="hotspots-note">
        <strong>Cosa significa</strong>
        <span>
          Un hotspot è un pixel satellitare con temperatura anomala. Non è una previsione e non identifica con
          certezza una bocca eruttiva.
        </span>
      </div>
    </div>

    {% if not hotspots.available %}
      <div class="hotspots-panel hotspots-empty">
        <p>In attesa del primo aggiornamento satellitare o dati temporaneamente non disponibili.</p>
      </div>
    {% else %}
      <div class="hotspots-kpis" role="status">
        <div class="hotspots-kpi">
          <span>Ultimo aggiornamento</span>
          <strong>{{ generated_at_display or 'Non disponibile' }}</strong>
        </div>
        <div class="hotspots-kpi">
          <span>Hotspot 24h</span>
          <strong id="hotspots-count">{{ hotspots.count or 0 }}</strong>
        </div>
        <div class="hotspots-kpi">
          <span>Stato</span>
          <strong><span id="hotspots-state" class="hotspots-status-badge">—</span></strong>
        </div>
      </div>

      {% if hotspots.count == 0 %}
        <div class="hotspots-panel hotspots-empty" style="margin-top: var(--space-5);">
          <p>Nessuna anomalia termica rilevata nelle ultime 24h.</p>
        </div>
      {% endif %}

      <div class="hotspots-grid">
        <div class="hotspots-panel">
          <div class="hotspots-map-stack">
            <div id="hotspots-map" aria-label="Mappa hotspot termici Etna"></div>
            <div class="hotspots-legend">
              <div class="legend-row"><span class="legend-dot legend-dot--new"></span> New = hotspot recente</div>
              <div class="legend-row">
                <span class="legend-dot legend-dot--persistent"></span> Persistent = hotspot persistente
              </div>
              <div>Ogni punto = area (pixel) ~375 m</div>
              <div>Confidence: low • nominal • high</div>
            </div>
          </div>
        </div>

        <div class="hotspots-panel">
          {% if items %}
            <div class="hotspots-controls">
              <div class="hotspots-toggle" role="group" aria-label="Filtro stato">
                <button type="button" class="active" data-filter-status="all">Tutti</button>
                <button type="button" data-filter-status="new">Solo nuovi</button>
              </div>
              <div class="hotspots-filter">
                <label for="confidence-filter" class="muted">Confidenza</label>
                <select id="confidence-filter">
                  <option value="all">All</option>
                  <option value="low">low</option>
                  <option value="nominal">nominal</option>
                  <option value="high">high</option>
                </select>
              </div>
            </div>
            <div class="hotspots-table-wrapper">
              <table class="hotspots-table" id="hotspots-table">
                <thead>
                  <tr>
                    <th>Ora (UTC)</th>
                    <th>Confidenza</th>
                    <th>FRP (MW)</th>
                    <th>Brightness (K)</th>
                    <th>Stato</th>
                    <th>Mappa</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in items %}
                    <tr
                      data-status="{{ item.status }}"
                      data-confidence="{{ item.confidence }}"
                      data-time="{{ item.time_utc }}"
                    >
                      <td>{{ item.time_utc }}</td>
                      <td>{{ item.confidence }}</td>
                      <td>
                        {% if item.intensity.frp %}
                          {{ "%.2f"|format(item.intensity.frp) }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td>
                        {% if item.intensity.brightness %}
                          {{ "%.2f"|format(item.intensity.brightness) }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td>
                        <span class="hotspot-status hotspot-status--{{ item.status }}">{{ item.status }}</span>
                      </td>
                      <td>
                        <a class="button-link" href="{{ item.maps_url }}" target="_blank" rel="noopener">
                          Apri su Maps
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="muted">Nessun hotspot disponibile al momento.</p>
          {% endif %}
        </div>
      </div>
    {% endif %}

    <div class="hotspots-panel" style="margin-top: var(--space-6);">
      <p class="hotspots-disclaimer">
        Disclaimer: i dati FIRMS sono indicativi e servono per monitoraggio ambientale. Non rappresentano una
        previsione né una conferma certa di attività eruttiva.
      </p>
    </div>
  </section>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script nonce="{{ csp_nonce() }}">
    const hotspotItems = {{ items | tojson }};
    const mapCenter = {{ map_center | tojson }};
    const mapBounds = {{ map_bounds | tojson }};
    const totalCount = {{ hotspots.count or 0 }};

    const mapContainer = document.getElementById('hotspots-map');
    if (window.L && mapContainer) {
      const map = L.map('hotspots-map', { scrollWheelZoom: false }).setView(
        [mapCenter.lat, mapCenter.lon],
        11
      );
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        maxZoom: 16,
      }).addTo(map);
      map.fitBounds(mapBounds, { padding: [20, 20] });

      hotspotItems.forEach((item) => {
        const marker = L.circleMarker([item.lat, item.lon], {
          radius: item.status === 'new' ? 7 : 5,
          color: item.status === 'new' ? '#34d399' : '#f59e0b',
          fillOpacity: 0.7,
        });
        const details = [
          `<strong>${item.time_utc}</strong>`,
          `Confidenza: ${item.confidence}`,
          item.intensity.frp ? `FRP: ${item.intensity.frp} MW` : null,
          item.intensity.brightness ? `Brightness: ${item.intensity.brightness} K` : null,
          `<a href="${item.maps_url}" target="_blank" rel="noopener">Apri su Maps</a>`,
        ]
          .filter(Boolean)
          .join('<br>');
        marker.bindPopup(details);
        marker.addTo(map);
      });
    }

    const stateBadge = document.getElementById('hotspots-state');
    if (stateBadge) {
      let stateLabel = 'Nessuna anomalia';
      let stateClass = 'hotspots-status-badge--none';
      if (totalCount > 0) {
        const hasPersistent = hotspotItems.some((item) => item.status === 'persistent');
        if (hasPersistent) {
          stateLabel = 'Anomalia persistente';
          stateClass = 'hotspots-status-badge--persistent';
        } else {
          stateLabel = 'Anomalia localizzata';
          stateClass = 'hotspots-status-badge--localized';
        }
      }
      stateBadge.textContent = stateLabel;
      stateBadge.classList.add(stateClass);
    }

    const table = document.getElementById('hotspots-table');
    if (table) {
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const statusButtons = document.querySelectorAll('[data-filter-status]');
      const confidenceFilter = document.getElementById('confidence-filter');

      let currentStatus = 'all';
      let currentConfidence = 'all';

      const applyFilters = () => {
        const filtered = rows.filter((row) => {
          const status = row.dataset.status;
          const confidence = row.dataset.confidence;
          const statusMatch = currentStatus === 'all' || status === currentStatus;
          const confidenceMatch = currentConfidence === 'all' || confidence === currentConfidence;
          return statusMatch && confidenceMatch;
        });

        const sorted = filtered.sort((a, b) => {
          const timeA = a.dataset.time;
          const timeB = b.dataset.time;
          return timeB.localeCompare(timeA);
        });

        tbody.innerHTML = '';
        sorted.forEach((row) => tbody.appendChild(row));
      };

      statusButtons.forEach((button) => {
        button.addEventListener('click', () => {
          statusButtons.forEach((btn) => btn.classList.remove('active'));
          button.classList.add('active');
          currentStatus = button.dataset.filterStatus;
          applyFilters();
        });
      });

      if (confidenceFilter) {
        confidenceFilter.addEventListener('change', (event) => {
          currentConfidence = event.target.value;
          applyFilters();
        });
      }

      applyFilters();
    }
  </script>
{% endblock %}
