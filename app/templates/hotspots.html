{% extends "layout.html" %}
{% set is_authenticated = current_user and current_user.is_authenticated %}
{% set has_telegram = is_authenticated and (current_user.telegram_chat_id or current_user.chat_id) and current_user.telegram_opt_in %}

{% block head_extra %}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    .hotspots-header {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      margin: var(--space-6) 0 var(--space-5);
    }

    .hotspots-header h1 {
      margin-bottom: 0;
      font-size: clamp(1.8rem, 1.2rem + 1.6vw, 2.6rem);
      letter-spacing: -0.02em;
    }

    .hotspots-new-badge {
      align-self: flex-start;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.35);
      background: rgba(14, 116, 144, 0.2);
      color: #bae6fd;
      font-size: 0.75rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .hotspots-subtitle {
      font-size: var(--font-size-md);
      color: var(--color-text);
      max-width: 720px;
    }

    .hotspots-source {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .hotspots-source a {
      color: #7dd3fc;
      text-decoration: none;
    }

    .hotspots-source a:hover {
      text-decoration: underline;
    }

    .hotspots-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .hotspots-meta span {
      padding: 0.2rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.55);
    }

    .hotspots-note {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      padding: var(--space-4) var(--space-5);
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.7));
      border: 1px solid rgba(148, 163, 184, 0.15);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .hotspots-note strong {
      color: var(--color-text);
    }

    .hotspots-callouts {
      display: grid;
      gap: var(--space-3);
      margin-top: var(--space-3);
    }

    .hotspots-callout {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.45);
      display: grid;
      gap: var(--space-2);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .hotspots-callout strong {
      color: var(--color-text);
    }

    .hotspots-telegram-cta {
      color: #7dd3fc;
      text-decoration: none;
      font-weight: 600;
    }

    .hotspots-telegram-cta:hover {
      text-decoration: underline;
    }

    .hotspots-grid {
      display: grid;
      gap: var(--space-6);
    }

    .hotspots-panel {
      background: var(--color-surface);
      border-radius: var(--radius-xl);
      padding: var(--space-5);
      border: 1px solid rgba(148, 163, 184, 0.1);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.35);
    }

    .hotspots-status {
      display: grid;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .hotspots-kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--space-4);
    }

    .hotspots-kpi {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      background: linear-gradient(150deg, rgba(15, 23, 42, 0.85), rgba(30, 41, 59, 0.55));
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      min-height: 96px;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.35s ease, transform 0.35s ease, box-shadow 0.35s ease;
    }

    .hotspots-kpi.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    .hotspots-kpi span {
      color: var(--color-text-secondary);
      font-size: var(--font-size-xs);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .hotspots-kpi strong {
      font-size: clamp(1.3rem, 1.1rem + 0.8vw, 2rem);
      font-weight: var(--font-weight-semibold);
      color: #e2e8f0;
    }

    .hotspots-kpi-note {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      line-height: 1.5;
    }

    .hotspots-message {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(30, 41, 59, 0.6);
      color: var(--color-text-secondary);
    }

    .hotspots-banner {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #fecaca;
      font-size: var(--font-size-sm);
    }

    .hotspots-list {
      display: grid;
      gap: var(--space-4);
    }

    .hotspots-filter {
      display: grid;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(15, 23, 42, 0.7);
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .hotspots-filter-label {
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.65rem;
      color: rgba(148, 163, 184, 0.9);
    }

    .hotspots-toggle {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--space-2);
    }

    .hotspots-toggle-button {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.4);
      color: #e2e8f0;
      padding: var(--space-2) var(--space-3);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .hotspots-toggle-button:hover {
      border-color: rgba(248, 250, 252, 0.6);
      background: rgba(30, 41, 59, 0.6);
    }

    .hotspots-toggle-button.is-active {
      background: rgba(14, 116, 144, 0.85);
      border-color: rgba(34, 211, 238, 0.9);
      color: #fff;
    }

    .hotspots-toggle-button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .hotspots-card {
      border-radius: var(--radius-lg);
      background: linear-gradient(160deg, rgba(15, 23, 42, 0.85), rgba(30, 41, 59, 0.45));
      border: 1px solid rgba(148, 163, 184, 0.18);
      padding: var(--space-4) var(--space-4);
      display: grid;
      gap: var(--space-4);
      cursor: pointer;
      transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease, opacity 0.25s ease;
    }

    .hotspots-card:hover,
    .hotspots-card.is-active {
      transform: translateY(-2px);
      border-color: rgba(56, 189, 248, 0.5);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.4);
    }

    .hotspots-card--peak {
      border-color: rgba(248, 113, 113, 0.6);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.5), 0 0 0 1px rgba(248, 113, 113, 0.15);
    }

    .hotspots-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
    }

    .hotspots-card-title {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .hotspots-card-title strong {
      display: block;
      color: var(--color-text);
      font-weight: var(--font-weight-semibold);
    }

    .hotspots-pill {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2xs);
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: var(--font-size-xs);
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #0f172a;
      background: #facc15;
    }

    .hotspots-pill--mid {
      background: #fb923c;
    }

    .hotspots-pill--high {
      background: #f87171;
      color: #0f172a;
    }

    .hotspots-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--space-3);
      font-size: var(--font-size-sm);
    }

    .hotspots-card-grid span {
      color: var(--color-text-secondary);
      display: block;
      font-size: var(--font-size-xs);
      margin-bottom: 0.2rem;
    }

    .hotspots-card a {
      color: #7dd3fc;
      text-decoration: none;
      font-size: var(--font-size-xs);
    }

    .hotspots-cta {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2xs);
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.6);
      background: rgba(14, 116, 144, 0.2);
      font-weight: var(--font-weight-semibold);
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .hotspots-cta:hover {
      background: rgba(56, 189, 248, 0.22);
      border-color: rgba(125, 211, 252, 0.85);
    }

    .hotspots-fade {
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.35s ease, transform 0.35s ease;
    }

    .hotspots-fade.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    .hotspots-empty {
      padding: var(--space-5);
      border-radius: var(--radius-lg);
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: var(--color-text-secondary);
      text-align: center;
    }

    .hotspots-disclaimer {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      line-height: 1.6;
    }

    .leaflet-popup.hotspots-popup .leaflet-popup-content-wrapper {
      background: rgba(15, 23, 42, 0.95);
      color: var(--color-text);
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.6);
    }

    .leaflet-popup.hotspots-popup .leaflet-popup-tip {
      background: rgba(15, 23, 42, 0.95);
    }

    .hotspots-popup {
      font-size: var(--font-size-sm);
      padding: var(--space-2);
      line-height: 1.5;
    }

    .hotspots-popup-title {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-2);
    }

    .hotspots-popup-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }

    .hotspots-popup-label {
      color: var(--color-text-secondary);
      display: block;
      margin-bottom: 0.15rem;
    }

    .hotspots-popup .hotspots-cta {
      margin-top: var(--space-2);
      font-size: var(--font-size-xs);
    }

    .hotspots-seo {
      display: grid;
      gap: var(--space-5);
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      line-height: 1.6;
    }

    .hotspots-seo h2 {
      margin-bottom: var(--space-2);
      color: var(--color-text);
      font-size: clamp(1.2rem, 1rem + 0.6vw, 1.5rem);
    }

    .hotspots-seo-grid {
      display: grid;
      gap: var(--space-4);
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .hotspots-seo h3 {
      margin-bottom: var(--space-2);
      color: var(--color-text);
      font-size: var(--font-size-sm);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    @media (max-width: 768px) {
      .hotspots-card-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
{% endblock %}

{% block content %}
  {% from "partials/leaflet_map.html" import etna_hotspots_map %}
  <section class="container container--wide">
    <div class="hotspots-header">
      <h1>Hotspot termici satellitari sull‚ÄôEtna</h1>
      <span class="hotspots-new-badge">üõ∞Ô∏è Nuovo: hotspot satellitari in tempo quasi reale</span>
      <p class="hotspots-subtitle">
        Monitoraggio immediato delle anomalie termiche rilevate dai satelliti NASA FIRMS nelle ultime 24 ore.
      </p>
      <p class="hotspots-source">
        Fonte: <a href="https://firms.modaps.eosdis.nasa.gov/" target="_blank" rel="noopener">NASA FIRMS (VIIRS)</a>
      </p>
      <div class="hotspots-meta">
        <span>Fonte: NASA FIRMS</span>
        <span>Aggiornamento automatico</span>
        <span>Copertura 24h</span>
      </div>
      <div class="hotspots-note">
        <strong>Cosa stai vedendo</strong>
        <span>
          Gli hotspot indicano anomalie termiche viste da satellite. Non sono previsioni di eruzione, ma segnali di
          possibile attivit√† superficiale.
        </span>
      </div>
      <div class="hotspots-callouts">
        <div class="hotspots-callout">
          <strong>Avvisi Telegram</strong>
          <span>Gli utenti con Telegram collegato ricevono notifiche in caso di variazioni rilevanti.</span>
          {% if has_telegram %}
            <span>Notifiche hotspot attive via Telegram.</span>
          {% else %}
            {% if is_authenticated %}
              <a
                class="hotspots-telegram-cta"
                href="{{ url_for('dashboard.dashboard_home') }}#alert-settings"
                data-track-event="click_collega_telegram_from_hotspot"
                data-track-location="hotspots"
              >Collega Telegram per non perderti gli aggiornamenti</a>
            {% else %}
              <a
                class="hotspots-telegram-cta"
                href="{{ url_for('auth.login') }}"
                data-track-event="click_collega_telegram_from_hotspot"
                data-track-location="hotspots"
              >Collega Telegram per non perderti gli aggiornamenti</a>
            {% endif %}
          {% endif %}
          <span
            data-track-view="premium_cta_view_from_hotspot"
            data-track-location="hotspots"
          >Con Premium ricevi alert illimitati anche su variazioni hotspot.</span>
        </div>
      </div>
    </div>

    <div class="hotspots-status">
      <div class="hotspots-kpis hotspots-fade" id="hotspots-kpis">
        <div class="hotspots-kpi">
          <span>Ultimo aggiornamento</span>
          <strong id="hotspots-updated">‚Äî</strong>
        </div>
        <div class="hotspots-kpi">
          <span>Hotspot FIRMS (24h)</span>
          <strong id="hotspots-count-all">‚Äî</strong>
          <div class="hotspots-kpi-note" id="hotspots-count-note"></div>
        </div>
        <div class="hotspots-kpi">
          <span>Hotspot significativi</span>
          <strong id="hotspots-count-significant">‚Äî</strong>
          <div class="hotspots-kpi-note">Filtro EtnaMonitor (intensit√† medio-alta).</div>
        </div>
      </div>
      <div class="hotspots-message hotspots-fade" id="hotspots-message" hidden>
        Nessuna anomalia termica significativa nelle ultime 24 ore.
      </div>
      <div class="hotspots-banner hotspots-fade" id="hotspots-error" hidden>
        Errore nel recupero dati satellitari.
      </div>
    </div>

    <div class="hotspots-grid">
      <div class="hotspots-panel">
        {{ etna_hotspots_map(
          'hotspots-map',
          'hotspots-map-label',
          'hotspots-loader',
          'Concentrazione di anomalie termiche nell‚Äôarea sommitale dell‚ÄôEtna'
        ) }}
      </div>

      <div class="hotspots-panel">
        <div class="hotspots-filter">
          <div class="hotspots-filter-label">Visualizzazione</div>
          <div class="hotspots-toggle" role="group" aria-label="Filtro hotspot">
            <button type="button" class="hotspots-toggle-button is-active" data-mode="all">
              Tutti (FIRMS)
            </button>
            <button type="button" class="hotspots-toggle-button" data-mode="significant">
              Significativi
            </button>
          </div>
          <span>Confronta i punti FIRMS con il filtro EtnaMonitor.</span>
        </div>
        <div class="hotspots-list" id="hotspots-list"></div>
      </div>
    </div>

    <div class="hotspots-panel" style="margin-top: var(--space-6);">
      <div class="hotspots-seo">
        <div>
          <h2>Hotspot termici satellitari sull‚ÄôEtna</h2>
          <p>
            Gli hotspot termici sono punti in cui i satelliti rilevano temperature superficiali pi√π elevate del
            contesto circostante. I dati NASA FIRMS aiutano a osservare in modo oggettivo le anomalie termiche sull‚ÄôEtna
            e a seguire l‚Äôevoluzione dell‚Äôattivit√† nel tempo.
          </p>
          <p>
            Queste informazioni sono uno strumento di monitoraggio rapido: indicano possibili aree calde, ma non
            costituiscono una previsione di eventi eruttivi n√© sostituiscono le comunicazioni ufficiali degli enti
            scientifici.
          </p>
          <p>
            La pagina aggiorna automaticamente le rilevazioni satellitari pi√π recenti, offrendo un quadro sintetico
            delle anomalie termiche dell‚ÄôEtna oggi.
          </p>
        </div>
        <div class="hotspots-seo-grid">
          <div>
            <h3>Cos‚Äô√® un hotspot FIRMS</h3>
            <p>
              FIRMS (Fire Information for Resource Management System) combina osservazioni satellitari VIIRS e MODIS
              per individuare anomalie termiche. Un hotspot indica un segnale rilevato, non un evento confermato.
            </p>
          </div>
          <div>
            <h3>Ogni quanto vengono aggiornati i dati satellitari</h3>
            <p>
              I passaggi dei satelliti consentono aggiornamenti pi√π volte al giorno. La disponibilit√† dipende
              dall‚Äôorbita e dalle condizioni atmosferiche.
            </p>
          </div>
          <div>
            <h3>Limiti dell‚Äôosservazione satellitare</h3>
            <p>
              Copertura nuvolosa, fumo o angolo di osservazione possono ridurre la sensibilit√†. I dati vanno letti come
              indicatori di tendenza e non come conferme definitive.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="hotspots-panel" style="margin-top: var(--space-6);">
      <p class="hotspots-disclaimer">
        Disclaimer: i dati FIRMS sono indicativi e servono per monitoraggio ambientale. Non rappresentano una
        previsione n√© una conferma certa di attivit√† eruttiva.
      </p>
    </div>
  </section>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="{{ url_for('static', filename='js/leaflet_common.js') }}?v={{ STATIC_ASSET_VERSION }}"></script>
  <script nonce="{{ csp_nonce() }}">
    if (window.etnaTrackEvent) {
      window.etnaTrackEvent('hotspot_page_view', { location: 'hotspots' });
    }

    const mapCenter = { lat: {{ map_center.lat }}, lon: {{ map_center.lon }} };

    const loader = document.getElementById('hotspots-loader');
    const message = document.getElementById('hotspots-message');
    const errorBanner = document.getElementById('hotspots-error');
    const updatedEl = document.getElementById('hotspots-updated');
    const countAllEl = document.getElementById('hotspots-count-all');
    const countSignificantEl = document.getElementById('hotspots-count-significant');
    const countNoteEl = document.getElementById('hotspots-count-note');
    const listEl = document.getElementById('hotspots-list');
    const kpisEl = document.getElementById('hotspots-kpis');
    const mapLabel = document.getElementById('hotspots-map-label');
    const toggleButtons = document.querySelectorAll('.hotspots-toggle-button');

    const kpiCards = document.querySelectorAll('.hotspots-kpi');

    const numberFormat = new Intl.NumberFormat('it-IT', { maximumFractionDigits: 2 });
    const neutralZoom = 10;

    let rawItems = [];
    let significantItems = [];
    let allItems = [];
    let activeMode = 'all';

    const map =
      window.EtnaLeaflet && window.L
        ? window.EtnaLeaflet.createEtnaMap('hotspots-map', {
            center: [mapCenter.lat, mapCenter.lon],
            zoom: neutralZoom,
            addFirmsBadge: true,
          })
        : null;

    const markersLayer = map ? L.layerGroup().addTo(map) : null;

    const setLoaderVisible = (visible) => {
      if (!loader) {
        return;
      }
      loader.classList.toggle('is-visible', visible);
    };

    const setFadeVisible = (element, visible) => {
      if (!element) {
        return;
      }
      element.hidden = !visible;
      requestAnimationFrame(() => {
        element.classList.toggle('is-visible', visible);
      });
    };

    const setMapLabelVisible = (visible) => {
      if (!mapLabel) {
        return;
      }
      mapLabel.classList.toggle('is-visible', visible);
    };

    const intensityLabel = (brightness, unit) => {
      if (brightness == null) {
        return '‚Äî';
      }
      return `${numberFormat.format(brightness)} ${unit || ''}`.trim();
    };

    const frpLabel = (frp) => (frp == null ? '‚Äî' : `${numberFormat.format(frp)} MW`);

    const relativeTime = (dateString) => {
      if (!dateString) {
        return { label: 'Non disponibile', iso: '' };
      }
      const date = new Date(dateString);
      if (Number.isNaN(date.getTime())) {
        return { label: dateString, iso: dateString };
      }
      const diffMs = date.getTime() - Date.now();
      const rtf = new Intl.RelativeTimeFormat('it', { numeric: 'auto' });
      const diffSeconds = Math.round(diffMs / 1000);
      const absSeconds = Math.abs(diffSeconds);
      if (absSeconds < 60) {
        return { label: rtf.format(diffSeconds, 'second'), iso: dateString };
      }
      const diffMinutes = Math.round(diffSeconds / 60);
      if (Math.abs(diffMinutes) < 60) {
        return { label: rtf.format(diffMinutes, 'minute'), iso: dateString };
      }
      const diffHours = Math.round(diffMinutes / 60);
      if (Math.abs(diffHours) < 24) {
        return { label: rtf.format(diffHours, 'hour'), iso: dateString };
      }
      const diffDays = Math.round(diffHours / 24);
      return { label: rtf.format(diffDays, 'day'), iso: dateString };
    };

    const clearList = () => {
      if (listEl) {
        listEl.innerHTML = '';
      }
    };

    const setEmptyState = (text) => {
      clearList();
      if (listEl) {
        const empty = document.createElement('div');
        empty.className = 'hotspots-empty hotspots-fade is-visible';
        empty.textContent = text || 'Nessuna anomalia rilevata nelle ultime 24 ore. Nessun segnale anomalo rilevante.';
        listEl.appendChild(empty);
      }
    };

    const updateMarkers = (items) => {
      if (!markersLayer || !map || !window.EtnaLeaflet) {
        return { markerMap: new Map() };
      }

      const result = window.EtnaLeaflet.addHotspotsLayer(map, items, {
        layer: markersLayer,
        fitBounds: true,
        maxZoom: 13,
        onMarker: (marker, item) => {
          const brightness = item?.intensity?.brightness ?? null;
          const tooltip = `${intensityLabel(brightness, item?.intensity?.unit)} ‚Ä¢ ${frpLabel(
            item?.intensity?.frp
          )}`;
          marker.bindTooltip(tooltip, { direction: 'top', opacity: 0.9 });

          const timeInfo = relativeTime(item.time_utc);
          const popup = `
            <div class="hotspots-popup">
              <div class="hotspots-popup-title">Anomalia termica rilevata</div>
              <div class="hotspots-popup-grid">
                <div>
                  <span class="hotspots-popup-label">Intensit√†</span>
                  ${intensityLabel(brightness, item?.intensity?.unit)}
                </div>
                <div>
                  <span class="hotspots-popup-label">FRP</span>
                  ${frpLabel(item?.intensity?.frp)}
                </div>
                <div>
                  <span class="hotspots-popup-label">Confidence</span>
                  ${item.confidence}
                </div>
                <div>
                  <span class="hotspots-popup-label">Satellite</span>
                  ${item.satellite}
                </div>
                <div>
                  <span class="hotspots-popup-label">Status</span>
                  ${item.status}
                </div>
                <div>
                  <span class="hotspots-popup-label">Rilevato</span>
                  <span title="${timeInfo.iso}">${timeInfo.label}</span>
                </div>
              </div>
              <a class="hotspots-cta" href="${item.maps_url}" target="_blank" rel="noopener">Apri su Google Maps</a>
            </div>
          `;
          marker.bindPopup(popup, { className: 'hotspots-popup' });
        },
      });

      return { markerMap: result.markerMap };
    };

    const renderList = (items, markerMap, maxBrightness) => {
      if (!listEl) {
        return;
      }
      listEl.innerHTML = '';

      if (items.length === 0) {
        const emptyText =
          activeMode === 'significant'
            ? 'Nessun hotspot significativo nelle ultime 24 ore.'
            : 'Nessun hotspot FIRMS nelle ultime 24 ore.';
        setEmptyState(emptyText);
        return;
      }

      items.forEach((item, index) => {
        const brightness = item?.intensity?.brightness ?? null;
        const card = document.createElement('div');
        const isPeak = maxBrightness != null && brightness === maxBrightness;
        card.className = `hotspots-card hotspots-fade${isPeak ? ' hotspots-card--peak' : ''}`;
        const colorClass = brightness >= 340 ? 'hotspots-pill--high' : brightness >= 325 ? 'hotspots-pill--mid' : '';
        const pillText = brightness >= 340 ? 'Alta' : brightness >= 325 ? 'Media' : 'Bassa';
        const pillTitle = `Intensit√† ${pillText.toLowerCase()}`;
        const timeInfo = relativeTime(item.time_utc);

        card.innerHTML = `
          <div class="hotspots-card-header">
            <div class="hotspots-card-title">
              Rilevato
              <strong title="${timeInfo.iso}">${timeInfo.label}</strong>
            </div>
            <span class="hotspots-pill ${colorClass}" title="${pillTitle}" aria-label="${pillTitle}">${pillText}</span>
          </div>
          <div class="hotspots-card-grid">
            <div>
              <span>Intensit√†</span>
              ${intensityLabel(brightness, item?.intensity?.unit)}
            </div>
            <div>
              <span>FRP</span>
              ${frpLabel(item?.intensity?.frp)}
            </div>
            <div>
              <span>Confidence</span>
              ${item.confidence}
            </div>
            <div>
              <span>Satellite</span>
              ${item.satellite}
            </div>
            <div>
              <span>Status</span>
              ${item.status}
            </div>
          </div>
          <div>
            <a class="hotspots-cta" href="${item.maps_url}" target="_blank" rel="noopener">Apri su Google Maps</a>
          </div>
        `;

        const marker = markerMap.get(index);
        const defaultStyle = marker
          ? {
              radius: marker.options.radius,
              weight: marker.options.weight,
              fillOpacity: marker.options.fillOpacity,
            }
          : null;

        const highlightMarker = () => {
          if (!marker) {
            return;
          }
          marker.setStyle({ radius: 10, weight: 3, fillOpacity: 1 });
          card.classList.add('is-active');
        };

        const resetMarker = () => {
          if (!marker || !defaultStyle) {
            return;
          }
          marker.setStyle(defaultStyle);
          card.classList.remove('is-active');
        };

        card.addEventListener('mouseenter', highlightMarker);
        card.addEventListener('mouseleave', resetMarker);
        card.addEventListener('click', (event) => {
          if (event.target.closest('a')) {
            return;
          }
          if (marker && map) {
            map.setView([item.lat, item.lon], 13, { animate: true });
            marker.openPopup();
          }
        });

        listEl.appendChild(card);
        requestAnimationFrame(() => {
          card.classList.add('is-visible');
        });
      });
    };

    const renderHotspots = () => {
      const filtered = allItems;
      const maxBrightness = allItems.reduce((max, item) => {
        const brightness = item?.intensity?.brightness ?? 0;
        return brightness > max ? brightness : max;
      }, 0);
      const { markerMap } = updateMarkers(filtered);
      renderList(filtered, markerMap, maxBrightness || null);
    };

    const applyData = (data) => {
      const raw = Array.isArray(data.items_24h_raw) ? data.items_24h_raw : Array.isArray(data.items) ? data.items : [];
      const significant = Array.isArray(data.items_24h_significant) ? data.items_24h_significant : raw;
      const activeItems = activeMode === 'significant' ? significant : raw;
      const sorted = [...activeItems].sort((a, b) => {
        const brightnessA = a?.intensity?.brightness ?? 0;
        const brightnessB = b?.intensity?.brightness ?? 0;
        return brightnessB - brightnessA;
      });

      const updateInfo = relativeTime(data.last_fetch_at);
      updatedEl.textContent = updateInfo.label;
      updatedEl.title = updateInfo.iso;
      const totalCount = data.count_24h_raw ?? data.count_all ?? data.count_24h ?? raw.length ?? 0;
      const significantCount = data.count_24h_significant ?? data.count_significant ?? significant.length ?? 0;
      const lastFetchCount = data.last_fetch_count ?? 0;
      countAllEl.textContent = numberFormat.format(totalCount);
      countSignificantEl.textContent = numberFormat.format(significantCount);
      if (countNoteEl) {
        if (totalCount > 0) {
          if (lastFetchCount === 0 && data.last_nonzero_at) {
            const lastNonzero = relativeTime(data.last_nonzero_at);
            countNoteEl.textContent = `Ultimo passaggio satellitare: 0 hotspot ‚Äî ultimo hotspot rilevato: ${lastNonzero.label}`;
            countNoteEl.title = lastNonzero.iso || '';
          } else if (significantCount === 0) {
            countNoteEl.textContent = 'Hotspot deboli o poco significativi presenti.';
            countNoteEl.title = '';
          } else {
            countNoteEl.textContent = 'Attivit√† termica superficiale rilevata dai satelliti.';
            countNoteEl.title = '';
          }
        } else {
          countNoteEl.textContent = 'Nessuna anomalia termica nelle ultime 24 ore.';
          countNoteEl.title = '';
        }
      }
      toggleButtons.forEach((button) => {
        button.disabled = totalCount === 0 && button.dataset.mode === 'significant';
      });

      setFadeVisible(kpisEl, true);
      kpiCards.forEach((card, index) => {
        setTimeout(() => card.classList.add('is-visible'), 60 * index);
      });

      rawItems = raw;
      significantItems = significant;
      allItems = sorted;
      setMapLabelVisible(totalCount > 0);

      if (!data.available || totalCount === 0 || sorted.length === 0) {
        setFadeVisible(message, true);
        if (totalCount === 0) {
          setEmptyState('Nessuna anomalia termica nelle ultime 24 ore.');
        } else if (activeMode === 'significant') {
          setEmptyState('Hotspot deboli o poco significativi presenti.');
        } else {
          setEmptyState('Nessuna anomalia termica nelle ultime 24 ore.');
        }
        if (markersLayer) {
          markersLayer.clearLayers();
        }
        if (map) {
          map.setView([mapCenter.lat, mapCenter.lon], neutralZoom, { animate: false });
        }
        return;
      }

      setFadeVisible(message, false);

      renderHotspots();
    };

    const fetchHotspots = async () => {
      setLoaderVisible(true);
      setFadeVisible(errorBanner, false);
      try {
        const response = await fetch(`/api/hotspots/latest?mode=${activeMode}`, { headers: { Accept: 'application/json' } });
        if (!response.ok) {
          throw new Error('Errore risposta');
        }
        const data = await response.json();
        applyData(data);
      } catch (error) {
        setFadeVisible(errorBanner, true);
        setEmptyState();
        setMapLabelVisible(false);
        toggleButtons.forEach((button) => {
          button.disabled = true;
        });
      } finally {
        setLoaderVisible(false);
      }
    };

    toggleButtons.forEach((button) => {
      button.addEventListener('click', () => {
        if (button.disabled) {
          return;
        }
        toggleButtons.forEach((btn) => btn.classList.remove('is-active'));
        button.classList.add('is-active');
        activeMode = button.dataset.mode || 'all';
        fetchHotspots();
      });
    });

    fetchHotspots();
  </script>
  <script type="application/ld+json" nonce="{{ csp_nonce() }}">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "Cos‚Äô√® un hotspot termico?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "√à un‚Äôanomalia termica rilevata dai satelliti che segnala una possibile area pi√π calda del contesto circostante."
          }
        },
        {
          "@type": "Question",
          "name": "Gli hotspot indicano un‚Äôeruzione imminente?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "No. Gli hotspot sono indicatori di attivit√† superficiale e non costituiscono una previsione di eventi eruttivi."
          }
        },
        {
          "@type": "Question",
          "name": "Ogni quanto vengono aggiornati i dati?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "I dati FIRMS si aggiornano a ogni nuovo passaggio satellitare, tipicamente pi√π volte al giorno."
          }
        },
        {
          "@type": "Question",
          "name": "Qual √® la fonte dei dati?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Le rilevazioni provengono dal sistema NASA FIRMS, basato su osservazioni satellitari VIIRS e MODIS."
          }
        }
      ]
    }
  </script>
{% endblock %}
