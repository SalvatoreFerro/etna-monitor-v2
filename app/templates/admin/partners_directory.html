{% extends 'admin/base.html' %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}?v={{ STATIC_ASSET_VERSION }}">
{% endblock %}

{% block title %}Directory partner{% endblock %}

{% block admin_content %}
<section class="admin-section">
  <header class="admin-section__header">
    <h1><i class="fas fa-handshake"></i> Directory Partner</h1>
    <p class="muted">Gestisci candidature, approvazioni e rinnovi del network EtnaMonitor.</p>
  </header>

  {% set total_partners = partners|length %}
  {% set approved_partners = partners|selectattr('status', 'equalto', 'approved')|list|length %}
  {% set pending_partners = partners|selectattr('status', 'equalto', 'pending')|list|length %}

  <div class="admin-metrics admin-metrics--compact">
    <div class="admin-metric">
      <span class="admin-metric__label">Partner totali</span>
      <span class="admin-metric__value">{{ total_partners }}</span>
    </div>
    <div class="admin-metric">
      <span class="admin-metric__label">Approvati</span>
      <span class="admin-metric__value">{{ approved_partners }}</span>
    </div>
    <div class="admin-metric">
      <span class="admin-metric__label">In revisione</span>
      <span class="admin-metric__value">{{ pending_partners }}</span>
    </div>
  </div>

  <div class="admin-grid">
    <section class="admin-card">
      <h2>Stato categorie</h2>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Slot</th>
            <th>Attivi</th>
            <th>Disponibili</th>
          </tr>
        </thead>
        <tbody>
          {% for category in categories %}
            {% set used, max_slots = usage.get(category.id, (0, category.max_slots)) %}
            <tr>
              <td>{{ category.name }}</td>
              <td>
                <form method="post" action="{{ url_for('admin.partners_update_slots', category_id=category.id) }}" class="slot-editor">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  <input type="number" name="max_slots" class="admin-input admin-input--inline" min="{{ used if used > 0 else 1 }}" value="{{ max_slots }}" aria-label="Aggiorna slot per {{ category.name }}" />
                  <button type="submit" class="btn btn-secondary btn-sm">Aggiorna</button>
                </form>
              </td>
              <td>
                <span class="badge {{ 'badge-danger' if used >= max_slots else 'badge-success' }}">{{ used }}</span>
              </td>
              <td>{{ (max_slots - used) if (max_slots - used) > 0 else 0 }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section class="admin-card">
      <h2>Nuovo partner</h2>
      <form method="post" action="{{ url_for('admin.partners_create') }}" class="admin-form partner-admin-form" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="submit_action" value="draft" data-submit-field />
        <div class="form-grid">
          <label class="admin-field">
            <span class="admin-field__label">Nome *</span>
            <input type="text" class="admin-input" name="name" required maxlength="180" placeholder="Nome partner" />
          </label>
          <label class="admin-field">
            <span class="admin-field__label">Categoria *</span>
            <select name="category_id" class="admin-input" required>
              {% for category in categories %}
                <option value="{{ category.id }}" data-slug="{{ category.slug }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
        <label class="admin-field">
          <span class="admin-field__label">Descrizione breve</span>
          <input type="text" class="admin-input" name="short_desc" maxlength="280" placeholder="Titolo sintetico visibile in elenco" />
        </label>
        <label class="admin-field">
          <span class="admin-field__label">Descrizione completa</span>
          <textarea name="long_desc" rows="4" class="admin-input" placeholder="Racconta i servizi, valori e punti di forza"></textarea>
        </label>
        <div class="form-grid">
          <label class="admin-field"><span class="admin-field__label">Sito</span><input type="url" class="admin-input" name="website_url" placeholder="https://" /></label>
          <label class="admin-field"><span class="admin-field__label">Email</span><input type="email" class="admin-input" name="email" placeholder="contatto@email" /></label>
          <label class="admin-field"><span class="admin-field__label">Telefono</span><input type="text" class="admin-input" name="phone" placeholder="Numero principale" /></label>
          <label class="admin-field"><span class="admin-field__label">WhatsApp</span><input type="text" class="admin-input" name="whatsapp" placeholder="Numero WhatsApp" /></label>
        </div>
        <div class="form-grid">
          <label class="admin-field"><span class="admin-field__label">Instagram</span><input type="url" class="admin-input" name="instagram" placeholder="https://instagram.com/..." /></label>
          <label class="admin-field"><span class="admin-field__label">Facebook</span><input type="url" class="admin-input" name="facebook" placeholder="https://facebook.com/..." /></label>
          <label class="admin-field"><span class="admin-field__label">TikTok</span><input type="url" class="admin-input" name="tiktok" placeholder="https://tiktok.com/@..." /></label>
        </div>
        <div class="form-grid">
          <label class="admin-field"><span class="admin-field__label">Indirizzo</span><input type="text" class="admin-input" name="address" placeholder="Via e numero civico" /></label>
          <label class="admin-field"><span class="admin-field__label">Città</span><input type="text" class="admin-input" name="city" placeholder="Comune" /></label>
        </div>

        <div class="admin-field partner-upload">
          <span class="admin-field__label">Logo profilo partner</span>
          <div class="upload-dropzone" data-dropzone tabindex="0" role="button" aria-label="Carica logo partner">
            <input type="file" name="logo" accept="image/*" class="upload-dropzone__input" data-dropzone-input />
            <div class="upload-dropzone__content">
              <i class="fas fa-cloud-upload-alt"></i>
              <p data-dropzone-label>Trascina qui l'immagine o clicca per selezionarla.</p>
            </div>
            <img data-dropzone-preview class="upload-dropzone__preview" alt="Anteprima logo" hidden />
          </div>
          <small class="muted">
            Formati supportati: PNG, JPG, WebP e SVG. Max {{ (max_upload_bytes / (1024 * 1024)) | round(1) }}MB.
          </small>
        </div>

        {% for category in categories %}
          {% set fields = category_fields.get(category.slug, []) %}
          {% if fields %}
            <fieldset class="category-extra" data-category-fields="{{ category.slug }}" hidden>
              <legend>Dati specifici per {{ category.name }}</legend>
              {% for field in fields %}
                {% set field_type = field.get('type', 'text') %}
                <label>
                  {{ field.get('label') }}{% if field.get('required') %} *{% endif %}
                  {% if field_type == 'textarea' %}
                    <textarea name="{{ field.get('name') }}" rows="{{ field.get('rows', 3) }}" {% if field.get('required') %}required{% endif %} placeholder="{{ field.get('placeholder', '') }}"></textarea>
                  {% elif field_type == 'select' %}
                    <select name="{{ field.get('name') }}" {% if field.get('required') %}required{% endif %}>
                      <option value="">Seleziona...</option>
                      {% for option in field.get('options', []) %}
                        <option value="{{ option.get('value') }}">{{ option.get('label') }}</option>
                      {% endfor %}
                    </select>
                  {% else %}
                    <input type="{{ field_type }}" name="{{ field.get('name') }}" {% if field_type == 'number' and field.get('min') is not none %}min="{{ field.get('min') }}"{% endif %} {% if field.get('required') %}required{% endif %} placeholder="{{ field.get('placeholder', '') }}" />
                  {% endif %}
                  {% if field.get('help') %}<small class="muted">{{ field.get('help') }}</small>{% endif %}
                </label>
              {% endfor %}
            </fieldset>
          {% endif %}
        {% endfor %}
        <label class="form-switch">
          <input type="checkbox" name="featured" />
          <span>Evidenzia il partner in homepage</span>
        </label>
        <div class="form-actions" data-submit-controls>
          <button type="submit" name="submit_action" value="draft" class="btn btn-primary" data-submit-action="draft">
            Salva bozza
          </button>
          <button type="submit" name="submit_action" value="publish" class="btn btn-success" data-submit-action="publish">
            Pubblica ora
          </button>
          <div class="form-actions__busy" data-submit-busy hidden role="status" aria-live="polite">
            <span class="form-actions__spinner" aria-hidden="true"></span>
            <span>Invio in corso…</span>
          </div>
        </div>
      </form>
    </section>
  </div>

  <section class="admin-card admin-card--wide">
    <h2>Partner registrati</h2>
    <form method="get" class="admin-form">
      <div class="form-grid">
        <label class="admin-field">
          <span class="admin-field__label">Ricerca</span>
          <input type="search" name="q" class="admin-input" placeholder="Nome, email o sito" value="{{ filters.q }}" />
        </label>
        <label class="admin-field">
          <span class="admin-field__label">Stato</span>
          <select name="status" class="admin-input">
            <option value="">Tutti</option>
            <option value="active" {% if filters.status == 'active' %}selected{% endif %}>Attivi</option>
            {% for status in ['draft', 'pending', 'approved', 'rejected', 'expired', 'disabled'] %}
              <option value="{{ status }}" {% if filters.status == status %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="admin-field">
          <span class="admin-field__label">Categoria</span>
          <select name="category" class="admin-input">
            <option value="">Tutte</option>
            {% for category in categories %}
              <option value="{{ category.id }}" {% if filters.category|int == category.id %}selected{% endif %}>
                {{ category.name }}
              </option>
            {% endfor %}
          </select>
        </label>
        <label class="admin-field">
          <span class="admin-field__label">Ordina</span>
          <select name="order" class="admin-input">
            <option value="created_desc" {% if filters.order == 'created_desc' %}selected{% endif %}>Più recenti</option>
            <option value="created_asc" {% if filters.order == 'created_asc' %}selected{% endif %}>Più vecchi</option>
            <option value="updated_desc" {% if filters.order == 'updated_desc' %}selected{% endif %}>Aggiornati di recente</option>
            <option value="name_asc" {% if filters.order == 'name_asc' %}selected{% endif %}>Nome A-Z</option>
            <option value="name_desc" {% if filters.order == 'name_desc' %}selected{% endif %}>Nome Z-A</option>
            <option value="status" {% if filters.order == 'status' %}selected{% endif %}>Stato</option>
            <option value="category" {% if filters.order == 'category' %}selected{% endif %}>Categoria</option>
          </select>
        </label>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-secondary btn-sm">Filtra</button>
        <a href="{{ url_for('admin.partners_dashboard') }}" class="btn btn-secondary glass btn-sm">Reset</a>
      </div>
    </form>
    <table class="admin-table admin-table--responsive">
      <thead>
        <tr>
          <th>Partner</th>
          <th>Categoria</th>
          <th>Stato</th>
          <th>Ultima sottoscrizione</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody>
        {% for partner in partners %}
          {% set latest = partner.subscriptions[0] if partner.subscriptions else None %}
          <tr>
            <td>
              <strong>{{ partner.name }}</strong>
              <div class="muted">{{ partner.short_desc or '—' }}</div>
            </td>
            <td>{{ partner.category.name }}</td>
            <td>
              <span class="badge badge-status badge-status--{{ partner.status }}">{{ partner.status }}</span>
              {% if partner.featured %}<span class="badge badge-info">Featured</span>{% endif %}
            </td>
            <td>
              {% if latest %}
                <div>Anno {{ latest.year }} – {{ latest.status }}</div>
                <div class="muted">Scade: {{ latest.valid_to }}</div>
              {% else %}
                <span class="muted">Nessuna sottoscrizione</span>
              {% endif %}
            </td>
            <td>
              <div class="partner-actions">
                <a href="{{ url_for('admin.partners_edit', partner_id=partner.id) }}" class="btn btn-secondary glass btn-sm">
                  Modifica
                </a>
                <form method="post" action="{{ url_for('admin.partners_toggle_active', partner_id=partner.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  <button type="submit" class="btn btn-outline-info btn-sm">
                    {{ 'Attiva' if partner.status == 'disabled' else 'Disattiva' }}
                  </button>
                </form>
              </div>

              <form method="post" action="{{ url_for('admin.partners_update_status', partner_id=partner.id) }}" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <select name="action" class="admin-select">
                  <option value="approve">Approva</option>
                  <option value="reject">Rifiuta</option>
                  <option value="disable">Disabilita</option>
                  <option value="expire">Segna scaduto</option>
                </select>
                <button type="submit" class="btn btn-secondary btn-sm">Aggiorna</button>
              </form>

              <form method="post" action="{{ url_for('admin.partners_create_subscription', partner_id=partner.id) }}" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="number" name="year" value="{{ current_year }}" min="2024" class="admin-input admin-input--sm" />
                <input type="number" step="0.01" name="price_eur" class="admin-input admin-input--sm" placeholder="Prezzo" />
                <select name="payment_method" class="admin-select admin-select--sm">
                  {% for method in payment_methods %}
                    <option value="{{ method }}">{{ method }}</option>
                  {% endfor %}
                </select>
                <input type="text" name="payment_ref" placeholder="Rif. pagamento" class="admin-input admin-input--sm" />
                <button type="submit" class="btn btn-primary btn-sm">Attiva &amp; fattura</button>
              </form>

              {% if latest %}
                <form method="post" action="{{ url_for('admin.subscriptions_expire', subscription_id=latest.id) }}" class="inline-form">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  <button type="submit" class="btn btn-danger btn-sm">Segna sottoscrizione scaduta</button>
                </form>
              {% endif %}

              <form method="post" action="{{ url_for('admin.partners_delete', partner_id=partner.id) }}" class="inline-form" onsubmit="return confirm('Eliminare definitivamente {{ partner.name }}?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn btn-outline-danger btn-sm">Elimina</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</section>
{% endblock %}

{% block admin_scripts %}
  {{ super() }}
  <script nonce="{{ csp_nonce() }}">
    (function() {
      const select = document.querySelector('select[name="category_id"]');
      if (!select) {
        return;
      }

      const groups = document.querySelectorAll('[data-category-fields]');
      const captureRequiredState = (control) => {
        if (!control.dataset.originalRequired) {
          control.dataset.originalRequired = control.required ? 'true' : 'false';
        }
      };

      const setGroupState = (group, isActive) => {
        group.hidden = !isActive;
        const controls = group.querySelectorAll('input, select, textarea');
        controls.forEach((control) => {
          captureRequiredState(control);
          const wasRequired = control.dataset.originalRequired === 'true';
          control.disabled = !isActive;
          control.required = isActive && wasRequired;
          if (!isActive) {
            if (control.type === 'checkbox' || control.type === 'radio') {
              control.checked = false;
            }
          }
        });
      };

      const toggleGroups = () => {
        const slug = select.options[select.selectedIndex]?.dataset.slug;
        groups.forEach((group) => {
          const isActive = group.dataset.categoryFields === slug;
          setGroupState(group, isActive);
        });
      };

      select.addEventListener('change', toggleGroups);
      toggleGroups();
    })();

    (function() {
      const dropzone = document.querySelector('[data-dropzone]');
      if (!dropzone) {
        return;
      }

      const input = dropzone.querySelector('[data-dropzone-input]');
      const preview = dropzone.querySelector('[data-dropzone-preview]');
      const label = dropzone.querySelector('[data-dropzone-label]');
      const defaultLabel = label ? label.textContent : '';

      const preventDefaults = (event) => {
        event.preventDefault();
        event.stopPropagation();
      };

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
        dropzone.addEventListener(eventName, preventDefaults, false);
      });

      ['dragenter', 'dragover'].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => dropzone.classList.add('is-dragover'), false);
      });

      ['dragleave', 'drop'].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => dropzone.classList.remove('is-dragover'), false);
      });

      const updatePreview = (file) => {
        if (!label || !preview) {
          return;
        }

        if (!file) {
          label.textContent = defaultLabel;
          preview.setAttribute('hidden', 'hidden');
          preview.removeAttribute('src');
          return;
        }

        if (!(file.type || '').startsWith('image/')) {
          label.textContent = 'Carica un file immagine (PNG, JPG, WebP o SVG).';
          preview.setAttribute('hidden', 'hidden');
          preview.removeAttribute('src');
          return;
        }

        label.textContent = file.name;
        const reader = new FileReader();
        reader.onload = (event) => {
          if (event.target?.result) {
            preview.src = event.target.result;
            preview.removeAttribute('hidden');
          }
        };
        reader.readAsDataURL(file);
      };

      const assignFilesToInput = (files) => {
        if (!input || !files || !files.length) {
          return;
        }
        try {
          const dataTransfer = new DataTransfer();
          Array.from(files).forEach((file) => dataTransfer.items.add(file));
          input.files = dataTransfer.files;
        } catch (error) {
          input.files = files;
        }
        updatePreview(files[0]);
      };

      dropzone.addEventListener('drop', (event) => {
        const files = event.dataTransfer?.files;
        if (files && files.length) {
          assignFilesToInput(files);
        }
      });

      dropzone.addEventListener('click', () => {
        input?.click();
      });

      dropzone.addEventListener('keydown', (event) => {
        if (event.key === ' ' || event.key === 'Enter') {
          event.preventDefault();
          input?.click();
        }
      });

      input?.addEventListener('change', () => {
        if (input.files && input.files.length) {
          updatePreview(input.files[0]);
        } else {
          updatePreview(null);
        }
      });
    })();

    (function() {
      const form = document.querySelector('.partner-admin-form');
      if (!form) {
        return;
      }

      const submitField = form.querySelector('[data-submit-field]');
      const buttons = Array.from(form.querySelectorAll('[data-submit-action]'));
      const busyIndicator = form.querySelector('[data-submit-busy]');

      const setSubmitValue = (value) => {
        if (submitField) {
          submitField.value = value || 'draft';
        }
      };

      buttons.forEach((button) => {
        button.addEventListener('click', () => {
          setSubmitValue(button.dataset.submitAction || button.value || 'draft');
        });
      });

      form.addEventListener('submit', () => {
        const active = document.activeElement;
        if (
          active &&
          active.form === form &&
          active.dataset.submitAction &&
          active !== submitField
        ) {
          setSubmitValue(active.dataset.submitAction);
        }

        if (!submitField?.value && buttons.length) {
          setSubmitValue(buttons[0].dataset.submitAction || buttons[0].value || 'draft');
        }

        if (busyIndicator) {
          busyIndicator.hidden = false;
        }

        form.classList.add('is-submitting');
        buttons.forEach((button) => {
          button.disabled = true;
          button.setAttribute('aria-disabled', 'true');
        });
      });
    })();
  </script>
{% endblock %}
