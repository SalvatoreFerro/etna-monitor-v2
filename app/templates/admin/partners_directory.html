{% extends 'admin/base.html' %}

{% block title %}Directory partner{% endblock %}

{% block admin_content %}
<section class="admin-section">
  <header class="admin-section__header">
    <h1><i class="fas fa-handshake"></i> Directory Partner</h1>
    <p class="muted">Gestisci candidature, approvazioni e rinnovi del network EtnaMonitor.</p>
  </header>

  {% set total_partners = partners|length %}
  {% set approved_partners = partners|selectattr('status', 'equalto', 'approved')|list|length %}
  {% set pending_partners = partners|selectattr('status', 'equalto', 'pending')|list|length %}

  <div class="admin-metrics admin-metrics--compact">
    <div class="admin-metric">
      <span class="admin-metric__label">Partner totali</span>
      <span class="admin-metric__value">{{ total_partners }}</span>
    </div>
    <div class="admin-metric">
      <span class="admin-metric__label">Approvati</span>
      <span class="admin-metric__value">{{ approved_partners }}</span>
    </div>
    <div class="admin-metric">
      <span class="admin-metric__label">In revisione</span>
      <span class="admin-metric__value">{{ pending_partners }}</span>
    </div>
  </div>

  <div class="admin-grid">
    <section class="admin-card">
      <h2>Stato categorie</h2>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Slot</th>
            <th>Attivi</th>
            <th>Disponibili</th>
          </tr>
        </thead>
        <tbody>
          {% for category in categories %}
            {% set used, max_slots = usage.get(category.id, (0, category.max_slots)) %}
            <tr>
              <td>{{ category.name }}</td>
              <td>
                <form method="post" action="{{ url_for('admin.partners_update_slots', category_id=category.id) }}" class="slot-editor">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  <input type="number" name="max_slots" class="admin-input admin-input--inline" min="{{ used if used > 0 else 1 }}" value="{{ max_slots }}" aria-label="Aggiorna slot per {{ category.name }}" />
                  <button type="submit" class="btn btn-secondary btn-sm">Aggiorna</button>
                </form>
              </td>
              <td>
                <span class="badge {{ 'badge-danger' if used >= max_slots else 'badge-success' }}">{{ used }}</span>
              </td>
              <td>{{ (max_slots - used) if (max_slots - used) > 0 else 0 }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section class="admin-card">
      <h2>Nuovo partner</h2>
      <form method="post" action="{{ url_for('admin.partners_create') }}" class="admin-form partner-admin-form" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="form-grid">
          <label class="admin-field">
            <span class="admin-field__label">Nome *</span>
            <input type="text" class="admin-input" name="name" required maxlength="180" placeholder="Nome partner" />
          </label>
          <label class="admin-field">
            <span class="admin-field__label">Categoria *</span>
            <select name="category_id" class="admin-input" required>
              {% for category in categories %}
                <option value="{{ category.id }}" data-slug="{{ category.slug }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
        <label class="admin-field">
          <span class="admin-field__label">Descrizione breve</span>
          <input type="text" class="admin-input" name="short_desc" maxlength="280" placeholder="Titolo sintetico visibile in elenco" />
        </label>
        <label class="admin-field">
          <span class="admin-field__label">Descrizione completa</span>
          <textarea name="long_desc" rows="4" class="admin-input" placeholder="Racconta i servizi, valori e punti di forza"></textarea>
        </label>
        <div class="form-grid">
          <label class="admin-field"><span class="admin-field__label">Sito</span><input type="url" class="admin-input" name="website_url" placeholder="https://" /></label>
          <label class="admin-field"><span class="admin-field__label">Email</span><input type="email" class="admin-input" name="email" placeholder="contatto@email" /></label>
          <label class="admin-field"><span class="admin-field__label">Telefono</span><input type="text" class="admin-input" name="phone" placeholder="Numero principale" /></label>
          <label class="admin-field"><span class="admin-field__label">WhatsApp</span><input type="text" class="admin-input" name="whatsapp" placeholder="Numero WhatsApp" /></label>
        </div>
        <div class="form-grid">
          <label class="admin-field"><span class="admin-field__label">Instagram</span><input type="url" class="admin-input" name="instagram" placeholder="https://instagram.com/..." /></label>
          <label class="admin-field"><span class="admin-field__label">Facebook</span><input type="url" class="admin-input" name="facebook" placeholder="https://facebook.com/..." /></label>
          <label class="admin-field"><span class="admin-field__label">TikTok</span><input type="url" class="admin-input" name="tiktok" placeholder="https://tiktok.com/@..." /></label>
        </div>
        <div class="form-grid">
          <label class="admin-field"><span class="admin-field__label">Indirizzo</span><input type="text" class="admin-input" name="address" placeholder="Via e numero civico" /></label>
          <label class="admin-field"><span class="admin-field__label">Città</span><input type="text" class="admin-input" name="city" placeholder="Comune" /></label>
        </div>

        <div class="admin-field partner-upload">
          <span class="admin-field__label">Logo profilo partner</span>
          <div class="upload-dropzone" data-dropzone tabindex="0" role="button" aria-label="Carica logo partner">
            <input type="file" name="logo" accept="image/*" class="upload-dropzone__input" data-dropzone-input />
            <div class="upload-dropzone__content">
              <i class="fas fa-cloud-upload-alt"></i>
              <p data-dropzone-label>Trascina qui l'immagine o clicca per selezionarla.</p>
            </div>
            <img data-dropzone-preview class="upload-dropzone__preview" alt="Anteprima logo" hidden />
          </div>
          <small class="muted">Formati supportati: PNG, JPG, WebP e SVG.</small>
        </div>

        {% for category in categories %}
          {% set fields = category_fields.get(category.slug, []) %}
          {% if fields %}
            <fieldset class="category-extra" data-category-fields="{{ category.slug }}" hidden>
              <legend>Dati specifici per {{ category.name }}</legend>
              {% for field in fields %}
                {% set field_type = field.get('type', 'text') %}
                <label>
                  {{ field.get('label') }}{% if field.get('required') %} *{% endif %}
                  {% if field_type == 'textarea' %}
                    <textarea name="{{ field.get('name') }}" rows="{{ field.get('rows', 3) }}" {% if field.get('required') %}required{% endif %} placeholder="{{ field.get('placeholder', '') }}"></textarea>
                  {% elif field_type == 'select' %}
                    <select name="{{ field.get('name') }}" {% if field.get('required') %}required{% endif %}>
                      <option value="">Seleziona...</option>
                      {% for option in field.get('options', []) %}
                        <option value="{{ option.get('value') }}">{{ option.get('label') }}</option>
                      {% endfor %}
                    </select>
                  {% else %}
                    <input type="{{ field_type }}" name="{{ field.get('name') }}" {% if field_type == 'number' and field.get('min') is not none %}min="{{ field.get('min') }}"{% endif %} {% if field.get('required') %}required{% endif %} placeholder="{{ field.get('placeholder', '') }}" />
                  {% endif %}
                  {% if field.get('help') %}<small class="muted">{{ field.get('help') }}</small>{% endif %}
                </label>
              {% endfor %}
            </fieldset>
          {% endif %}
        {% endfor %}
        <label class="form-switch">
          <input type="checkbox" name="featured" />
          <span>Evidenzia il partner in homepage</span>
        </label>
        <button type="submit" class="btn btn-primary">Salva bozza</button>
      </form>
    </section>
  </div>

  <section class="admin-card admin-card--wide">
    <h2>Partner registrati</h2>
    <table class="admin-table admin-table--responsive">
      <thead>
        <tr>
          <th>Partner</th>
          <th>Categoria</th>
          <th>Stato</th>
          <th>Ultima sottoscrizione</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody>
        {% for partner in partners %}
          {% set latest = partner.subscriptions[0] if partner.subscriptions else None %}
          <tr>
            <td>
              <strong>{{ partner.name }}</strong>
              <div class="muted">{{ partner.short_desc or '—' }}</div>
            </td>
            <td>{{ partner.category.name }}</td>
            <td>
              <span class="badge badge-status badge-status--{{ partner.status }}">{{ partner.status }}</span>
              {% if partner.featured %}<span class="badge badge-info">Featured</span>{% endif %}
            </td>
            <td>
              {% if latest %}
                <div>Anno {{ latest.year }} – {{ latest.status }}</div>
                <div class="muted">Scade: {{ latest.valid_to }}</div>
              {% else %}
                <span class="muted">Nessuna sottoscrizione</span>
              {% endif %}
            </td>
            <td>
              <form method="post" action="{{ url_for('admin.partners_update_status', partner_id=partner.id) }}" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <select name="action" class="admin-select">
                  <option value="approve">Approva</option>
                  <option value="reject">Rifiuta</option>
                  <option value="disable">Disabilita</option>
                  <option value="expire">Segna scaduto</option>
                </select>
                <button type="submit" class="btn btn-secondary btn-sm">Aggiorna</button>
              </form>

              <form method="post" action="{{ url_for('admin.partners_create_subscription', partner_id=partner.id) }}" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="number" name="year" value="{{ current_year }}" min="2024" class="admin-input admin-input--sm" />
                <input type="number" step="0.01" name="price_eur" class="admin-input admin-input--sm" placeholder="Prezzo" />
                <select name="payment_method" class="admin-select admin-select--sm">
                  {% for method in payment_methods %}
                    <option value="{{ method }}">{{ method }}</option>
                  {% endfor %}
                </select>
                <input type="text" name="payment_ref" placeholder="Rif. pagamento" class="admin-input admin-input--sm" />
                <button type="submit" class="btn btn-primary btn-sm">Attiva &amp; fattura</button>
              </form>

              {% if latest %}
                <form method="post" action="{{ url_for('admin.subscriptions_expire', subscription_id=latest.id) }}" class="inline-form">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                  <button type="submit" class="btn btn-danger btn-sm">Segna sottoscrizione scaduta</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script>
    (function() {
      const select = document.querySelector('select[name="category_id"]');
      if (!select) {
        return;
      }
      const groups = document.querySelectorAll('[data-category-fields]');
      const toggleGroups = () => {
        const slug = select.options[select.selectedIndex]?.dataset.slug;
        groups.forEach(group => {
          group.hidden = group.dataset.categoryFields !== slug;
        });
      };
      select.addEventListener('change', toggleGroups);
      toggleGroups();
    })();

    (function() {
      const dropzone = document.querySelector('[data-dropzone]');
      if (!dropzone) {
        return;
      }

      const input = dropzone.querySelector('[data-dropzone-input]');
      const preview = dropzone.querySelector('[data-dropzone-preview]');
      const label = dropzone.querySelector('[data-dropzone-label]');
      const defaultLabel = label ? label.textContent : '';

      const preventDefaults = (event) => {
        event.preventDefault();
        event.stopPropagation();
      };

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
        dropzone.addEventListener(eventName, preventDefaults, false);
      });

      ['dragenter', 'dragover'].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => dropzone.classList.add('is-dragover'), false);
      });

      ['dragleave', 'drop'].forEach((eventName) => {
        dropzone.addEventListener(eventName, () => dropzone.classList.remove('is-dragover'), false);
      });

      const updatePreview = (file) => {
        if (!label || !preview) {
          return;
        }

        if (!file) {
          label.textContent = defaultLabel;
          preview.setAttribute('hidden', 'hidden');
          preview.removeAttribute('src');
          return;
        }

        if (!(file.type || '').startsWith('image/')) {
          label.textContent = 'Carica un file immagine (PNG, JPG, WebP o SVG).';
          preview.setAttribute('hidden', 'hidden');
          preview.removeAttribute('src');
          return;
        }

        label.textContent = file.name;
        const reader = new FileReader();
        reader.onload = (event) => {
          if (event.target?.result) {
            preview.src = event.target.result;
            preview.removeAttribute('hidden');
          }
        };
        reader.readAsDataURL(file);
      };

      const assignFilesToInput = (files) => {
        if (!input || !files || !files.length) {
          return;
        }
        try {
          const dataTransfer = new DataTransfer();
          Array.from(files).forEach((file) => dataTransfer.items.add(file));
          input.files = dataTransfer.files;
        } catch (error) {
          input.files = files;
        }
        updatePreview(files[0]);
      };

      dropzone.addEventListener('drop', (event) => {
        const files = event.dataTransfer?.files;
        if (files && files.length) {
          assignFilesToInput(files);
        }
      });

      dropzone.addEventListener('click', () => {
        input?.click();
      });

      dropzone.addEventListener('keydown', (event) => {
        if (event.key === ' ' || event.key === 'Enter') {
          event.preventDefault();
          input?.click();
        }
      });

      input?.addEventListener('change', () => {
        if (input.files && input.files.length) {
          updatePreview(input.files[0]);
        } else {
          updatePreview(null);
        }
      });
    })();
  </script>
{% endblock %}
