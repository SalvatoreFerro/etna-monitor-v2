{% extends "admin/base.html" %}

{% block title %}Monitor Sistema{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}?v={{ STATIC_ASSET_VERSION }}">
{% endblock %}

{% block admin_content %}
<section class="admin-page admin-container monitor-page">
  <header class="admin-header">
    <h1>Cron Monitoring</h1>
    <p>Dashboard amministrativa per stato, metriche e diagnostica dei job cron.</p>
    <div class="admin-actions">
      <span class="monitor-pill">Ultime <strong>24 ore</strong></span>
      <span class="monitor-pill monitor-pill--subtle">check-alerts</span>
    </div>
  </header>

  <section class="admin-card admin-card--hero">
    <div class="monitor-kpis">
      <article class="monitor-kpi">
        <span class="monitor-kpi__label">Cron Status</span>
        <div class="monitor-kpi__value">
          <span class="monitor-status" data-kpi="status">--</span>
        </div>
        <span class="monitor-kpi__hint" data-kpi="status_hint">In attesa...</span>
      </article>
      <article class="monitor-kpi">
        <span class="monitor-kpi__label">Ultimo run</span>
        <div class="monitor-kpi__value" data-kpi="last_run_time">--</div>
        <span class="monitor-kpi__hint" data-kpi="last_run_hint">--</span>
      </article>
      <article class="monitor-kpi">
        <span class="monitor-kpi__label">Runs 24h</span>
        <div class="monitor-kpi__value" data-kpi="runs_24h">--</div>
        <span class="monitor-kpi__hint" data-kpi="errors_24h">--</span>
      </article>
      <article class="monitor-kpi">
        <span class="monitor-kpi__label">Alerts sent</span>
        <div class="monitor-kpi__value" data-kpi="sent_24h">--</div>
        <span class="monitor-kpi__hint">Ultime 24h</span>
      </article>
      <article class="monitor-kpi">
        <span class="monitor-kpi__label">Skipped</span>
        <div class="monitor-kpi__value" data-kpi="skipped_24h">--</div>
        <span class="monitor-kpi__hint">Ultime 24h</span>
      </article>
    </div>
  </section>

  <section class="admin-card">
    <div class="admin-section-header admin-section-header--split">
      <div>
        <h2>Cron History</h2>
        <p>Ultimi run con dettagli diagnostici espandibili.</p>
      </div>
      <div class="admin-actions">
        <button class="btn btn-premium" type="button" data-action="refresh-runs">Aggiorna</button>
      </div>
    </div>
    <div class="admin-table-wrapper monitor-table-wrapper">
      <table class="admin-table monitor-table">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Status</th>
            <th>Durata</th>
            <th>Sent</th>
            <th>Skipped</th>
            <th>Dettagli</th>
          </tr>
        </thead>
        <tbody id="monitor-runs-body">
          <tr><td colspan="6" class="admin-empty">Caricamento...</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="admin-card">
    <div class="admin-section-header admin-section-header--split">
      <div>
        <h2>Trend &amp; performance</h2>
        <p>Grafici delle ultime 24h e 7d.</p>
      </div>
      <div class="monitor-range-toggle">
        <button class="btn btn-ghost is-active" type="button" data-range="24h">24h</button>
        <button class="btn btn-ghost" type="button" data-range="7d">7d</button>
      </div>
    </div>
    <div class="monitor-charts">
      <div class="monitor-chart" id="chart-runs"></div>
      <div class="monitor-chart" id="chart-sent"></div>
      <div class="monitor-chart" id="chart-errors"></div>
    </div>
  </section>
</section>

<dialog class="monitor-drawer" id="monitor-drawer">
  <div class="monitor-drawer__header">
    <div>
      <h3>Dettaglio run</h3>
      <p id="drawer-subtitle">--</p>
    </div>
    <button class="btn btn-ghost" type="button" data-action="close-drawer">Chiudi</button>
  </div>
  <div class="monitor-drawer__content">
    <section>
      <h4>Diagnostica</h4>
      <pre class="monitor-json" id="drawer-json">{}</pre>
    </section>
  </div>
</dialog>
{% endblock %}

{% block admin_scripts %}
  <script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/monitor.js') }}?v={{ STATIC_ASSET_VERSION }}"></script>
{% endblock %}
