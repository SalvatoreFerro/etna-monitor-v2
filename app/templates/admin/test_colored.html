{% extends "admin/base.html" %}

{% block title %}Test estrazione PNG colorato{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}?v={{ STATIC_ASSET_VERSION }}">
{% endblock %}

{% block admin_content %}
<section class="admin-page admin-container">
  <header class="admin-header">
    <h1>Test estrazione curva PNG colorato</h1>
    <p>Debug per la pipeline di estrazione curva nera su sfondo colorato.</p>
  </header>

  {% if error_message %}
    <div class="admin-card admin-flash admin-flash--error">
      <strong>Errore:</strong> {{ error_message }}
    </div>
  {% endif %}

  <section class="admin-card">
    <h2>PNG colorato (ultimo download)</h2>
    {% if raw_image %}
      <img src="{{ raw_image }}" alt="PNG colorato INGV" style="max-width: 100%; height: auto;" />
    {% else %}
      <p class="muted">Nessuna immagine disponibile.</p>
    {% endif %}
  </section>

  <section class="admin-card">
    <h2>Overlay curva estratta</h2>
    {% if overlay_image %}
      <img src="{{ overlay_image }}" alt="Overlay linea curva (punti scartati in arancione)" style="max-width: 100%; height: auto;" />
    {% else %}
      <p class="muted">Overlay non disponibile.</p>
    {% endif %}
  </section>

  <section class="admin-card">
    <h2>Maschera binaria</h2>
    {% if mask_image %}
      <img src="{{ mask_image }}" alt="Maschera binaria curva" style="max-width: 100%; height: auto;" />
    {% else %}
      <p class="muted">Maschera non disponibile.</p>
    {% endif %}
  </section>

  <section class="admin-card">
    <h2>Grafico Plotly (asse Y log, mV)</h2>
    <pre>{{ plot_diagnostics }}</pre>
    {% if plot_diagnostics and plot_diagnostics.num_valid_pairs < 10 %}
      <div class="admin-card admin-flash admin-flash--warning">
        <strong>Serie insufficiente per Plotly</strong>
        <p class="muted">Sono necessari almeno 10 punti validi per il rendering.</p>
        <ul class="muted">
          <li>Timestamps: {{ plot_diagnostics.timestamps_len }}</li>
          <li>Valori: {{ plot_diagnostics.values_len }}</li>
          <li>Validi: {{ plot_diagnostics.num_valid_pairs }}</li>
          <li>Scartati (NaN/None): {{ plot_diagnostics.removed_pairs }}</li>
          <li>Campione (primi 3): {{ plot_diagnostics.sample_pairs }}</li>
        </ul>
      </div>
    {% endif %}
    {% if plot_diagnostics and plot_diagnostics.num_valid_pairs >= 10 %}
      {% if plot_html %}
        {{ plot_html | safe }}
      {% else %}
        <div class="alert">Plot HTML missing</div>
      {% endif %}
    {% elif plot_html %}
      {{ plot_html | safe }}
    {% else %}
      <p class="muted">Grafico Plotly non disponibile.</p>
    {% endif %}
  </section>
</section>
{% endblock %}
