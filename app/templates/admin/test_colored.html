{% extends "admin/base.html" %}

{% block title %}Test estrazione PNG colorato{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}?v={{ STATIC_ASSET_VERSION }}">
{% endblock %}

{% block admin_content %}
<section class="admin-page admin-container">
  <header class="admin-header">
    <h1>Test estrazione curva PNG colorato</h1>
    <p>Debug per la pipeline di estrazione curva nera su sfondo colorato.</p>
  </header>

  {% if error_message %}
    <div class="admin-card admin-flash admin-flash--error">
      <strong>Errore:</strong> {{ error_message }}
    </div>
  {% endif %}
  {% if fallback_notice %}
    <div class="admin-card admin-flash admin-flash--warning">
      <strong>Aggiornamento in corso.</strong>
      Ultimo dato disponibile: {{ fallback_timestamp or "N/A" }}{% if fallback_csv_path %} ({{ fallback_csv_path }}){% endif %}.
    </div>
  {% endif %}

  <section class="admin-card">
    <h2>Tremor Summary Debug</h2>
    {% if tremor_summary %}
      <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
        <div class="admin-card" style="margin: 0;">
          <h3>KPI</h3>
          <ul>
            <li><strong>Median last hour:</strong> {{ "%.3f" | format(tremor_summary.median_last_hour) if tremor_summary.median_last_hour is not none else "N/A" }} mV</li>
            <li><strong>Median prev hour:</strong> {{ "%.3f" | format(tremor_summary.median_prev_hour) if tremor_summary.median_prev_hour is not none else "N/A" }} mV</li>
            <li><strong>Delta %:</strong> {{ "%.2f" | format(tremor_summary.delta_pct * 100) if tremor_summary.delta_pct is not none else "N/A" }}%</li>
            <li><strong>Trend:</strong> {{ tremor_summary.trend or "N/A" }}</li>
            <li><strong>Level band:</strong> {{ tremor_summary.level_band or "N/A" }}</li>
          </ul>
        </div>
        <div class="admin-card" style="margin: 0;">
          <h3>Soglie e bande</h3>
          <ul>
            <li><strong>t1:</strong> {{ "%.3f" | format(tremor_summary.thresholds_used.t1) if tremor_summary.thresholds_used and tremor_summary.thresholds_used.t1 is not none else "N/A" }} mV</li>
            <li><strong>t2:</strong> {{ "%.3f" | format(tremor_summary.thresholds_used.t2) if tremor_summary.thresholds_used and tremor_summary.thresholds_used.t2 is not none else "N/A" }} mV</li>
            <li><strong>t3:</strong> {{ "%.3f" | format(tremor_summary.thresholds_used.t3) if tremor_summary.thresholds_used and tremor_summary.thresholds_used.t3 is not none else "N/A" }} mV</li>
            <li><strong>Source:</strong> {{ tremor_summary.thresholds_used.source if tremor_summary.thresholds_used else "N/A" }}</li>
            <li><strong>Band PX:</strong> {{ tremor_summary.bands_px_used if tremor_summary.bands_px_used else "N/A" }}</li>
          </ul>
        </div>
        <div class="admin-card" style="margin: 0;">
          <h3>Verifica cache</h3>
          {% if bands_debug %}
            <ul>
              <li><strong>Updated at:</strong> {{ bands_debug.updated_at or "N/A" }}</li>
              <li><strong>Detected today:</strong> {{ "yes" if bands_debug.detected_today else "no" }}</li>
              <li><strong>Verification status:</strong> {{ bands_debug.verification_status or "N/A" }}</li>
              <li><strong>Checked at:</strong> {{ bands_debug.verification_checked_at or "N/A" }}</li>
              <li><strong>Notes:</strong> {{ bands_debug.verification_notes or "N/A" }}</li>
            </ul>
          {% else %}
            <p class="muted">Cache bande non disponibile.</p>
          {% endif %}
        </div>
      </div>
    {% else %}
      <p class="muted">Tremor summary non disponibile.</p>
    {% endif %}
  </section>

  <section class="admin-card">
    <h2>PNG colorato (ultimo download)</h2>
    {% if raw_image %}
      <img src="{{ raw_image }}" alt="PNG colorato INGV" style="max-width: 100%; height: auto;" />
    {% else %}
      <p class="muted">Nessuna immagine disponibile.</p>
    {% endif %}
  </section>

  <section class="admin-card">
    <h2>Overlay curva estratta</h2>
    {% if overlay_image %}
      <img src="{{ overlay_image }}" alt="Overlay linea curva (punti scartati in arancione)" style="max-width: 100%; height: auto;" />
    {% else %}
      <p class="muted">Overlay non disponibile.</p>
    {% endif %}
  </section>

  <section class="admin-card">
    <h2>Maschera binaria</h2>
    {% if mask_image %}
      <img src="{{ mask_image }}" alt="Maschera binaria curva" style="max-width: 100%; height: auto;" />
    {% else %}
      <p class="muted">Maschera non disponibile.</p>
    {% endif %}
  </section>

  <section class="admin-card">
    <h2>Debug artifacts</h2>
    <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
      <div>
        <h3>Crop plot area</h3>
        {% if crop_image %}
          <img src="{{ crop_image }}" alt="Crop plot area" style="max-width: 100%; height: auto;" />
        {% else %}
          <p class="muted">Crop non disponibile.</p>
        {% endif %}
      </div>
      <div>
        <h3>Mask raw</h3>
        {% if mask_raw_image %}
          <img src="{{ mask_raw_image }}" alt="Mask raw" style="max-width: 100%; height: auto;" />
        {% else %}
          <p class="muted">Mask raw non disponibile.</p>
        {% endif %}
      </div>
      <div>
        <h3>Mask ink</h3>
        {% if mask_ink_image %}
          <img src="{{ mask_ink_image }}" alt="Mask ink" style="max-width: 100%; height: auto;" />
        {% else %}
          <p class="muted">Mask ink non disponibile.</p>
        {% endif %}
      </div>
      <div>
        <h3>Mask pretty</h3>
        {% if mask_pretty_image %}
          <img src="{{ mask_pretty_image }}" alt="Mask pretty" style="max-width: 100%; height: auto;" />
        {% else %}
          <p class="muted">Mask pretty non disponibile.</p>
        {% endif %}
      </div>
      <div>
        <h3>Overlay markers</h3>
        {% if overlay_markers_image %}
          <img src="{{ overlay_markers_image }}" alt="Overlay markers" style="max-width: 100%; height: auto;" />
        {% else %}
          <p class="muted">Overlay markers non disponibile.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="admin-card">
    <h2>Grafico Plotly (asse Y log, mV)</h2>
    {% if plot_html %}
      {{ plot_html | safe }}
    {% else %}
      <div class="admin-card admin-flash admin-flash--error">
        <strong>Grafico non disponibile.</strong>
        <span>
          {% if error_message %}
            Causa: {{ error_message }}
          {% else %}
            Causa: plot_html Ã¨ None o vuoto.
          {% endif %}
        </span>
      </div>
    {% endif %}
  </section>

  <section class="admin-card">
    <h2>Debug JSON</h2>
    {% if debug_json %}
      <pre style="white-space: pre-wrap; word-break: break-word;">{{ debug_json | tojson(indent=2) }}</pre>
    {% else %}
      <p class="muted">debug.json non disponibile.</p>
    {% endif %}
  </section>

  <section class="admin-card">
    <h2>Debug dati estratti</h2>
    {% if debug_data %}
      <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
        <div class="admin-card" style="margin: 0;">
          <h3>Statistiche (ultimi {{ debug_data.limits.tail }} punti)</h3>
          <ul>
            <li><strong>Min:</strong> {{ "%.3f" | format(debug_data.stats.min) if debug_data.stats.min is not none else "N/A" }}</li>
            <li><strong>Max:</strong> {{ "%.3f" | format(debug_data.stats.max) if debug_data.stats.max is not none else "N/A" }}</li>
            <li><strong>Mean:</strong> {{ "%.3f" | format(debug_data.stats.mean) if debug_data.stats.mean is not none else "N/A" }}</li>
          </ul>
        </div>
        <div class="admin-card" style="margin: 0;">
          <h3>Contatori</h3>
          <ul>
            <li><strong>Total points:</strong> {{ debug_data.counts.total_points }}</li>
            <li><strong>Tail points:</strong> {{ debug_data.counts.tail_points }}</li>
            <li><strong>Removed pairs:</strong> {{ debug_data.counts.removed_pairs }}</li>
            <li><strong>Clamped count:</strong> {{ debug_data.counts.clamped_count }}</li>
            <li><strong>Nonfinite count:</strong> {{ debug_data.counts.nonfinite_count }}</li>
            <li><strong>Nonpositive count:</strong> {{ debug_data.counts.nonpositive_count }}</li>
          </ul>
        </div>
        <div class="admin-card" style="margin: 0;">
          <h3>Top {{ debug_data.limits.peaks }} picchi</h3>
          <div class="admin-table-wrapper" style="max-height: 240px; overflow-y: auto;">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>mV</th>
                </tr>
              </thead>
              <tbody>
                {% for item in debug_data.peaks %}
                  <tr>
                    <td><code>{{ item.timestamp }}</code></td>
                    <td>{{ "%.3f" | format(item.value) }}</td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="2">Nessun picco disponibile.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="admin-card" style="margin-top: 1rem;">
        <h3>Ultimi {{ debug_data.limits.tail }} punti</h3>
        <div class="admin-table-wrapper" style="max-height: 360px; overflow-y: auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Timestamp (ISO)</th>
                <th>mV</th>
              </tr>
            </thead>
            <tbody>
              {% for item in debug_data.tail %}
                <tr>
                  <td><code>{{ item.timestamp }}</code></td>
                  <td>{{ "%.3f" | format(item.value) }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="2">Nessun dato disponibile.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <p class="muted">Dati di debug non disponibili.</p>
    {% endif %}
  </section>
</section>
{% endblock %}
