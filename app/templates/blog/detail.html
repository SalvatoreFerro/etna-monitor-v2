{% extends "layout.html" %}

{% set canonical_url = post_url %}
{% set published_timestamp = post.published_at or post.created_at %}
{% set hero_image = post.hero_image_url or post.hero_image %}
{% set page_title = post.meta_title or post.seo_title or post.title %}
{% set page_description = post.meta_description or post.seo_description or post.abstract or post.title %}
{% set page_og_title = post.meta_title or post.seo_title or post.title %}
{% set page_og_description = page_description %}
{% if hero_image %}
  {% set page_og_image = hero_image %}
{% endif %}

{% block head_extra %}
  {{ super() }}
  {% if hero_image %}
    <meta property="og:image" content="{{ hero_image }}">
    <meta name="twitter:image" content="{{ hero_image }}">
  {% endif %}

  <script type="application/ld+json" nonce="{{ csp_nonce() }}">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "{{ post.title|e }}",
    "description": "{{ (post.abstract or computed_description)|e }}",
    "image": [
      {% if hero_image %}"{{ hero_image }}"{% else %}"{{ default_og_image }}"{% endif %}
    ],
    "datePublished": "{{ published_timestamp.isoformat() }}",
    "dateModified": "{{ (post.updated_at or published_timestamp).isoformat() }}",
    "author": {
      "@type": "Organization",
      "name": "EtnaMonitor"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "{{ computed_canonical }}"
    }
  }
  </script>
{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/article.css') }}?v={{ STATIC_ASSET_VERSION }}">
  {% if breadcrumb_schema %}
    <script type="application/ld+json" nonce="{{ csp_nonce() }}">
      {{ breadcrumb_schema | tojson(indent=2) }}
    </script>
  {% endif %}
{% endblock %}

{% block content %}
<article class="post" itemscope itemtype="https://schema.org/Article">
  <header class="post__header">
    {% if preview_mode %}
      <div class="post__preview-watermark" aria-hidden="true">PREVIEW</div>
    {% endif %}
    <div class="post__header-inner post--container container">
      <nav class="post__breadcrumb" aria-label="Percorso">
        <ol class="post__breadcrumb-list">
          <li><a href="{{ url_for('main.index') }}">Home</a></li>
          <li><a href="{{ url_for('community.forum_home') }}">Community</a></li>
          <li><a href="{{ url_for('community.blog_index') }}">Blog</a></li>
          <li aria-current="page">{{ post.title }}</li>
        </ol>
      </nav>
      <h1 class="post__title" itemprop="headline">{{ post.title }}</h1>
      <p class="post__meta">
        <time datetime="{{ published_timestamp.isoformat() }}" itemprop="datePublished">{{ published_timestamp.strftime('%d %B %Y') }}</time>
        {% if author_name %}
          <span class="post__meta-separator" aria-hidden="true">·</span>
          <span class="post__meta-author" itemprop="author" itemscope itemtype="https://schema.org/Person">
            <span itemprop="name">{{ author_name }}</span>
          </span>
        {% endif %}
        {% if post.seo_score is not none %}
          <span class="badge {{ 'success' if post.seo_score >= 70 else 'warning' if post.seo_score >= 40 else 'muted' }}">SEO {{ post.seo_score }}%</span>
        {% endif %}
      </p>
      {% if hero_image %}
        <figure class="blog-hero" itemprop="image">
          <img src="{{ hero_image }}" alt="{{ post.title }}" loading="lazy" decoding="async">
        </figure>
      {% endif %}
      {% if post.abstract %}
        <p class="blog-abstract" itemprop="description">{{ post.abstract }}</p>
      {% endif %}
    </div>
  </header>

  <div class="post__body post--container container">
    <div class="blog-body prose prose-invert" itemprop="articleBody">
      {{ body_html | safe }}
    </div>
  </div>

  <footer class="post__footer post--container container">
    <div class="post__footer-nav">
      <a class="post__back-link" href="{{ url_for('community.blog_index') }}">← Torna al blog</a>
      {% if previous_post or next_post %}
        <nav class="post__pagination" aria-label="Navigazione articoli">
          {% if previous_post %}
            <a class="post__pagination-link post__pagination-link--prev" href="{{ url_for('community.blog_detail', slug=previous_post.slug) }}">
              <span class="post__pagination-direction" aria-hidden="true">←</span>
              <span class="post__pagination-label">Articolo precedente</span>
              <span class="post__pagination-title">{{ previous_post.title }}</span>
            </a>
          {% endif %}
          {% if next_post %}
            <a class="post__pagination-link post__pagination-link--next" href="{{ url_for('community.blog_detail', slug=next_post.slug) }}">
              <span class="post__pagination-direction" aria-hidden="true">→</span>
              <span class="post__pagination-label">Articolo successivo</span>
              <span class="post__pagination-title">{{ next_post.title }}</span>
            </a>
          {% endif %}
        </nav>
      {% endif %}
    </div>

    {% if related_posts %}
      <section class="post__related" aria-labelledby="post-related-title">
        <h2 id="post-related-title" class="post__related-title">Articoli correlati</h2>
        <div class="post__related-list">
          {% for related in related_posts %}
            <article class="post__related-card">
              <h3 class="post__related-card-title">
                <a href="{{ url_for('community.blog_detail', slug=related.slug) }}">{{ related.title }}</a>
              </h3>
              <time datetime="{{ related.created_at.isoformat() }}">{{ related.created_at.strftime('%d %B %Y') }}</time>
            </article>
          {% endfor %}
        </div>
      </section>
    {% endif %}

    <div class="post__footer-cta">
      <div class="cta-stack">
        <a class="btn btn-primary" href="{{ url_for('community.feedback_portal') }}">Ti è stato utile? Lascia un feedback</a>
        <a class="btn btn-secondary" href="{{ url_for('community.forum_home') }}">Fai una domanda nel forum</a>
      </div>
    </div>
  </footer>
</article>
{% endblock %}
