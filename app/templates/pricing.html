{% extends "layout.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
<script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<div class="pricing-container">
  <div class="pricing-header hero-premium animate-premium-fade">
    <h1>Scegli il Tuo Piano</h1>
    <p>Sblocca funzionalità di monitoraggio avanzate con Premium</p>
  </div>
  
  <div class="pricing-grid">
    <div class="pricing-card card-premium animate-premium-slide">
      <div class="plan-header">
        <h3>Gratuito</h3>
        <div class="price">
          <span class="amount">€0</span>
          <span class="period">/mese</span>
        </div>
      </div>
      
      <div class="plan-features">
        <ul>
          <li><span class="check">✓</span> Ultimi 7 giorni di dati</li>
          <li><span class="check">✓</span> Monitoraggio tremore base</li>
          <li><span class="check">✓</span> Soglia fissa (2.0 mV)</li>
          <li><span class="check">✓</span> Frequenza aggiornamento standard</li>
          <li><span class="cross">✕</span> Soglie personalizzate</li>
          <li><span class="cross">✕</span> Avvisi in tempo reale</li>
          <li><span class="cross">✕</span> Esportazione dati</li>
          <li><span class="cross">✕</span> Cronologia eventi</li>
        </ul>
      </div>
      
      <div class="plan-action">
        {% if not session.user_id %}
        <a href="{{ url_for('auth.register') }}" class="btn btn-secondary glass" aria-label="Inizia prova gratuita">Inizia</a>
        {% elif not current_user.premium %}
        <button class="btn btn-secondary glass" disabled>Piano Attuale</button>
        {% else %}
        <button class="btn btn-secondary glass" disabled>Declassamento Disponibile</button>
        {% endif %}
      </div>
    </div>
    
    <div class="pricing-card card-premium premium animate-premium-slide">
      <div class="plan-badge">Più Popolare</div>
      <div class="plan-header">
        <h3>Premium</h3>
        <div class="price">
          <span class="amount">€9.99</span>
          <span class="period">/mese</span>
        </div>
      </div>
      
      <div class="plan-features">
        <ul>
          <li><span class="check">✓</span> Cronologia dati completa</li>
          <li><span class="check">✓</span> Monitoraggio in tempo reale</li>
          <li><span class="check">✓</span> Soglie personalizzate (0.1-10 mV)</li>
          <li><span class="check">✓</span> Avvisi istantanei (Email + Telegram)</li>
          <li><span class="check">✓</span> Esportazione dati (CSV, PNG)</li>
          <li><span class="check">✓</span> Cronologia eventi e log</li>
          <li><span class="check">✓</span> Supporto prioritario</li>
          <li><span class="check">✓</span> Analisi avanzate</li>
        </ul>
      </div>
      
      <div class="plan-action">
        {% if not session.user_id %}
        <a href="{{ url_for('auth.register') }}" class="btn btn-premium" aria-label="Inizia prova gratuita premium">Inizia Prova Gratuita</a>
        {% elif current_user.premium %}
        <a href="{{ url_for('billing.customer_portal') }}" class="btn btn-secondary glass">Gestisci Abbonamento</a>
        {% else %}
        <button id="upgrade-btn" class="btn btn-premium" aria-label="Passa al piano premium">Aggiorna Ora</button>
        {% endif %}
      </div>
    </div>
  </div>
  
  <div class="faq-section card-premium animate-premium-fade">
    <h2>Domande Frequenti</h2>
    
    <div class="faq-grid">
      <div class="faq-item">
        <h4>Quali fonti di dati utilizzate?</h4>
        <p>Elaboriamo dati sismici in tempo reale dalle stazioni di monitoraggio INGV (Istituto Nazionale di Geofisica e Vulcanologia) sull'Etna.</p>
      </div>
      
      <div class="faq-item">
        <h4>Quanto sono accurati gli avvisi?</h4>
        <p>Il nostro sistema elabora dati ufficiali INGV con soglie personalizzabili. Gli utenti Premium possono regolare la sensibilità per ridurre i falsi positivi.</p>
      </div>
      
      <div class="faq-item">
        <h4>Posso cancellare in qualsiasi momento?</h4>
        <p>Sì, puoi cancellare il tuo abbonamento Premium in qualsiasi momento. Manterrai l'accesso fino alla fine del periodo di fatturazione.</p>
      </div>
      
      <div class="faq-item">
        <h4>C'è una prova gratuita?</h4>
        <p>Sì! I nuovi abbonati Premium ottengono una prova gratuita di 7 giorni con accesso completo a tutte le funzionalità.</p>
      </div>
      
      <div class="faq-item">
        <h4>Quali metodi di pagamento accettate?</h4>
        <p>Accettiamo tutte le principali carte di credito, carte di debito e addebito diretto SEPA attraverso la nostra integrazione sicura con Stripe.</p>
      </div>
      
      <div class="faq-item">
        <h4>Offrite rimborsi?</h4>
        <p>Offriamo una garanzia di rimborso di 30 giorni per gli abbonamenti annuali. Gli abbonamenti mensili possono essere cancellati in qualsiasi momento.</p>
      </div>
    </div>
  </div>
  
  <div class="trust-section card-premium animate-premium-slide">
    <div class="trust-items">
      <div class="trust-item">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
        <span>Pagamenti sicuri con Stripe</span>
      </div>
      
      <div class="trust-item">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12l2 2 4-4"/>
          <circle cx="12" cy="12" r="9"/>
        </svg>
        <span>Conforme GDPR</span>
      </div>
      
      <div class="trust-item">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="8.5" cy="7" r="4"/>
          <path d="M20 8v6M23 11h-6"/>
        </svg>
        <span>Cancella in qualsiasi momento</span>
      </div>
    </div>
  </div>
</div>

<script>
const stripe = Stripe('{{ config.STRIPE_PUBLIC_KEY }}');

document.getElementById('upgrade-btn')?.addEventListener('click', async () => {
  const button = document.getElementById('upgrade-btn');
  button.disabled = true;
  button.textContent = 'Elaborazione...';
  
  try {
    const response = await fetch('/billing/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    
    if (data.checkout_url) {
      window.location.href = data.checkout_url;
    } else {
      throw new Error(data.error || 'Failed to create checkout session');
    }
  } catch (error) {
    alert('Errore: ' + error.message);
    button.disabled = false;
    button.textContent = 'Aggiorna Ora';
  }
});
</script>
{% endblock %}
