{% extends "layout.html" %}

{% block head_extra %}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
{% endblock %}

{% block content %}
  {% from "partials/leaflet_map.html" import etna_hotspots_map %}
  <section class="observatory-hero">
    <div class="container">
      <div class="observatory-header">
        <span class="observatory-pill">üõ∞Ô∏è Osservatorio multisorgente</span>
        <h1>Osservatorio Etna: tremore, hotspot NASA e Copernicus Sentinel-2</h1>
        <p>
          Una vista unica per monitorare il vulcano con dati INGV, anomalie termiche NASA FIRMS e
          immagini satellitari Copernicus Sentinel-2 pronte per il web.
        </p>
      </div>
    </div>
  </section>

  <section class="observatory-grid">
    <div class="container">
      <div class="observatory-columns">
        <article class="observatory-card observatory-card--tremor">
          <header class="observatory-card__header">
            <div>
              <h2>Tremore</h2>
              <p>Grafico INGV aggiornato automaticamente.</p>
            </div>
            <div class="observatory-card__meta">
              <span>Ultimo aggiornamento</span>
              <strong>{{ latest_timestamp_display or '‚Äî' }}</strong>
            </div>
          </header>
          <div class="observatory-card__body">
            <div class="chart-card" id="grafico-etna">
              <div class="chart-card__status">
                <div class="chart-range-selector" role="group" aria-label="Intervallo temporale">
                  <button type="button" class="chart-range-btn" data-limit="288">24h</button>
                  <button type="button" class="chart-range-btn" data-limit="864">3 giorni</button>
                  <button type="button" class="chart-range-btn is-active" data-limit="2016">7 giorni</button>
                </div>
                <div class="chart-interaction-controls" role="group" aria-label="Controlli analisi grafico">
                  <button
                    type="button"
                    id="chart-analyze-toggle"
                    class="btn btn-secondary btn-sm chart-interaction-toggle"
                  >
                    Analizza
                  </button>
                  <button
                    type="button"
                    id="chart-reset-view"
                    class="btn btn-ghost btn-sm chart-interaction-reset"
                  >
                    Reset vista
                  </button>
                  <span id="chart-analyze-hint" class="chart-interaction-hint" role="status" aria-live="polite">
                    Suggerimento: premi Analizza e trascina sul grafico per selezionare un intervallo.
                  </span>
                  <span id="chart-analyze-status" class="chart-mode-indicator" aria-live="polite" aria-hidden="true">
                    Modalit√† analisi attiva
                  </span>
                </div>
              </div>
              {% if csv_snapshot.has_data %}
                <div id="home-preview-loading" class="chart-loading" aria-live="polite">
                  <div class="chart-spinner" aria-hidden="true">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                  <p>Caricamento dati INGV‚Ä¶</p>
                </div>
                <div id="home-preview-plot" aria-hidden="true"></div>
                {% if preview_rows %}
                  <script id="home-bootstrap-data" type="application/json" nonce="{{ csp_nonce() }}">
                    {{ preview_rows | tojson(indent=0) | safe }}
                  </script>
                {% endif %}
              {% else %}
                <div class="chart-loading" aria-live="polite">
                  <p><strong>Dati in preparazione</strong></p>
                  <p>
                    Il file <code>{{ csv_snapshot.path }}</code> risulta temporaneamente vuoto (motivo: {{ csv_snapshot.placeholder_reason }}).
                    Riprova pi√π tardi: il grafico si popoler√† automaticamente.
                  </p>
                </div>
              {% endif %}
            </div>
            <div class="observatory-tremor-meta">
              <div class="observatory-kpi">
                <span>Ultimo aggiornamento</span>
                <strong id="live-last-update">{{ latest_timestamp_display or '--' }}</strong>
              </div>
              <div class="observatory-kpi">
                <span>Campioni elaborati</span>
                <strong id="live-data-points">{{ data_points_count or '--' }}</strong>
              </div>
              <div class="observatory-kpi">
                <span>Stato</span>
                <strong>
                  <span class="status-dot" id="live-status-indicator" aria-hidden="true"></span>
                  <span id="live-status-text">Connessione in corso‚Ä¶</span>
                </strong>
              </div>
              <div class="observatory-kpi">
                <span>Attivit√†</span>
                <strong><span id="live-activity-badge" class="activity-badge">In caricamento‚Ä¶</span></strong>
              </div>
              <button id="btn-aggiorna-dati-live" class="btn btn-primary btn-sm" type="button">Aggiorna dati live</button>
            </div>
          </div>
        </article>

        <article class="observatory-card observatory-card--satellite">
          <header class="observatory-card__header">
            <div>
              <h2>Mappa satellitare</h2>
              <p>Hotspot NASA FIRMS e area Copernicus Sentinel-2 in un‚Äôunica vista.</p>
            </div>
            <div class="observatory-card__meta">
              <span>Ultimo aggiornamento Copernicus</span>
              <strong>{{ copernicus_updated_display or '‚Äî' }}</strong>
            </div>
          </header>
          <div class="observatory-card__body">
            {% set copernicus_available = copernicus_image_url is not none %}
            {% set copernicus_cloud_high = copernicus_latest and copernicus_latest.cloud_cover is not none and copernicus_latest.cloud_cover >= 65 %}
            {% set copernicus_status = 'Immagine disponibile' if copernicus_available else ('Copertura nuvolosa elevata' if copernicus_cloud_high else ('In elaborazione' if copernicus_latest else 'Prodotto non ancora pubblicato')) %}
            {{ etna_hotspots_map(
              'observatory-map',
              'observatory-map-label',
              'observatory-map-loader',
              'Hotspot FIRMS e area Copernicus Sentinel-2 sull‚ÄôEtna'
            ) }}
            <div class="observatory-map-meta">
              <div class="observatory-map-meta-group">
                <div class="observatory-map-meta-title">Hotspot NASA FIRMS</div>
                <div class="observatory-kpi-grid">
                  <div class="observatory-kpi">
                    <span>Ultimo aggiornamento</span>
                    <strong>{{ hotspots_summary.last_fetch_display or '‚Äî' }}</strong>
                  </div>
                  <div class="observatory-kpi">
                    <span>Hotspot ultime 24h</span>
                    <strong id="observatory-hotspots-count">{{ hotspots_summary.count_24h or '0' }}</strong>
                  </div>
                  <div class="observatory-kpi">
                    <span>Hotspot pi√π recente</span>
                    <strong id="observatory-hotspots-latest">{{ hotspots_summary.latest_acquired_display or '‚Äî' }}</strong>
                  </div>
                </div>
              </div>
              <div class="observatory-map-meta-group">
                <div class="observatory-map-meta-title">Copernicus Sentinel-2</div>
                <div class="observatory-copernicus-meta">
                  <div>
                    <span>Acquisizione</span>
                    <strong id="observatory-copernicus-acquired">{{ copernicus_acquired_display or '‚Äî' }}</strong>
                  </div>
                  <div>
                    <span>Copertura nuvolosa</span>
                    <strong id="observatory-copernicus-cloud">
                      {% if copernicus_latest and copernicus_latest.cloud_cover is not none %}
                        {{ '%.1f' | format(copernicus_latest.cloud_cover) }}%
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </strong>
                  </div>
                  <div>
                    <span>Prodotto</span>
                    <strong id="observatory-copernicus-product">
                      {% if copernicus_latest and copernicus_latest.product_id %}
                        {{ copernicus_latest.product_id }}
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </strong>
                  </div>
                  <div>
                    <span>Ultimo aggiornamento</span>
                    <strong id="observatory-copernicus-updated">{{ copernicus_updated_display or '‚Äî' }}</strong>
                  </div>
                </div>
                <div class="observatory-copernicus-status">
                  <span>Stato immagine</span>
                  <strong id="observatory-copernicus-status">{{ copernicus_status }}</strong>
                </div>
                <div class="observatory-copernicus-badges" id="observatory-copernicus-badges">
                  {% if copernicus_cloud_high %}
                    <span class="observatory-badge observatory-badge--warning">Nuvolosit√† alta</span>
                  {% endif %}
                  {% if not copernicus_available %}
                    <span class="observatory-badge observatory-badge--info">{{ copernicus_status }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="observatory-image">
              {% if copernicus_image_url %}
                <div class="observatory-image__frame">
                  <img
                    src="{{ copernicus_image_url }}"
                    alt="Immagine satellitare Copernicus Sentinel-2 dell'Etna"
                    loading="lazy"
                    decoding="async"
                  />
                  <div class="observatory-image__overlay">
                    <span class="observatory-summit-marker" aria-hidden="true"></span>
                    <span class="observatory-summit-label">Etna summit</span>
                  </div>
                </div>
              {% else %}
                <div class="observatory-image__placeholder" id="observatory-image-placeholder">
                  <div class="observatory-image__placeholder-content">
                    <span class="observatory-image__status" id="observatory-image-status">{{ copernicus_status }}</span>
                    <span class="observatory-image__detail" id="observatory-image-detail">
                      {% if copernicus_acquired_display %}
                        Acquisizione: {{ copernicus_acquired_display }}
                      {% elif copernicus_updated_display %}
                        Ultimo tentativo: {{ copernicus_updated_display }}
                      {% else %}
                        Dati in aggiornamento.
                      {% endif %}
                    </span>
                  </div>
                </div>
              {% endif %}
            </div>
            <p class="observatory-note">
              Immagine satellitare Copernicus Sentinel-2 (CDSE). La disponibilit√† dipende dalla copertura
              nuvolosa e dai passaggi del satellite.
            </p>
            <div class="observatory-card__footer">
              {% if config.HOTSPOTS_ENABLED %}
                <a class="btn btn-secondary" href="{{ url_for('main.hotspots') }}">Apri pagina hotspot</a>
              {% endif %}
              <button
                type="button"
                class="btn btn-secondary"
                data-modal-open
                {% if not copernicus_image_url %}disabled{% endif %}
              >
                Apri grande
              </button>
            </div>
          </div>
        </article>
      </div>
    </div>
  </section>

  <div class="observatory-modal" data-modal hidden>
    <div class="observatory-modal__backdrop" data-modal-close></div>
    <div class="observatory-modal__content" role="dialog" aria-modal="true" aria-label="Immagine Copernicus Sentinel-2">
      <button class="observatory-modal__close" type="button" data-modal-close aria-label="Chiudi">√ó</button>
      {% if copernicus_image_url %}
        <img
          src="{{ copernicus_image_url }}"
          alt="Immagine satellitare Copernicus Sentinel-2 dell'Etna in formato grande"
          loading="lazy"
          decoding="async"
        />
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block head %}
  <script defer src="{{ url_for('static', filename='js/plotly.min.js') }}?v={{ STATIC_ASSET_VERSION }}"></script>
  <script defer src="{{ url_for('static', filename='js/chart.js') }}?v={{ STATIC_ASSET_VERSION }}"></script>
  <script defer src="{{ url_for('static', filename='js/leaflet_common.js') }}?v={{ STATIC_ASSET_VERSION }}"></script>
  <script
    defer
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', () => {
      const mapElement = document.getElementById('observatory-map');
      if (mapElement && window.EtnaLeaflet) {
        const copernicusBbox = {{ copernicus_bbox | tojson }};
        const map = window.EtnaLeaflet.createEtnaMap(mapElement, {
          addFirmsBadge: true,
        });

        let copernicusFootprint = window.EtnaLeaflet.addCopernicusFootprint(map, copernicusBbox, {
          color: '#38bdf8',
          fillColor: '#38bdf8',
        });
        window.EtnaLeaflet.addEtnaMarker(map);

        const countEl = document.getElementById('observatory-hotspots-count');
        const latestEl = document.getElementById('observatory-hotspots-latest');
        const labelEl = document.getElementById('observatory-map-label');
        const loaderEl = document.getElementById('observatory-map-loader');
        const statusEl = document.getElementById('observatory-copernicus-status');
        const badgesEl = document.getElementById('observatory-copernicus-badges');
        const productEl = document.getElementById('observatory-copernicus-product');
        const cloudEl = document.getElementById('observatory-copernicus-cloud');
        const acquiredEl = document.getElementById('observatory-copernicus-acquired');
        const updatedEl = document.getElementById('observatory-copernicus-updated');
        const imageStatusEl = document.getElementById('observatory-image-status');
        const imageDetailEl = document.getElementById('observatory-image-detail');

        const setLoaderVisible = (visible) => {
          if (!loaderEl) {
            return;
          }
          loaderEl.classList.toggle('is-visible', visible);
        };

        const setLabelVisible = (visible) => {
          if (!labelEl) {
            return;
          }
          labelEl.classList.toggle('is-visible', visible);
        };

        const formatDateTime = (value) => {
          if (!value) {
            return '‚Äî';
          }
          const parsed = new Date(value);
          if (Number.isNaN(parsed.getTime())) {
            return value;
          }
          return parsed.toLocaleString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'UTC',
            timeZoneName: 'short',
          });
        };

        const resolveCopernicusStatus = (payload) => {
          if (!payload) {
            return { label: 'Prodotto non ancora pubblicato', detail: 'Dati in aggiornamento.' };
          }
          if (payload.available) {
            return { label: 'Immagine disponibile', detail: 'Disponibile per la visualizzazione.' };
          }
          const cloudCoverage = payload.cloud_coverage ?? payload.cloud_cover;
          if (cloudCoverage != null && cloudCoverage >= 65) {
            return { label: 'Copertura nuvolosa elevata', detail: 'La scena risulta troppo coperta.' };
          }
          if (!payload.product_id) {
            return { label: 'Prodotto non ancora pubblicato', detail: 'In attesa della prossima acquisizione.' };
          }
          return { label: 'In elaborazione', detail: 'Il prodotto √® in fase di processing.' };
        };

        const renderCopernicusBadges = (payload, statusLabel) => {
          if (!badgesEl) {
            return;
          }
          badgesEl.innerHTML = '';
          const cloudCoverage = payload?.cloud_coverage ?? payload?.cloud_cover ?? null;
          if (cloudCoverage != null && cloudCoverage >= 65) {
            const badge = document.createElement('span');
            badge.className = 'observatory-badge observatory-badge--warning';
            badge.textContent = 'Nuvolosit√† alta';
            badgesEl.appendChild(badge);
          }
          if (!payload?.available) {
            const badge = document.createElement('span');
            badge.className = 'observatory-badge observatory-badge--info';
            badge.textContent = statusLabel;
            badgesEl.appendChild(badge);
          }
        };

        const updateCopernicusMeta = (payload) => {
          if (!payload) {
            return;
          }
          if (productEl) {
            productEl.textContent = payload.product_id || '‚Äî';
          }
          if (cloudEl) {
            const cloudCoverage = payload.cloud_coverage ?? payload.cloud_cover;
            cloudEl.textContent = cloudCoverage == null ? '‚Äî' : `${cloudCoverage.toFixed(1)}%`;
          }
          if (acquiredEl) {
            acquiredEl.textContent = formatDateTime(payload.acquired_at);
          }
          if (updatedEl) {
            updatedEl.textContent = formatDateTime(payload.created_at);
          }
          const status = resolveCopernicusStatus(payload);
          if (statusEl) {
            statusEl.textContent = status.label;
          }
          if (imageStatusEl) {
            imageStatusEl.textContent = status.label;
          }
          if (imageDetailEl) {
            const detail = payload.acquired_at
              ? `Acquisizione: ${formatDateTime(payload.acquired_at)}`
              : payload.created_at
                ? `Ultimo tentativo: ${formatDateTime(payload.created_at)}`
                : status.detail;
            imageDetailEl.textContent = detail;
          }
          renderCopernicusBadges(payload, status.label);
          if (map && payload.bbox && window.EtnaLeaflet?.addCopernicusFootprint) {
            if (copernicusFootprint) {
              map.removeLayer(copernicusFootprint);
            }
            copernicusFootprint = window.EtnaLeaflet.addCopernicusFootprint(map, payload.bbox, {
              color: '#38bdf8',
              fillColor: '#38bdf8',
            });
          }
        };

        setLoaderVisible(true);
        fetch('/api/hotspots/latest?mode=all', { headers: { Accept: 'application/json' } })
          .then((response) => response.json())
          .then((payload) => {
            if (!payload || !payload.available || !map) {
              return;
            }
            if (countEl) {
              countEl.textContent = payload.count_24h ?? '0';
            }

            const items = Array.isArray(payload.items_24h) ? payload.items_24h : [];
            let latestTimestamp = null;

            window.EtnaLeaflet.addHotspotsLayer(map, items, {
              fitBounds: true,
              onMarker: (marker, item) => {
                if (item.time_utc) {
                  const ts = new Date(item.time_utc);
                  if (!Number.isNaN(ts.getTime())) {
                    if (!latestTimestamp || ts > latestTimestamp) {
                      latestTimestamp = ts;
                    }
                  }
                }
                const brightness = window.EtnaLeaflet.getHotspotBrightness(item);
                const unit = item?.intensity?.unit ?? '';
                const frp = item?.intensity?.frp;
                const tooltip = `${brightness == null ? '‚Äî' : brightness.toFixed(1)} ${unit} ‚Ä¢ ${frp == null ? '‚Äî' : frp.toFixed(1)} MW`;
                marker.bindTooltip(tooltip, { direction: 'top', opacity: 0.9 });
              },
            });

            if (latestTimestamp && latestEl) {
              latestEl.textContent = latestTimestamp.toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'UTC',
                timeZoneName: 'short',
              });
            }
            setLabelVisible(true);
          })
          .catch(() => null)
          .finally(() => setLoaderVisible(false));

        fetch('/api/copernicus/latest', { headers: { Accept: 'application/json' } })
          .then((response) => response.json())
          .then((payload) => updateCopernicusMeta(payload))
          .catch(() => null);
      }

      const modal = document.querySelector('[data-modal]');
      const modalOpen = document.querySelector('[data-modal-open]');
      const modalCloseButtons = document.querySelectorAll('[data-modal-close]');

      if (modal && modalOpen) {
        const openModal = () => {
          modal.hidden = false;
          modal.classList.add('is-open');
        };
        const closeModal = () => {
          modal.classList.remove('is-open');
          modal.hidden = true;
        };
        modalOpen.addEventListener('click', openModal);
        modalCloseButtons.forEach((button) => button.addEventListener('click', closeModal));
      }
    });
  </script>
{% endblock %}
