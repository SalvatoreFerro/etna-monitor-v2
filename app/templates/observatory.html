{% extends "layout.html" %}

{% block head_extra %}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
{% endblock %}

{% block content %}
{% from "partials/leaflet_map.html" import etna_map_shell, etna_hotspots_legend %}
  <section class="observatory-hero">
    <div class="container">
      <div class="observatory-header">
        <span class="observatory-pill">üõ∞Ô∏è Osservatorio multisorgente</span>
        <h1>Osservatorio Etna: tremore, hotspot NASA e Copernicus Smart View</h1>
        <p>
          Una vista unica per monitorare il vulcano con dati INGV, anomalie termiche NASA FIRMS e
          immagini satellitari Copernicus Smart View (Sentinel-2 ottico + fallback Sentinel-1 radar).
        </p>
      </div>
    </div>
  </section>

  <section class="observatory-grid">
    <div class="container">
      <div class="observatory-columns">
        <article class="observatory-card observatory-card--tremor">
          <header class="observatory-card__header">
            <div>
              <h2>Tremore</h2>
              <p>Grafico INGV aggiornato automaticamente.</p>
            </div>
            <div class="observatory-card__meta">
              <span>Ultimo aggiornamento</span>
              <strong>{{ latest_timestamp_display or '‚Äî' }}</strong>
            </div>
          </header>
          <div class="observatory-card__body">
            <div class="chart-card" id="grafico-etna">
              <div class="chart-card__status">
                <div class="chart-range-selector" role="group" aria-label="Intervallo temporale">
                  <button type="button" class="chart-range-btn" data-limit="288">24h</button>
                  <button type="button" class="chart-range-btn" data-limit="864">3 giorni</button>
                  <button type="button" class="chart-range-btn is-active" data-limit="2016">7 giorni</button>
                </div>
                <div class="chart-interaction-controls" role="group" aria-label="Controlli analisi grafico">
                  <button
                    type="button"
                    id="chart-analyze-toggle"
                    class="btn btn-secondary btn-sm chart-interaction-toggle"
                  >
                    Analizza
                  </button>
                  <button
                    type="button"
                    id="chart-reset-view"
                    class="btn btn-ghost btn-sm chart-interaction-reset"
                  >
                    Reset vista
                  </button>
                  <span id="chart-analyze-hint" class="chart-interaction-hint" role="status" aria-live="polite">
                    Suggerimento: premi Analizza e trascina sul grafico per selezionare un intervallo.
                  </span>
                  <span id="chart-analyze-status" class="chart-mode-indicator" aria-live="polite" aria-hidden="true">
                    Modalit√† analisi attiva
                  </span>
                </div>
              </div>
              {% if csv_snapshot.has_data %}
                <div id="home-preview-loading" class="chart-loading" aria-live="polite">
                  <div class="chart-spinner" aria-hidden="true">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                  <p>Caricamento dati INGV‚Ä¶</p>
                </div>
                <div id="home-preview-plot" aria-hidden="true"></div>
                {% if preview_rows %}
                  <script id="home-bootstrap-data" type="application/json" nonce="{{ csp_nonce() }}">
                    {{ preview_rows | tojson(indent=0) | safe }}
                  </script>
                {% endif %}
              {% else %}
                <div class="chart-loading" aria-live="polite">
                  <p><strong>Dati in preparazione</strong></p>
                  <p>
                    Il file <code>{{ csv_snapshot.path }}</code> risulta temporaneamente vuoto (motivo: {{ csv_snapshot.placeholder_reason }}).
                    Riprova pi√π tardi: il grafico si popoler√† automaticamente.
                  </p>
                </div>
              {% endif %}
            </div>
            <div class="observatory-tremor-meta">
              <div class="observatory-kpi">
                <span>Ultimo aggiornamento</span>
                <strong id="live-last-update">{{ latest_timestamp_display or '--' }}</strong>
              </div>
              <div class="observatory-kpi">
                <span>Campioni elaborati</span>
                <strong id="live-data-points">{{ data_points_count or '--' }}</strong>
              </div>
              <div class="observatory-kpi">
                <span>Stato</span>
                <strong>
                  <span class="status-dot" id="live-status-indicator" aria-hidden="true"></span>
                  <span id="live-status-text">Connessione in corso‚Ä¶</span>
                </strong>
              </div>
              <div class="observatory-kpi">
                <span>Attivit√†</span>
                <strong><span id="live-activity-badge" class="activity-badge">In caricamento‚Ä¶</span></strong>
              </div>
              <button id="btn-aggiorna-dati-live" class="btn btn-primary btn-sm" type="button">Aggiorna dati live</button>
            </div>
          </div>
        </article>

        <article class="observatory-card observatory-card--satellite">
          <header class="observatory-card__header">
            <div>
              <h2>Mappa satellitare</h2>
              <p>Hotspot NASA FIRMS e Copernicus Smart View in un‚Äôunica vista.</p>
            </div>
            <div class="observatory-card__meta">
              <span>Ultimo aggiornamento Copernicus</span>
              <strong>{{ copernicus_updated_display or '‚Äî' }}</strong>
            </div>
          </header>
          <div class="observatory-card__body">
            {% call etna_map_shell(
              'observatory-map',
              'observatory-map-label',
              'observatory-map-loader',
              'Hotspot FIRMS e Copernicus Smart View sull‚ÄôEtna',
              aria_label='Mappa hotspot FIRMS e footprint Copernicus'
            ) %}
              {{ etna_hotspots_legend() }}
            {% endcall %}
            <div class="observatory-map-meta">
              <div class="observatory-map-meta-group">
                <div class="observatory-map-meta-title">Hotspot NASA FIRMS</div>
                <div class="observatory-kpi-grid">
                  <div class="observatory-kpi">
                    <span>Ultimo aggiornamento</span>
                    <strong>{{ hotspots_summary.last_fetch_display or '‚Äî' }}</strong>
                  </div>
                  <div class="observatory-kpi">
                    <span>Hotspot ultime 24h</span>
                    <strong id="observatory-hotspots-count">{{ hotspots_summary.count_24h or '0' }}</strong>
                  </div>
                  <div class="observatory-kpi">
                    <span>Hotspot pi√π recente</span>
                    <strong id="observatory-hotspots-latest">{{ hotspots_summary.latest_acquired_display or '‚Äî' }}</strong>
                  </div>
                </div>
              </div>
              <div class="observatory-map-meta-group">
                <div class="observatory-map-meta-title">Copernicus Smart View</div>
                <div class="observatory-copernicus-status-card">
                  <span class="observatory-badge {{ copernicus_source_badge_class }}" id="observatory-copernicus-status-badge">
                    {{ copernicus_source_label }}
                  </span>
                  <p class="observatory-copernicus-status-message" id="observatory-copernicus-status-message">
                    Ultima immagine disponibile: {{ copernicus_updated_display or '‚Äî' }}.
                  </p>
                </div>
                <div class="observatory-copernicus-badges" id="observatory-copernicus-badges">
                  {% if copernicus_s2_cloud_high %}
                    <span class="observatory-badge observatory-badge--warning">Nuvolosit√† alta</span>
                  {% endif %}
                </div>
                <details class="observatory-copernicus-details">
                  <summary>Dettagli Copernicus</summary>
                  <div class="observatory-copernicus-meta">
                    <div>
                      <span>Sentinel-2 acquisizione (UTC)</span>
                      <strong id="observatory-copernicus-acquired">{{ copernicus_s2_acquired_display or '‚Äî' }}</strong>
                    </div>
                    <div>
                      <span>Sentinel-2 copertura nuvolosa</span>
                      <strong id="observatory-copernicus-cloud">
                        {% if copernicus_s2_cloud_cover is not none %}
                          {{ '%.1f' | format(copernicus_s2_cloud_cover) }}%
                        {% else %}
                          ‚Äî
                        {% endif %}
                      </strong>
                    </div>
                    <div>
                      <span>Sentinel-2 product ID</span>
                      <strong id="observatory-copernicus-product">
                        {% if copernicus_s2_product_id %}
                          {{ copernicus_s2_product_id }}
                        {% else %}
                          ‚Äî
                        {% endif %}
                      </strong>
                    </div>
                    <div>
                      <span>Sentinel-1 acquisizione (UTC)</span>
                      <strong>{{ copernicus_s1_acquired_display or '‚Äî' }}</strong>
                    </div>
                    <div>
                      <span>Sentinel-1 product ID</span>
                      <strong>{{ copernicus_s1_product_id or '‚Äî' }}</strong>
                    </div>
                    <div>
                      <span>BBOX (EPSG:4326)</span>
                      <strong id="observatory-copernicus-bbox">
                        {% if copernicus_bbox %}
                          {{ copernicus_bbox | join(', ') }}
                        {% else %}
                          ‚Äî
                        {% endif %}
                      </strong>
                    </div>
                    <div>
                      <span>Ultimo aggiornamento</span>
                      <strong id="observatory-copernicus-updated">{{ copernicus_updated_display or '‚Äî' }}</strong>
                    </div>
                    <div>
                      <span>Fonte dati</span>
                      <strong>Copernicus Data Space</strong>
                    </div>
                  </div>
                </details>
              </div>
            </div>
            <div class="observatory-image">
              <div class="observatory-image__frame is-loading" id="observatory-copernicus-image">
                <img
                  id="observatory-copernicus-img"
                  src="{{ copernicus_preview_url ~ ('?v=' ~ copernicus_preview_epoch if copernicus_preview_epoch else '') if copernicus_preview_url else '' }}"
                  alt="Immagine satellitare Copernicus dell'Etna"
                  loading="lazy"
                  decoding="async"
                />
                <div class="observatory-image__overlay">
                  <span class="observatory-summit-marker" aria-hidden="true"></span>
                  <span class="observatory-summit-label">Etna summit</span>
                </div>
              </div>
              {% if copernicus_fallback_note %}
                <p class="observatory-copernicus-fallback-note" id="observatory-copernicus-note">
                  {{ copernicus_fallback_note }}
                </p>
              {% endif %}
            </div>
            <p class="observatory-note">
              Copernicus Smart View: Sentinel-2 ottico quando possibile, fallback Sentinel-1 radar in caso di nuvole.
            </p>
            <div class="observatory-card__footer">
              {% if config.HOTSPOTS_ENABLED %}
                <a class="btn btn-secondary" href="{{ url_for('main.hotspots') }}">Apri pagina hotspot</a>
              {% endif %}
              <button
                type="button"
                class="btn btn-secondary"
                data-modal-open
                id="observatory-copernicus-open"
              >
                Apri grande
              </button>
            </div>
          </div>
        </article>

        <article class="observatory-card observatory-card--swir">
          <header class="observatory-card__header">
            <div>
              <h2>Osservatorio Satellitare (SWIR)</h2>
              <p>Vista multispettrale SWIR (Short-Wave Infrared) utile per evidenziare anomalie e contrasti del terreno.</p>
            </div>
            <div class="observatory-card__meta">
              <span>Ultimo aggiornamento</span>
              <strong>{{ swir_last_updated_display or '‚Äî' }}</strong>
            </div>
          </header>
          <div class="observatory-card__body">
            <div class="observatory-swir-meta">
              <span class="observatory-badge {{ swir_status_class }}">{{ swir_status_label }}</span>
              <div class="observatory-copernicus-badges">
                <span class="observatory-badge observatory-badge--info">Copernicus Sentinel-2</span>
                <span class="observatory-badge observatory-badge--fallback">Layer: SWIR</span>
              </div>
            </div>
            <p class="observatory-note">{{ swir_status_message }}</p>
            <div class="observatory-image observatory-image--swir">
              {% if swir_image_available and swir_image_url %}
                <div class="observatory-image__frame">
                  <img
                    src="{{ swir_image_url ~ ('?v=' ~ swir_cache_bust if swir_cache_bust else '') }}"
                    alt="Immagine Sentinel-2 SWIR dell'Etna"
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              {% else %}
                <div class="observatory-image__fallback">
                  <div class="observatory-image__status">Immagine SWIR non disponibile</div>
                  <div class="observatory-image__detail">L‚Äôanteprima verr√† aggiornata automaticamente appena disponibile.</div>
                </div>
              {% endif %}
            </div>
            <p class="observatory-attribution">
              Contains modified Copernicus Sentinel data (Sentinel-2), processed via Sentinel Hub.
            </p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <div class="observatory-modal" data-modal hidden>
    <div class="observatory-modal__backdrop" data-modal-close></div>
    <div class="observatory-modal__content" role="dialog" aria-modal="true" aria-label="Immagine Copernicus">
      <button class="observatory-modal__close" type="button" data-modal-close aria-label="Chiudi">√ó</button>
      <img
        id="observatory-copernicus-modal-image"
        src="{{ copernicus_preview_url ~ ('?v=' ~ copernicus_preview_epoch if copernicus_preview_epoch else '') if copernicus_preview_url else '' }}"
        alt="Immagine satellitare Copernicus dell'Etna in formato grande"
        loading="lazy"
        decoding="async"
      />
    </div>
  </div>
{% endblock %}

{% block head %}
  <script defer src="{{ url_for('static', filename='js/plotly.min.js') }}?v={{ STATIC_ASSET_VERSION }}"></script>
  <script defer src="{{ url_for('static', filename='js/chart.js') }}?v={{ STATIC_ASSET_VERSION }}"></script>
  <script defer src="{{ url_for('static', filename='js/leaflet_common.js') }}?v={{ STATIC_ASSET_VERSION }}"></script>
  <script
    defer
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', () => {
      const copernicusBbox = {{ copernicus_bbox | tojson }};
      const mapElement = document.getElementById('observatory-map');
      const modal = document.querySelector('[data-modal]');
      const modalOpen = document.querySelector('[data-modal-open]');
      const modalCloseButtons = document.querySelectorAll('[data-modal-close]');
      const imageFrame = document.getElementById('observatory-copernicus-image');
      const imageEl = document.getElementById('observatory-copernicus-img');
      const modalImage = document.getElementById('observatory-copernicus-modal-image');

      let map = null;
      let copernicusFootprint = null;

      const countEl = document.getElementById('observatory-hotspots-count');
      const latestEl = document.getElementById('observatory-hotspots-latest');
      const labelEl = document.getElementById('observatory-map-label');
      const loaderEl = document.getElementById('observatory-map-loader');

      const setLoaderVisible = (visible) => {
        if (!loaderEl) {
          return;
        }
        loaderEl.classList.toggle('is-visible', visible);
      };

      const setLabelVisible = (element, visible) => {
        if (!element) {
          return;
        }
        element.classList.toggle('is-visible', visible);
      };

      const updateCopernicusFootprint = (targetMap, bbox, options) => {
        if (!targetMap || !bbox || !window.EtnaLeaflet?.addCopernicusFootprint) {
          return null;
        }
        return window.EtnaLeaflet.addCopernicusFootprint(targetMap, bbox, options);
      };

      if (mapElement && window.EtnaLeaflet) {
        map = window.EtnaLeaflet.createEtnaMap(mapElement, {
          addFirmsBadge: true,
        });

        copernicusFootprint = updateCopernicusFootprint(map, copernicusBbox, {
          color: '#38bdf8',
          fillColor: '#38bdf8',
        });
        window.EtnaLeaflet.addEtnaMarker(map);
      }

      if (map) {
        setLoaderVisible(true);
        fetch('/api/hotspots/latest?mode=all', { headers: { Accept: 'application/json' } })
          .then((response) => response.json())
          .then((payload) => {
            if (!payload || !payload.available || !map) {
              return;
            }
            if (countEl) {
              countEl.textContent = payload.count_24h ?? '0';
            }

            const items = Array.isArray(payload.items_24h) ? payload.items_24h : [];
            let latestTimestamp = null;

            window.EtnaLeaflet.addHotspotsLayer(map, items, {
              fitBounds: true,
              onMarker: (marker, item) => {
                if (item.time_utc) {
                  const ts = new Date(item.time_utc);
                  if (!Number.isNaN(ts.getTime())) {
                    if (!latestTimestamp || ts > latestTimestamp) {
                      latestTimestamp = ts;
                    }
                  }
                }
                const brightness = window.EtnaLeaflet.getHotspotBrightness(item);
                const unit = item?.intensity?.unit ?? '';
                const frp = item?.intensity?.frp;
                const tooltip = `${brightness == null ? '‚Äî' : brightness.toFixed(1)} ${unit} ‚Ä¢ ${frp == null ? '‚Äî' : frp.toFixed(1)} MW`;
                marker.bindTooltip(tooltip, { direction: 'top', opacity: 0.9 });
              },
            });

            if (latestTimestamp && latestEl) {
              latestEl.textContent = latestTimestamp.toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'UTC',
                timeZoneName: 'short',
              });
            }
            setLabelVisible(labelEl, true);
          })
          .catch(() => null)
          .finally(() => setLoaderVisible(false));
      }

      if (imageEl && imageFrame) {
        const handleLoad = () => imageFrame.classList.remove('is-loading');
        if (imageEl.complete) {
          handleLoad();
        } else {
          imageEl.addEventListener('load', handleLoad, { once: true });
          imageEl.addEventListener('error', handleLoad, { once: true });
        }
      }

      if (modal && modalOpen) {
        const openModal = () => {
          if (modalOpen.disabled) {
            return;
          }
          modal.hidden = false;
          modal.classList.add('is-open');
        };
        const closeModal = () => {
          modal.classList.remove('is-open');
          modal.hidden = true;
        };
        modalOpen.addEventListener('click', openModal);
        modalCloseButtons.forEach((button) => button.addEventListener('click', closeModal));
      }
    });
  </script>
{% endblock %}
