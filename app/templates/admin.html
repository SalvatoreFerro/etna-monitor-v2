{% extends "layout.html" %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}?v={{ STATIC_ASSET_VERSION }}">
  <script src="{{ url_for('static', filename='vendor/plotly.min.js') }}" nonce="{{ csp_nonce() }}"></script>
{% endblock %}

{% block content %}
<section class="admin-page admin-container" aria-labelledby="admin-dashboard-title">
  <header class="admin-card admin-card--hero card-premium animate-premium-fade admin-header" id="admin-dashboard-title">
    <div>
      <h1><i class="fas fa-users-cog"></i> Pannello Admin</h1>
      <p>Gestisci utenti, sponsor e sicurezza con una panoramica aggiornata.</p>
    </div>
    <nav class="admin-actions" aria-label="Azioni rapide amministratore">
      <a href="{{ url_for('admin.theme_manager') }}" class="btn btn-premium btn-sm"><i class="fas fa-palette"></i> Gestione Template</a>
      <a href="{{ url_for('admin.donations') }}" class="btn btn-secondary glass btn-sm"><i class="fas fa-donate"></i> Donazioni in verifica</a>
      <a href="{{ url_for('admin.premium_requests') }}" class="btn btn-secondary glass btn-sm"><i class="fas fa-star"></i> Richieste Premium</a>
      <a href="{{ url_for('admin.banner_list') }}" class="btn btn-secondary glass btn-sm"><i class="fas fa-image"></i> Banner sponsor</a>
      <a href="{{ url_for('admin.sponsor_analytics') }}" class="btn btn-secondary glass btn-sm"><i class="fas fa-chart-line"></i> Sponsor analytics</a>
      <a href="{{ url_for('admin.partners_dashboard') }}" class="btn btn-secondary glass btn-sm"><i class="fas fa-handshake"></i> Partner Experience</a>
    </nav>
  </header>

  {% if admin_shortcuts %}
  <section class="admin-card admin-card--shortcuts card-premium animate-premium-slide" aria-labelledby="admin-shortcuts-title">
    <header class="admin-section-header">
      <div>
        <h2 id="admin-shortcuts-title"><i class="fas fa-toolbox"></i> Strumenti rapidi</h2>
        <p>Trova in un solo posto tutte le funzionalità riservate agli amministratori.</p>
      </div>
    </header>
    <div class="admin-shortcuts-grid">
      {% for shortcut in admin_shortcuts %}
        <a class="admin-shortcut" href="{{ shortcut.url }}">
          <span class="admin-shortcut__icon" aria-hidden="true"><i class="fas {{ shortcut.icon }}"></i></span>
          <span class="admin-shortcut__content">
            <span class="admin-shortcut__label">{{ shortcut.label }}</span>
            <span class="admin-shortcut__description">{{ shortcut.description }}</span>
          </span>
          {% set badge_value = shortcut.get('badge') %}
          {% if badge_value is not none %}
            <span class="admin-shortcut__badge" aria-label="{{ shortcut.get('badge_label', 'Totale elementi') }}">{{ badge_value }}</span>
          {% endif %}
        </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <section class="admin-card admin-card--metrics card-premium animate-premium-slide" aria-labelledby="admin-analytics-title">
    <header class="admin-section-header">
      <div>
        <h2 id="admin-analytics-title"><i class="fas fa-chart-pie"></i> Analytics</h2>
        <p>Panoramica aggiornata delle metriche principali.</p>
      </div>
      <span class="admin-caption" data-analytics-updated>In aggiornamento…</span>
    </header>
    <div class="admin-analytics-grid">
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Utenti totali</span>
        <span class="admin-analytics-value" data-analytics-total>{{ total_users }}</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Utenti Premium</span>
        <span class="admin-analytics-value" data-analytics-premium>—</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Utenti Free</span>
        <span class="admin-analytics-value" data-analytics-free>—</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Alert (24h)</span>
        <span class="admin-analytics-value" data-analytics-alerts>—</span>
      </div>
    </div>
    <p class="admin-caption">Aggiornamento automatico ogni 5 minuti.</p>
  </section>

  <section class="admin-card admin-card--metrics card-premium animate-premium-slide" aria-labelledby="admin-system-health-title">
    <header class="admin-section-header">
      <div>
        <h2 id="admin-system-health-title"><i class="fas fa-heartbeat"></i> System health</h2>
        <p>Monitoraggio aggiornamento curva.csv e pipeline INGV.</p>
      </div>
    </header>
    <div class="admin-analytics-grid">
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Ultimo update CSV</span>
        <span class="admin-analytics-value">{{ csv_metrics.last_update_at or '—' }}</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Row count ultimo update</span>
        <span class="admin-analytics-value">{{ csv_metrics.last_update_row_count or '—' }}</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Timestamp ultimo dato</span>
        <span class="admin-analytics-value">{{ csv_metrics.last_update_data_timestamp or '—' }}</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Ultimo errore</span>
        <span class="admin-analytics-value">{{ csv_metrics.last_update_error or '—' }}</span>
      </div>
    </div>
  </section>

  <section class="admin-card admin-card--user-analytics card-premium animate-premium-slide" aria-labelledby="admin-user-analytics-title" data-user-analytics>
    <header class="admin-section-header admin-section-header--split">
      <div>
        <h2 id="admin-user-analytics-title"><i class="fas fa-chart-area"></i> Analytics utenti</h2>
        <p>Analizza trend iscrizioni, attivazioni Telegram e segmentazione utenti.</p>
      </div>
      <div class="admin-analytics-meta">
        <span class="admin-caption" data-user-analytics-updated>In attesa di aggiornamento…</span>
        <p class="admin-analytics-error" data-user-analytics-error hidden>Analytics temporaneamente non disponibili.</p>
      </div>
    </header>

    <div class="admin-analytics-filters" role="search">
      <label class="admin-field">
        <span class="admin-field__label">Periodo</span>
        <select name="analytics_period" data-user-analytics-period>
          <option value="7">Ultimi 7 giorni</option>
          <option value="30" selected>Ultimi 30 giorni</option>
          <option value="90">Ultimi 90 giorni</option>
        </select>
      </label>
      <label class="admin-field">
        <span class="admin-field__label">Telegram</span>
        <select name="analytics_telegram" data-user-analytics-telegram>
          <option value="all" selected>Tutti</option>
          <option value="yes">Collegato</option>
          <option value="no">Non collegato</option>
        </select>
      </label>
      <label class="admin-field">
        <span class="admin-field__label">Premium</span>
        <select name="analytics_premium" data-user-analytics-premium>
          <option value="all" selected>Tutti</option>
          <option value="yes">Premium</option>
          <option value="no">Free</option>
        </select>
      </label>
      <button type="button" class="btn btn-secondary glass btn-sm" data-user-analytics-refresh>
        <i class="fas fa-rotate"></i> Aggiorna
      </button>
    </div>

    <div class="admin-analytics-grid admin-analytics-grid--expanded">
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Utenti totali</span>
        <span class="admin-analytics-value" data-user-analytics-total>—</span>
        <span class="admin-analytics-note" data-user-analytics-premium-split>—</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Nuovi utenti (24h)</span>
        <span class="admin-analytics-value" data-user-analytics-24h>—</span>
        <span class="admin-analytics-note">Iscrizioni ultime 24 ore</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Nuovi utenti (7 giorni)</span>
        <span class="admin-analytics-value" data-user-analytics-7d>—</span>
        <span class="admin-analytics-note">Ultimi 7 giorni</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Nuovi utenti (30 giorni)</span>
        <span class="admin-analytics-value" data-user-analytics-30d>—</span>
        <span class="admin-analytics-note">Ultimi 30 giorni</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Telegram collegato</span>
        <span class="admin-analytics-value" data-user-analytics-telegram-count>—</span>
        <span class="admin-analytics-note" data-user-analytics-telegram-pct>—</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Attivazione Telegram (7 giorni)</span>
        <span class="admin-analytics-value" data-user-analytics-telegram-recent>—</span>
        <span class="admin-analytics-note">Su nuovi utenti recenti</span>
      </div>
    </div>

    <div class="admin-analytics-chart" id="user-analytics-chart" aria-label="Trend iscrizioni ultimi 30 giorni"></div>
    <p class="admin-caption" data-user-analytics-summary>Caricamento elenco utenti in corso…</p>

    <div class="admin-table-wrapper admin-table-wrapper--analytics">
      <table class="table table-premium admin-table admin-table--analytics">
        <thead>
          <tr>
            <th scope="col"><button type="button" class="admin-sort" data-sort-key="email">Email</button></th>
            <th scope="col"><button type="button" class="admin-sort" data-sort-key="created_at">Data creazione</button></th>
            <th scope="col"><button type="button" class="admin-sort" data-sort-key="plan">Tipo account</button></th>
            <th scope="col"><button type="button" class="admin-sort" data-sort-key="telegram_connected">Telegram</button></th>
            <th scope="col"><button type="button" class="admin-sort" data-sort-key="threshold">Soglia</button></th>
            <th scope="col"><button type="button" class="admin-sort" data-sort-key="last_access">Ultimo accesso</button></th>
          </tr>
        </thead>
        <tbody data-user-analytics-table aria-live="polite"></tbody>
      </table>
      <p class="admin-empty" data-user-analytics-empty hidden>Nessun utente disponibile con i filtri selezionati.</p>
    </div>
  </section>

  <div class="admin-card admin-card--table card-premium animate-premium-slide">
    <header class="admin-toolbar">
      <div class="admin-toolbar__primary">
        <button type="button" id="admin-test-alert-button" class="btn btn-premium">
          <i class="fas fa-bell"></i> Test Alert
        </button>
        <p class="admin-caption" id="admin-test-alert-caption">Esegue immediatamente il controllo degli alert Telegram.</p>
      </div>
      <div class="admin-toolbar__filters" role="search">
        <label class="admin-field">
          <span class="admin-field__label">Ricerca per email</span>
          <input type="search" name="q" autocomplete="off" placeholder="es. mario@etna.it" value="{{ search_query }}" data-admin-search>
        </label>
        <label class="admin-field">
          <span class="admin-field__label">Tipo account</span>
          <select name="plan" data-admin-plan>
            <option value="all" {% if plan_filter == 'all' %}selected{% endif %}>Tutti</option>
            <option value="premium" {% if plan_filter == 'premium' %}selected{% endif %}>Premium</option>
            <option value="free" {% if plan_filter == 'free' %}selected{% endif %}>Free</option>
            <option value="admin" {% if plan_filter == 'admin' %}selected{% endif %}>Solo admin</option>
          </select>
        </label>
        <p class="admin-caption admin-toolbar__summary" data-users-summary>Totale utenti: {{ total_users }}</p>
      </div>
    </header>

    <div class="admin-table-wrapper" data-users-wrapper>
      <table class="table table-premium admin-table">
        <thead>
          <tr>
            <th scope="col">Email</th>
            <th scope="col">Tipo account</th>
            <th scope="col">Soglia personalizzata</th>
            <th scope="col">ID Chat</th>
            <th scope="col">Prova gratuita</th>
            <th scope="col">Azioni</th>
          </tr>
        </thead>
        <tbody data-users-table aria-live="polite">
          {% for user in users %}
            {% set has_chat = user.telegram_chat_id or user.chat_id %}
            <tr data-user-row="{{ user.id }}">
              <td>{{ user.email }}</td>
              <td>
                <span class="badge {{ 'premium' if user.has_premium_access else 'free' }}">
                  {{ 'Premium ⭐' if user.has_premium_access else 'Gratuito' }}
                </span>
                {% if user.is_admin %}
                  <span class="badge admin">Admin</span>
                {% endif %}
              </td>
              <td>{{ user.threshold or 'Predefinita (2.0)' }} mV</td>
              <td>{{ has_chat or 'Non impostato' }}</td>
              <td>
                {% if user.free_alert_consumed %}
                  <span class="badge warning">Consumata</span>
                {% else %}
                  <span class="badge success">Disponibile</span>
                {% endif %}
                <button type="button"
                        class="btn btn-secondary glass btn-sm"
                        data-action="reset-trial"
                        data-user-id="{{ user.id }}">
                  <i class="fas fa-undo"></i> Reset prova
                </button>
              </td>
              <td>
                <div class="action-buttons">
                  <button type="button"
                          class="btn btn-secondary glass btn-sm"
                          data-action="test-alert"
                          data-user-id="{{ user.id }}"
                          {% if not has_chat %}disabled aria-disabled="true"{% endif %}>
                    <i class="fas fa-satellite-dish"></i> Test alert
                  </button>
                  <button type="button"
                          class="btn btn-premium btn-sm"
                          data-action="toggle-premium"
                          data-user-id="{{ user.id }}">
                    <i class="fas fa-{{ 'star' if not user.has_premium_access else 'star-half-alt' }}"></i>
                    {{ 'Aggiorna' if not user.has_premium_access else 'Declassa' }}
                  </button>
                  {% if not user.is_admin %}
                    <button type="button"
                            class="btn btn-danger btn-sm"
                            data-action="delete-user"
                            data-user-id="{{ user.id }}">
                      <i class="fas fa-trash"></i> Elimina
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="admin-empty" data-users-empty {% if users %}hidden{% endif %}>Nessun utente trovato con i filtri correnti.</p>
    </div>

    <footer class="admin-pagination">
      <button type="button"
              class="btn btn-secondary glass btn-sm"
              data-pagination="prev"
              {% if page <= 1 %}disabled aria-disabled="true"{% endif %}>
        <i class="fas fa-angle-left"></i> Precedente
      </button>
      <span class="admin-caption" data-pagination-label>
        Pagina {{ page }} di {{ pages or 1 }}
      </span>
      <button type="button"
              class="btn btn-secondary glass btn-sm"
              data-pagination="next"
              {% if pages is not none and page >= pages %}disabled aria-disabled="true"{% endif %}>
        Successiva <i class="fas fa-angle-right"></i>
      </button>
    </footer>
  </div>

  <section class="admin-card admin-card--alert-monitor card-premium animate-premium-slide" aria-labelledby="admin-alert-monitor-title">
    <header class="admin-section-header admin-section-header--split">
      <div>
        <h2 id="admin-alert-monitor-title"><i class="fas fa-satellite-dish"></i> Monitoraggio Alert</h2>
        <p>Dashboard operativa sulle esecuzioni del cron alert e sugli invii Telegram.</p>
      </div>
      <span class="admin-caption" data-cron-monitor-updated>In attesa di aggiornamento…</span>
    </header>

    <div class="admin-analytics-grid admin-analytics-grid--expanded">
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Ultimo run</span>
        <span class="admin-analytics-value" data-cron-kpi-last-run>—</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">OK rate 24h</span>
        <span class="admin-analytics-value" data-cron-kpi-ok-rate>—</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Sent 24h</span>
        <span class="admin-analytics-value" data-cron-kpi-sent>—</span>
      </div>
      <div class="admin-analytics-metric">
        <span class="admin-analytics-label">Errori 24h</span>
        <span class="admin-analytics-value" data-cron-kpi-errors>—</span>
      </div>
    </div>

    <div class="admin-analytics-filters admin-analytics-filters--cron">
      <label class="admin-field">
        <span class="admin-field__label">Periodo</span>
        <select data-cron-period>
          <option value="24h">Ultime 24h</option>
          <option value="7d">Ultimi 7 giorni</option>
          <option value="all">Sempre</option>
        </select>
      </label>
      <label class="admin-field">
        <span class="admin-field__label">Esito</span>
        <select data-cron-ok>
          <option value="">Tutti</option>
          <option value="true">OK</option>
          <option value="false">Error</option>
        </select>
      </label>
      <label class="admin-field">
        <span class="admin-field__label">Solo invii</span>
        <select data-cron-sent>
          <option value="0">Tutti</option>
          <option value="1">Sent &gt; 0</option>
        </select>
      </label>
      <button type="button" class="btn btn-secondary glass btn-sm" data-cron-refresh>
        <i class="fas fa-rotate"></i> Aggiorna
      </button>
    </div>

    <div class="admin-table-wrapper admin-table-wrapper--cron">
      <table class="table table-premium admin-table admin-table--cron">
        <thead>
          <tr>
            <th scope="col">Timestamp</th>
            <th scope="col">Esito</th>
            <th scope="col">Sent</th>
            <th scope="col">Skipped</th>
            <th scope="col">Durata</th>
          </tr>
        </thead>
        <tbody data-cron-runs-body aria-live="polite"></tbody>
      </table>
      <p class="admin-empty" data-cron-empty hidden>Nessun run disponibile con i filtri selezionati.</p>
    </div>

    <footer class="admin-pagination admin-pagination--cron">
      <button type="button" class="btn btn-secondary glass btn-sm" data-cron-page="prev">
        <i class="fas fa-angle-left"></i> Precedente
      </button>
      <span class="admin-caption" data-cron-pagination-label>Pagina 1</span>
      <button type="button" class="btn btn-secondary glass btn-sm" data-cron-page="next">
        Successiva <i class="fas fa-angle-right"></i>
      </button>
    </footer>
  </section>

  <section class="admin-grid admin-grid--columns admin-grid--activity" aria-label="Monitoraggio amministratore">
    <article class="admin-card card-premium animate-premium-fade" id="account-lifecycle">
      <header class="admin-section-header">
        <div>
          <h2><i class="fas fa-user-shield"></i> Lifecycle account &amp; GDPR</h2>
          <p>Monitoraggio delle richieste di eliminazione e delle attività di moderazione.</p>
        </div>
      </header>
      <dl class="admin-stats-list">
        <div class="admin-stats-list__item">
          <dt>Account in eliminazione</dt>
          <dd>{{ soft_deleted_count }}</dd>
        </div>
        <div class="admin-stats-list__item">
          <dt>Post da moderare</dt>
          <dd>{{ pending_post_count + draft_post_count }}</dd>
        </div>
        <div class="admin-stats-list__item">
          <dt>Moderatori attivi</dt>
          <dd>{{ moderators_count }}</dd>
        </div>
      </dl>
      <p class="admin-caption">Esegui <code>python scripts/purge_erased_accounts.py</code> per completare le cancellazioni dopo il periodo di retention.</p>
    </article>

    <article class="admin-card card-premium animate-premium-fade" id="admin-actions-card">
      <header class="admin-section-header">
        <div>
          <h2><i class="fas fa-user-shield"></i> Attività amministratore</h2>
          <p>Storico delle azioni di upgrade, reset e gestione account.</p>
        </div>
        <button type="button" class="btn btn-secondary glass btn-sm" data-admin-actions-refresh>
          <i class="fas fa-rotate"></i> Aggiorna
        </button>
      </header>
      <ol class="audit-list" data-admin-actions-list aria-live="polite" aria-busy="true"></ol>
      <p class="admin-caption" data-admin-actions-empty hidden>Nessuna attività registrata nelle ultime ore.</p>
    </article>

    <article class="admin-card card-premium animate-premium-fade">
      <header class="admin-section-header">
        <div>
          <h2 id="admin-audit-title"><i class="fas fa-clipboard-list"></i> Registro attività utenti</h2>
          <p>Monitoraggio degli ultimi eventi generati dagli utenti.</p>
        </div>
        <button type="button" class="btn btn-secondary glass btn-sm audit-refresh" data-audit-refresh>
          <i class="fas fa-rotate"></i> Aggiorna
        </button>
      </header>
      <div class="admin-metrics">
        <div class="admin-metric">
          <span class="admin-metric__label">Eventi recenti</span>
          <span class="admin-metric__value" data-metric-events-count>—</span>
          <p class="admin-metric__hint">Ultimi <span data-metric-events-limit>15</span> eventi nel registro.</p>
        </div>
        <div class="admin-metric">
          <span class="admin-metric__label">Alert (24h)</span>
          <span class="admin-metric__value" data-metric-alerts-24h>—</span>
          <p class="admin-metric__hint">Notifiche critiche inviate nelle ultime 24 ore.</p>
        </div>
      </div>
      <p class="admin-caption" id="admin-audit-updated">Aggiornamento automatico ogni minuto.</p>
      <ol class="audit-list" id="admin-audit-events" aria-live="polite" aria-busy="true"></ol>
    </article>

    <article class="admin-card card-premium animate-premium-fade">
      <header class="admin-section-header">
        <div>
          <h2 id="admin-alerts-title"><i class="fas fa-exclamation-triangle"></i> Ultimi alert</h2>
          <p>Eventi critici che hanno superato la soglia di sicurezza.</p>
        </div>
      </header>
      <ol class="audit-list" id="admin-alert-feed" aria-live="polite" aria-busy="true"></ol>
    </article>
  </section>
</section>

<div class="admin-modal" id="cron-detail-modal" hidden>
  <div class="admin-modal__backdrop" data-cron-modal-close></div>
  <div class="admin-modal__panel" role="dialog" aria-modal="true" aria-labelledby="cron-detail-title">
    <header class="admin-modal__header">
      <div>
        <h3 id="cron-detail-title">Dettaglio run cron</h3>
        <p class="admin-caption" data-cron-modal-subtitle>Caricamento…</p>
      </div>
      <button type="button" class="btn btn-secondary glass btn-sm" data-cron-modal-close>
        <i class="fas fa-xmark"></i>
      </button>
    </header>
    <div class="admin-modal__body">
      <div class="admin-modal__meta">
        <span class="badge" data-cron-modal-status>—</span>
        <span class="admin-caption" data-cron-modal-timing>—</span>
      </div>
      <div class="admin-modal__grid">
        <div>
          <span class="admin-modal__label">Errore</span>
          <span data-cron-modal-error>—</span>
        </div>
        <div>
          <span class="admin-modal__label">Exception</span>
          <span data-cron-modal-exception>—</span>
        </div>
        <div>
          <span class="admin-modal__label">Sent</span>
          <span data-cron-modal-sent>—</span>
        </div>
        <div>
          <span class="admin-modal__label">Skipped</span>
          <span data-cron-modal-skipped>—</span>
        </div>
      </div>
      <div class="admin-modal__json">
        <h4>Diagnostic JSON</h4>
        <pre data-cron-modal-json>{}</pre>
      </div>
    </div>
  </div>
</div>

<div class="audit-status" data-audit-status aria-live="polite"></div>
<div id="toast-container" class="toast-container" aria-live="assertive" aria-atomic="true"></div>

<script nonce="{{ csp_nonce() }}">
  const csrfToken = '{{ csrf_token() }}';
  const ADMIN_USERS_ENDPOINT = '{{ url_for('admin.users_list') }}';
  const ADMIN_ANALYTICS_ENDPOINT = '{{ url_for('admin_stats.get_admin_analytics') }}';
  const USER_ANALYTICS_ENDPOINT = '{{ url_for('admin_stats.get_user_analytics') }}';
  const ADMIN_ACTIONS_ENDPOINT = '{{ url_for('admin_stats.get_admin_actions') }}';
  const ADMIN_AUDIT_ENDPOINT = '{{ url_for('admin_stats.get_audit_feed') }}';
  const ADMIN_GLOBAL_TEST_ENDPOINT = '{{ url_for('admin.test_alert') }}';
  const ADMIN_CRON_RUNS_ENDPOINT = '{{ url_for('admin.get_cron_runs') }}';

  const initialUsers = {{ initial_users|tojson }};
  const initialState = {
    page: {{ page|int }},
    pages: {{ pages|int if pages is not none else 0 }},
    plan: {{ plan_filter|tojson }},
    search: {{ search_query|tojson }},
    perPage: {{ per_page|int }},
    total: {{ total_users|int }},
  };

  (function () {
    'use strict';

    const state = { ...initialState, items: Array.isArray(initialUsers) ? initialUsers : [] };
    const cronState = {
      limit: 20,
      offset: 0,
      ok: '',
      sentGt: 0,
      period: '24h',
      total: 0,
    };

    const tableBody = document.querySelector('[data-users-table]');
    const emptyState = document.querySelector('[data-users-empty]');
    const resultsSummary = document.querySelector('[data-users-summary]');
    const paginationLabel = document.querySelector('[data-pagination-label]');
    const prevButton = document.querySelector('[data-pagination="prev"]');
    const nextButton = document.querySelector('[data-pagination="next"]');
    const searchInput = document.querySelector('[data-admin-search]');
    const planSelect = document.querySelector('[data-admin-plan]');
    const usersWrapper = document.querySelector('[data-users-wrapper]');
    const toastContainer = document.getElementById('toast-container');
    const analyticsTotal = document.querySelector('[data-analytics-total]');
    const analyticsPremium = document.querySelector('[data-analytics-premium]');
    const analyticsFree = document.querySelector('[data-analytics-free]');
    const analyticsAlerts = document.querySelector('[data-analytics-alerts]');
    const analyticsUpdated = document.querySelector('[data-analytics-updated]');
    const adminActionsList = document.querySelector('[data-admin-actions-list]');
    const adminActionsEmpty = document.querySelector('[data-admin-actions-empty]');
    const adminActionsRefresh = document.querySelector('[data-admin-actions-refresh]');
    const auditStatus = document.querySelector('[data-audit-status]');
    const globalTestButton = document.getElementById('admin-test-alert-button');
    const globalTestCaption = document.getElementById('admin-test-alert-caption');
    const userAnalyticsSection = document.querySelector('[data-user-analytics]');
    const userAnalyticsUpdated = document.querySelector('[data-user-analytics-updated]');
    const userAnalyticsError = document.querySelector('[data-user-analytics-error]');
    const userAnalyticsSummary = document.querySelector('[data-user-analytics-summary]');
    const userAnalyticsTable = document.querySelector('[data-user-analytics-table]');
    const userAnalyticsTableContainer = document.querySelector('.admin-table--analytics');
    const userAnalyticsEmpty = document.querySelector('[data-user-analytics-empty]');
    const userAnalyticsChart = document.getElementById('user-analytics-chart');
    const userAnalyticsPeriod = document.querySelector('[data-user-analytics-period]');
    const userAnalyticsTelegram = document.querySelector('[data-user-analytics-telegram]');
    const userAnalyticsPremium = document.querySelector('[data-user-analytics-premium]');
    const userAnalyticsRefresh = document.querySelector('[data-user-analytics-refresh]');
    const userAnalyticsTotal = document.querySelector('[data-user-analytics-total]');
    const userAnalytics24h = document.querySelector('[data-user-analytics-24h]');
    const userAnalytics7d = document.querySelector('[data-user-analytics-7d]');
    const userAnalytics30d = document.querySelector('[data-user-analytics-30d]');
    const userAnalyticsPremiumSplit = document.querySelector('[data-user-analytics-premium-split]');
    const userAnalyticsTelegramCount = document.querySelector('[data-user-analytics-telegram-count]');
    const userAnalyticsTelegramPct = document.querySelector('[data-user-analytics-telegram-pct]');
    const userAnalyticsTelegramRecent = document.querySelector('[data-user-analytics-telegram-recent]');
    const cronUpdatedLabel = document.querySelector('[data-cron-monitor-updated]');
    const cronKpiLastRun = document.querySelector('[data-cron-kpi-last-run]');
    const cronKpiOkRate = document.querySelector('[data-cron-kpi-ok-rate]');
    const cronKpiSent = document.querySelector('[data-cron-kpi-sent]');
    const cronKpiErrors = document.querySelector('[data-cron-kpi-errors]');
    const cronPeriodSelect = document.querySelector('[data-cron-period]');
    const cronOkSelect = document.querySelector('[data-cron-ok]');
    const cronSentSelect = document.querySelector('[data-cron-sent]');
    const cronRefreshButton = document.querySelector('[data-cron-refresh]');
    const cronTableBody = document.querySelector('[data-cron-runs-body]');
    const cronEmpty = document.querySelector('[data-cron-empty]');
    const cronPaginationLabel = document.querySelector('[data-cron-pagination-label]');
    const cronPrevButton = document.querySelector('[data-cron-page=\"prev\"]');
    const cronNextButton = document.querySelector('[data-cron-page=\"next\"]');
    const cronModal = document.getElementById('cron-detail-modal');
    const cronModalSubtitle = document.querySelector('[data-cron-modal-subtitle]');
    const cronModalStatus = document.querySelector('[data-cron-modal-status]');
    const cronModalTiming = document.querySelector('[data-cron-modal-timing]');
    const cronModalError = document.querySelector('[data-cron-modal-error]');
    const cronModalException = document.querySelector('[data-cron-modal-exception]');
    const cronModalSent = document.querySelector('[data-cron-modal-sent]');
    const cronModalSkipped = document.querySelector('[data-cron-modal-skipped]');
    const cronModalJson = document.querySelector('[data-cron-modal-json]');
    const cronModalClose = document.querySelectorAll('[data-cron-modal-close]');

    let analyticsTimer = null;
    let adminActionsTimer = null;
    let auditTimer = null;
    let auditRefresher = null;

    function escapeHtml(value) {
      if (value === null || value === undefined) {
        return '';
      }
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatDateTime(value) {
      if (!value) {
        return '—';
      }
      try {
        const date = value instanceof Date ? value : new Date(value);
        if (Number.isNaN(date.getTime())) {
          return value;
        }
        return new Intl.DateTimeFormat(navigator.language || 'it-IT', {
          year: 'numeric',
          month: 'short',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
        }).format(date);
      } catch (error) {
        return value;
      }
    }

    function createToast(message, type = 'info') {
      if (!toastContainer) {
        window.alert(message);
        return;
      }

      const toast = document.createElement('div');
      toast.className = `toast toast--${type}`;

      const iconMap = {
        success: 'fa-circle-check',
        error: 'fa-circle-xmark',
        info: 'fa-circle-info',
      };
      const icon = iconMap[type] || iconMap.info;
      toast.innerHTML = `
        <span class="toast-icon"><i class="fas ${icon}"></i></span>
        <span class="toast-message">${escapeHtml(message)}</span>
        <button type="button" class="toast-dismiss" aria-label="Chiudi notifica">&times;</button>
      `;

      toastContainer.appendChild(toast);

      const removeToast = () => {
        toast.classList.add('toast--leaving');
        window.setTimeout(() => {
          if (toast.parentElement === toastContainer) {
            toastContainer.removeChild(toast);
          }
        }, 300);
      };

      toast.querySelector('.toast-dismiss')?.addEventListener('click', removeToast, { once: true });
      window.setTimeout(removeToast, 4500);
    }

    function formatDuration(value) {
      if (!value && value !== 0) {
        return '—';
      }
      const ms = Number(value);
      if (Number.isNaN(ms)) {
        return '—';
      }
      if (ms < 1000) {
        return `${Math.round(ms)} ms`;
      }
      return `${(ms / 1000).toFixed(2)} s`;
    }

    function updateCronMetrics(metrics) {
      if (!metrics) {
        return;
      }
      if (cronKpiLastRun) {
        cronKpiLastRun.textContent = metrics.last_run_at ? formatDateTime(metrics.last_run_at) : '—';
      }
      if (cronKpiOkRate) {
        cronKpiOkRate.textContent = metrics.ok_rate_24h !== null && metrics.ok_rate_24h !== undefined
          ? `${metrics.ok_rate_24h}%`
          : '—';
      }
      if (cronKpiSent) {
        cronKpiSent.textContent = metrics.sent_24h ?? '—';
      }
      if (cronKpiErrors) {
        cronKpiErrors.textContent = metrics.errors_24h ?? '—';
      }
    }

    function renderCronRows(items) {
      if (!cronTableBody) {
        return;
      }
      cronTableBody.innerHTML = '';
      if (!items || items.length === 0) {
        if (cronEmpty) {
          cronEmpty.hidden = false;
        }
        return;
      }
      if (cronEmpty) {
        cronEmpty.hidden = true;
      }
      const rows = items.map((entry) => {
        const statusLabel = entry.ok ? 'OK' : 'ERROR';
        const statusClass = entry.ok ? 'success' : 'danger';
        return `
          <tr data-cron-row="${entry.id}">
            <td>${formatDateTime(entry.created_at)}</td>
            <td><span class="badge ${statusClass}">${statusLabel}</span></td>
            <td>${entry.sent ?? 0}</td>
            <td>${entry.skipped ?? 0}</td>
            <td>${formatDuration(entry.duration_ms)}</td>
          </tr>
        `;
      });
      cronTableBody.innerHTML = rows.join('');
    }

    async function loadCronRuns({ resetOffset = false } = {}) {
      if (!ADMIN_CRON_RUNS_ENDPOINT || !cronTableBody) {
        return;
      }
      if (resetOffset) {
        cronState.offset = 0;
      }
      const params = new URLSearchParams({
        limit: cronState.limit,
        offset: cronState.offset,
        include_metrics: '1',
      });
      if (cronState.ok) {
        params.set('ok', cronState.ok);
      }
      if (cronState.sentGt) {
        params.set('sent_gt', cronState.sentGt);
      }
      if (cronState.period && cronState.period !== 'all') {
        params.set('period', cronState.period);
      }
      cronTableBody.setAttribute('aria-busy', 'true');
      try {
        const response = await fetch(`${ADMIN_CRON_RUNS_ENDPOINT}?${params.toString()}`);
        const payload = await response.json();
        if (!response.ok || !payload.ok) {
          throw new Error(payload.error || 'Errore caricamento cron');
        }
        cronState.total = payload.total || 0;
        renderCronRows(payload.items || []);
        updateCronMetrics(payload.metrics);
        if (cronPaginationLabel) {
          const currentPage = Math.floor(cronState.offset / cronState.limit) + 1;
          const totalPages = Math.max(1, Math.ceil((payload.total || 0) / cronState.limit));
          cronPaginationLabel.textContent = `Pagina ${currentPage} di ${totalPages}`;
        }
        if (cronUpdatedLabel) {
          cronUpdatedLabel.textContent = `Aggiornato ${formatDateTime(payload.generated_at || new Date().toISOString())}`;
        }
        if (cronPrevButton) {
          cronPrevButton.disabled = cronState.offset <= 0;
        }
        if (cronNextButton) {
          cronNextButton.disabled = cronState.offset + cronState.limit >= cronState.total;
        }
      } catch (error) {
        if (cronEmpty) {
          cronEmpty.hidden = false;
          cronEmpty.textContent = 'Impossibile caricare i run cron.';
        }
      } finally {
        cronTableBody.removeAttribute('aria-busy');
      }
    }

    async function openCronModal(entryId) {
      if (!cronModal) {
        return;
      }
      cronModal.hidden = false;
      cronModal.setAttribute('aria-hidden', 'false');
      if (cronModalSubtitle) {
        cronModalSubtitle.textContent = 'Caricamento dettagli…';
      }
      try {
        const response = await fetch(`${ADMIN_CRON_RUNS_ENDPOINT}/${entryId}`);
        const payload = await response.json();
        if (!response.ok || !payload.ok) {
          throw new Error(payload.error || 'Errore dettaglio cron');
        }
        const entry = payload.entry;
        if (cronModalSubtitle) {
          cronModalSubtitle.textContent = formatDateTime(entry.created_at);
        }
        if (cronModalStatus) {
          cronModalStatus.className = `badge ${entry.ok ? 'success' : 'danger'}`;
          cronModalStatus.textContent = entry.ok ? 'OK' : 'ERROR';
        }
        if (cronModalTiming) {
          cronModalTiming.textContent = `Durata ${formatDuration(entry.duration_ms)}`;
        }
        if (cronModalError) {
          cronModalError.textContent = entry.error || '—';
        }
        if (cronModalException) {
          cronModalException.textContent = entry.exception_type || '—';
        }
        if (cronModalSent) {
          cronModalSent.textContent = entry.sent ?? 0;
        }
        if (cronModalSkipped) {
          cronModalSkipped.textContent = entry.skipped ?? 0;
        }
        if (cronModalJson) {
          cronModalJson.textContent = JSON.stringify(entry.diagnostic_json || {}, null, 2);
        }
      } catch (error) {
        if (cronModalSubtitle) {
          cronModalSubtitle.textContent = 'Errore nel caricamento dei dettagli.';
        }
      }
    }

    function closeCronModal() {
      if (!cronModal) {
        return;
      }
      cronModal.hidden = true;
      cronModal.setAttribute('aria-hidden', 'true');
    }

    function setButtonBusy(button, isBusy, label) {
      if (!button) {
        return;
      }
      if (isBusy) {
        if (!button.dataset.originalLabel) {
          button.dataset.originalLabel = button.innerHTML;
        }
        button.innerHTML = label || '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        button.setAttribute('aria-busy', 'true');
      } else {
        if (button.dataset.originalLabel) {
          button.innerHTML = button.dataset.originalLabel;
          delete button.dataset.originalLabel;
        }
        button.disabled = false;
        button.removeAttribute('aria-busy');
      }
    }

    function setTableLoading(isLoading) {
      if (tableBody) {
        tableBody.setAttribute('aria-busy', String(Boolean(isLoading)));
      }
      if (usersWrapper) {
        usersWrapper.classList.toggle('is-loading', Boolean(isLoading));
      }
    }

    function renderUsers(items) {
      if (!tableBody) {
        return;
      }

      state.items = Array.isArray(items) ? items : [];

      if (!Array.isArray(items) || items.length === 0) {
        tableBody.innerHTML = '';
        if (emptyState) {
          emptyState.hidden = false;
        }
        return;
      }

      const rows = items.map((user) => {
        const hasPremium = Boolean(user.has_premium);
        const premiumClass = hasPremium ? 'premium' : 'free';
        const premiumLabel = hasPremium ? 'Premium ⭐' : 'Gratuito';
        const isAdmin = Boolean(user.is_admin);
        const chatId = user.chat_id || 'Non impostato';
        const hasChat = Boolean(user.chat_id);
        const freeConsumed = Number(user.free_alert_consumed || 0) > 0;

        let thresholdLabel = 'Predefinita (2.0) mV';
        if (typeof user.threshold === 'number' && !Number.isNaN(user.threshold)) {
          thresholdLabel = `${user.threshold.toFixed(2)} mV`;
        }

        const testAlertDisabled = hasChat ? '' : ' disabled aria-disabled="true"';
        const deleteButton = isAdmin
          ? ''
          : `
            <button type="button"
                    class="btn btn-danger btn-sm"
                    data-action="delete-user"
                    data-user-id="${user.id}">
              <i class="fas fa-trash"></i> Elimina
            </button>
          `;

        return `
          <tr data-user-row="${user.id}">
            <td>${escapeHtml(user.email)}</td>
            <td>
              <span class="badge ${premiumClass}">${premiumLabel}</span>
              ${isAdmin ? '<span class="badge admin">Admin</span>' : ''}
            </td>
            <td>${thresholdLabel}</td>
            <td>${escapeHtml(chatId)}</td>
            <td>
              ${freeConsumed ? '<span class="badge warning">Consumata</span>' : '<span class="badge success">Disponibile</span>'}
              <button type="button"
                      class="btn btn-secondary glass btn-sm"
                      data-action="reset-trial"
                      data-user-id="${user.id}">
                <i class="fas fa-undo"></i> Reset prova
              </button>
            </td>
            <td>
              <div class="action-buttons">
                <button type="button"
                        class="btn btn-secondary glass btn-sm"
                        data-action="test-alert"
                        data-user-id="${user.id}"${testAlertDisabled}>
                  <i class="fas fa-satellite-dish"></i> Test alert
                </button>
                <button type="button"
                        class="btn btn-premium btn-sm"
                        data-action="toggle-premium"
                        data-user-id="${user.id}">
                  <i class="fas fa-${hasPremium ? 'star-half-alt' : 'star'}"></i>
                  ${hasPremium ? 'Declassa' : 'Aggiorna'}
                </button>
                ${deleteButton}
              </div>
            </td>
          </tr>
        `;
      }).join('');

      tableBody.innerHTML = rows;
      if (emptyState) {
        emptyState.hidden = true;
      }
    }

    function updateSummary() {
      if (!resultsSummary) {
        return;
      }
      const total = Number(state.total || 0);
      const searchLabel = state.search ? ` per "${state.search}"` : '';
      resultsSummary.textContent = `Totale utenti${searchLabel}: ${total}`;
    }

    function updatePagination() {
      const totalPages = Math.max(1, Number(state.pages || 0));
      const currentPage = Math.min(Math.max(1, Number(state.page || 1)), totalPages);

      if (paginationLabel) {
        paginationLabel.textContent = `Pagina ${currentPage} di ${totalPages}`;
      }

      if (prevButton) {
        prevButton.disabled = currentPage <= 1;
        prevButton.setAttribute('aria-disabled', String(prevButton.disabled));
      }
      if (nextButton) {
        nextButton.disabled = currentPage >= totalPages || totalPages === 0;
        nextButton.setAttribute('aria-disabled', String(nextButton.disabled));
      }
    }

    async function fetchUsers() {
      if (!tableBody) {
        return;
      }

      const params = new URLSearchParams({
        page: String(state.page || 1),
        per_page: String(state.perPage || 20),
      });

      if (state.search) {
        params.set('q', state.search);
      }
      if (state.plan && state.plan !== 'all') {
        params.set('plan', state.plan);
      }

      setTableLoading(true);
      try {
        const response = await fetch(`${ADMIN_USERS_ENDPOINT}?${params.toString()}`, {
          credentials: 'same-origin',
          headers: { Accept: 'application/json' },
        });
        const payload = await response.json();
        if (!response.ok || !payload.ok) {
          throw new Error(payload.message || `HTTP ${response.status}`);
        }

        if (state.page > 1 && payload.pages && state.page > payload.pages) {
          state.page = payload.pages;
          await fetchUsers();
          return;
        }

        state.total = payload.total;
        state.pages = payload.pages || 0;
        renderUsers(payload.items || []);
        updateSummary();
        updatePagination();
      } catch (error) {
        createToast(error.message || 'Errore durante il caricamento degli utenti.', 'error');
      } finally {
        setTableLoading(false);
      }
    }

    function debounce(callback, delay = 300) {
      let timer = null;
      return (...args) => {
        window.clearTimeout(timer);
        timer = window.setTimeout(() => callback.apply(null, args), delay);
      };
    }

    async function sendAdminPost(url, payload = {}, button = null, loadingLabel = null) {
      const body = { ...payload, csrf_token: csrfToken };
      if (button) {
        setButtonBusy(button, true, loadingLabel || '<i class="fas fa-spinner fa-spin"></i>');
      }
      try {
        const response = await fetch(url, {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await response.json().catch(() => ({}));
        if (!response.ok || data.success === false) {
          throw new Error(data.message || `HTTP ${response.status}`);
        }
        return data;
      } finally {
        if (button) {
          setButtonBusy(button, false);
        }
      }
    }

    function refreshAfterAction() {
      fetchUsers();
      loadAdminActions();
      refreshAnalytics();
      if (userAnalyticsSection) {
        loadUserAnalytics();
      }
      if (typeof auditRefresher === 'function') {
        auditRefresher(true);
      }
    }

    const handleSearch = debounce(() => {
      state.search = (searchInput?.value || '').trim();
      state.page = 1;
      fetchUsers();
    }, 350);

    searchInput?.addEventListener('input', handleSearch);

    planSelect?.addEventListener('change', () => {
      state.plan = planSelect.value;
      state.page = 1;
      fetchUsers();
    });

    prevButton?.addEventListener('click', () => {
      if (state.page > 1) {
        state.page -= 1;
        fetchUsers();
      }
    });

    nextButton?.addEventListener('click', () => {
      const totalPages = Math.max(1, Number(state.pages || 0));
      if (state.page < totalPages) {
        state.page += 1;
        fetchUsers();
      }
    });

    tableBody?.addEventListener('click', async (event) => {
      const target = event.target instanceof Element ? event.target.closest('[data-action]') : null;
      if (!target) {
        return;
      }
      const userId = Number.parseInt(target.dataset.userId || '', 10);
      if (!userId) {
        return;
      }
      const action = target.dataset.action;
      try {
        switch (action) {
          case 'toggle-premium': {
            const result = await sendAdminPost(`/admin/toggle_premium/${userId}`, {}, target, '<i class="fas fa-spinner fa-spin"></i>');
            createToast(result.message || 'Stato premium aggiornato.', 'success');
            refreshAfterAction();
            break;
          }
          case 'delete-user': {
            const confirmed = window.confirm('Sei sicuro di voler eliminare questo utente?');
            if (!confirmed) {
              return;
            }
            const result = await sendAdminPost(`/admin/delete_user/${userId}`, {}, target, '<i class="fas fa-spinner fa-spin"></i>');
            createToast(result.message || 'Utente eliminato.', 'success');
            if (state.page > 1 && state.items.length === 1) {
              state.page -= 1;
            }
            refreshAfterAction();
            break;
          }
          case 'reset-trial': {
            const result = await sendAdminPost(`/admin/reset_free_trial/${userId}`, {}, target, '<i class="fas fa-spinner fa-spin"></i>');
            createToast(result.message || 'Prova gratuita ripristinata.', 'success');
            refreshAfterAction();
            break;
          }
          case 'test-alert': {
            const result = await sendAdminPost(`/admin/users/${userId}/test-alert`, {}, target, '<i class="fas fa-spinner fa-spin"></i>');
            createToast(result.message || 'Alert di test inviato.', 'success');
            loadAdminActions();
            break;
          }
          default:
            break;
        }
      } catch (error) {
        createToast(error.message || 'Operazione non riuscita.', 'error');
      }
    });

    globalTestButton?.addEventListener('click', async () => {
      if (!globalTestButton) {
        return;
      }
      setButtonBusy(globalTestButton, true, '<i class="fas fa-spinner fa-spin"></i> In corso...');
      if (globalTestCaption) {
        globalTestCaption.textContent = 'Controllo in corso, attendi qualche istante.';
      }
      try {
        const result = await sendAdminPost(ADMIN_GLOBAL_TEST_ENDPOINT);
        createToast(result.message || 'Controllo completato.', 'success');
        loadAdminActions();
      } catch (error) {
        createToast(error.message || 'Errore durante il test alert.', 'error');
      } finally {
        if (globalTestCaption) {
          globalTestCaption.textContent = 'Esegue immediatamente il controllo degli alert Telegram.';
        }
        setButtonBusy(globalTestButton, false);
      }
    });

    function resolveAdminActionVisual(action, status) {
      const normalizedStatus = (status || 'info').toLowerCase();
      const visuals = {
        upgrade: { icon: 'fa-star', title: 'Upgrade piano' },
        downgrade: { icon: 'fa-star-half-alt', title: 'Downgrade piano' },
        reset_trial: { icon: 'fa-undo', title: 'Reset prova' },
        delete: { icon: 'fa-user-xmark', title: 'Eliminazione utente' },
        test_alert: { icon: 'fa-satellite-dish', title: 'Test alert utente' },
        test_alert_all: { icon: 'fa-bell', title: 'Test alert globale' },
      };
      const fallbackTitle = action ? action.replace(/_/g, ' ') : 'Azione amministratore';
      const base = visuals[action] || { icon: 'fa-circle-info', title: fallbackTitle };
      let modifier = '';
      if (normalizedStatus === 'success') {
        modifier = 'audit-list__item--success';
      } else if (normalizedStatus === 'error') {
        modifier = 'audit-list__item--error';
      } else {
        modifier = 'audit-list__item--alert';
      }
      return { ...base, modifier };
    }

    function renderAdminActions(entries) {
      if (!adminActionsList) {
        return;
      }

      if (!Array.isArray(entries) || entries.length === 0) {
        adminActionsList.innerHTML = '';
        if (adminActionsEmpty) {
          adminActionsEmpty.hidden = false;
        }
        return;
      }

      const items = entries.map((entry) => {
        const visuals = resolveAdminActionVisual(entry.action, entry.status);
        const timestamp = formatDateTime(entry.created_at);
        const statusLabel = entry.status ? entry.status.charAt(0).toUpperCase() + entry.status.slice(1) : '';
        const message = entry.message || visuals.title;
        const statusSuffix = statusLabel ? ` (${escapeHtml(statusLabel)})` : '';
        const adminMeta = entry.admin_email ? `<span><i class="fas fa-user-shield"></i> ${escapeHtml(entry.admin_email)}</span>` : '';
        const targetMeta = entry.target_email ? `<span><i class="fas fa-user"></i> ${escapeHtml(entry.target_email)}</span>` : '';
        const ipMeta = entry.ip_address ? `<span><i class="fas fa-network-wired"></i> ${escapeHtml(entry.ip_address)}</span>` : '';

        return `
          <li class="audit-list__item ${visuals.modifier}">
            <span class="audit-list__icon"><i class="fas ${visuals.icon}"></i></span>
            <div class="audit-list__content">
              <p class="audit-list__title">${escapeHtml(message)}${statusSuffix}</p>
              <p class="audit-list__meta">
                ${adminMeta}
                ${targetMeta}
                <span><i class="fas fa-clock"></i> ${escapeHtml(timestamp)}</span>
                ${ipMeta}
              </p>
            </div>
          </li>
        `;
      }).join('');

      adminActionsList.innerHTML = items;
      if (adminActionsEmpty) {
        adminActionsEmpty.hidden = true;
      }
    }

    async function loadAdminActions(showToastOnError = false) {
      if (!adminActionsList) {
        return;
      }
      adminActionsList.setAttribute('aria-busy', 'true');
      try {
        const response = await fetch(`${ADMIN_ACTIONS_ENDPOINT}?limit=25`, {
          credentials: 'same-origin',
          headers: { Accept: 'application/json' },
        });
        const data = await response.json();
        if (!response.ok || !data.ok) {
          throw new Error(data.error || `HTTP ${response.status}`);
        }
        renderAdminActions(data.entries || []);
      } catch (error) {
        if (showToastOnError) {
          createToast(error.message || 'Errore nel recupero delle attività amministratore.', 'error');
        }
      } finally {
        adminActionsList.removeAttribute('aria-busy');
      }
    }

    adminActionsRefresh?.addEventListener('click', () => loadAdminActions(true));

    async function refreshAnalytics(showToastOnError = false) {
      try {
        const response = await fetch(ADMIN_ANALYTICS_ENDPOINT, {
          credentials: 'same-origin',
          headers: { Accept: 'application/json' },
        });
        const data = await response.json();
        if (!response.ok || !data.ok) {
          throw new Error(data.error || `HTTP ${response.status}`);
        }
        const metrics = data.metrics || {};
        if (analyticsTotal && typeof metrics.total_users === 'number') {
          analyticsTotal.textContent = metrics.total_users;
        }
        if (analyticsPremium && typeof metrics.premium_users === 'number') {
          analyticsPremium.textContent = metrics.premium_users;
        }
        if (analyticsFree && typeof metrics.free_users === 'number') {
          analyticsFree.textContent = metrics.free_users;
        }
        if (analyticsAlerts && typeof metrics.alerts_last_24h === 'number') {
          analyticsAlerts.textContent = metrics.alerts_last_24h;
        }
        if (analyticsUpdated) {
          analyticsUpdated.textContent = `Aggiornato alle ${formatDateTime(data.generated_at)}`;
        }
      } catch (error) {
        if (showToastOnError) {
          createToast(error.message || 'Errore nel caricamento delle analytics.', 'error');
        }
      }
    }

    const userAnalyticsState = {
      items: [],
      sortKey: 'created_at',
      sortDirection: 'desc',
    };

    function formatNumber(value) {
      if (value === null || value === undefined || Number.isNaN(Number(value))) {
        return '—';
      }
      return new Intl.NumberFormat(navigator.language || 'it-IT').format(Number(value));
    }

    function formatPercent(value) {
      if (value === null || value === undefined || Number.isNaN(Number(value))) {
        return '—';
      }
      return `${Number(value).toFixed(1)}%`;
    }

    function getUserAnalyticsParams() {
      return new URLSearchParams({
        period: userAnalyticsPeriod?.value || '30',
        telegram: userAnalyticsTelegram?.value || 'all',
        premium: userAnalyticsPremium?.value || 'all',
        limit: '100',
      });
    }

    function renderUserAnalyticsTable() {
      if (!userAnalyticsTable) {
        return;
      }
      const items = Array.isArray(userAnalyticsState.items) ? userAnalyticsState.items : [];
      if (items.length === 0) {
        userAnalyticsTable.innerHTML = '';
        if (userAnalyticsEmpty) {
          userAnalyticsEmpty.hidden = false;
        }
        return;
      }

      const rows = items.map((user) => {
        const createdAt = formatDateTime(user.created_at);
        const lastAccess = formatDateTime(user.last_access);
        const premiumLabel = user.has_premium ? 'Premium ⭐' : 'Gratuito';
        const premiumClass = user.has_premium ? 'premium' : 'free';
        const telegramLabel = user.telegram_connected ? 'Sì' : 'No';
        const telegramClass = user.telegram_connected ? 'success' : 'warning';
        let thresholdLabel = 'Predefinita (2.0 mV)';
        if (typeof user.threshold === 'number' && !Number.isNaN(user.threshold)) {
          thresholdLabel = `${user.threshold.toFixed(2)} mV`;
        }

        return `
          <tr>
            <td>${escapeHtml(user.email)}</td>
            <td>${escapeHtml(createdAt)}</td>
            <td><span class="badge ${premiumClass}">${premiumLabel}</span></td>
            <td><span class="badge ${telegramClass}">${telegramLabel}</span></td>
            <td>${escapeHtml(thresholdLabel)}</td>
            <td>${escapeHtml(lastAccess)}</td>
          </tr>
        `;
      }).join('');

      userAnalyticsTable.innerHTML = rows;
      if (userAnalyticsEmpty) {
        userAnalyticsEmpty.hidden = true;
      }
    }

    function sortUserAnalyticsItems() {
      const { sortKey, sortDirection } = userAnalyticsState;
      const multiplier = sortDirection === 'asc' ? 1 : -1;
      const sorted = [...(userAnalyticsState.items || [])].sort((a, b) => {
        const getValue = (item) => {
          switch (sortKey) {
            case 'email':
              return (item.email || '').toLowerCase();
            case 'plan':
              return item.has_premium ? 'premium' : 'free';
            case 'telegram_connected':
              return item.telegram_connected ? 1 : 0;
            case 'threshold':
              return typeof item.threshold === 'number' ? item.threshold : -1;
            case 'last_access':
              return item.last_access ? new Date(item.last_access).getTime() : 0;
            case 'created_at':
            default:
              return item.created_at ? new Date(item.created_at).getTime() : 0;
          }
        };
        const valueA = getValue(a);
        const valueB = getValue(b);
        if (typeof valueA === 'number' && typeof valueB === 'number') {
          return (valueA - valueB) * multiplier;
        }
        return String(valueA).localeCompare(String(valueB)) * multiplier;
      });
      userAnalyticsState.items = sorted;
      renderUserAnalyticsTable();
    }

    function updateUserAnalyticsSortButtons() {
      const buttons = Array.from(document.querySelectorAll('.admin-sort'));
      buttons.forEach((button) => {
        const key = button.dataset.sortKey;
        const isActive = key === userAnalyticsState.sortKey;
        button.classList.toggle('is-active', isActive);
        button.setAttribute('aria-sort', isActive ? userAnalyticsState.sortDirection : 'none');
      });
    }

    function renderUserAnalyticsChart(trend) {
      if (!userAnalyticsChart || !window.Plotly) {
        return;
      }
      const dates = (trend || []).map((entry) => entry.date);
      const counts = (trend || []).map((entry) => entry.count);

      const trace = {
        x: dates,
        y: counts,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#38bdf8', width: 3 },
        marker: { size: 6, color: '#38bdf8' },
        hovertemplate: '%{x}<br>Iscrizioni: %{y}<extra></extra>',
      };

      const layout = {
        margin: { t: 20, r: 20, b: 35, l: 40 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#e2e8f0' },
        xaxis: {
          tickfont: { color: '#94a3b8' },
          gridcolor: 'rgba(148,163,184,0.15)',
        },
        yaxis: {
          tickfont: { color: '#94a3b8' },
          gridcolor: 'rgba(148,163,184,0.15)',
        },
      };

      window.Plotly.react(userAnalyticsChart, [trace], layout, { displayModeBar: false, responsive: true });
    }

    async function loadUserAnalytics(showToastOnError = false) {
      if (!userAnalyticsSection) {
        return;
      }
      if (userAnalyticsError) {
        userAnalyticsError.hidden = true;
      }
      try {
        const response = await fetch(`${USER_ANALYTICS_ENDPOINT}?${getUserAnalyticsParams().toString()}`, {
          credentials: 'same-origin',
          headers: { Accept: 'application/json' },
        });
        const data = await response.json();
        if (!response.ok || !data.ok) {
          throw new Error(data.error || `HTTP ${response.status}`);
        }

        const metrics = data.metrics || {};
        if (userAnalyticsTotal) {
          userAnalyticsTotal.textContent = formatNumber(metrics.total_users);
        }
        if (userAnalytics24h) {
          userAnalytics24h.textContent = formatNumber(metrics.new_users_24h);
        }
        if (userAnalytics7d) {
          userAnalytics7d.textContent = formatNumber(metrics.new_users_7d);
        }
        if (userAnalytics30d) {
          userAnalytics30d.textContent = formatNumber(metrics.new_users_30d);
        }
        if (userAnalyticsPremiumSplit) {
          userAnalyticsPremiumSplit.textContent = `Premium: ${formatNumber(metrics.premium_users)} · Free: ${formatNumber(metrics.free_users)}`;
        }
        if (userAnalyticsTelegramCount) {
          userAnalyticsTelegramCount.textContent = formatNumber(metrics.telegram_connected);
        }
        if (userAnalyticsTelegramPct) {
          userAnalyticsTelegramPct.textContent = `${formatPercent(metrics.telegram_connected_pct)} del totale`;
        }
        if (userAnalyticsTelegramRecent) {
          userAnalyticsTelegramRecent.textContent = formatPercent(metrics.telegram_recent_pct);
        }

        if (userAnalyticsUpdated) {
          userAnalyticsUpdated.textContent = `Aggiornato alle ${formatDateTime(data.generated_at)}`;
        }
        if (userAnalyticsSummary) {
          const total = data.filtered?.total ?? 0;
          const periodLabel = userAnalyticsPeriod?.value || '30';
          userAnalyticsSummary.textContent = `Utenti nel periodo: ${formatNumber(total)} (ultimi ${periodLabel} giorni).`;
        }

        userAnalyticsState.items = Array.isArray(data.users) ? data.users : [];
        sortUserAnalyticsItems();
        updateUserAnalyticsSortButtons();
        renderUserAnalyticsChart(data.trend || []);
      } catch (error) {
        if (userAnalyticsError) {
          userAnalyticsError.hidden = false;
        }
        if (userAnalyticsSummary) {
          userAnalyticsSummary.textContent = 'Analytics temporaneamente non disponibili.';
        }
        if (showToastOnError) {
          createToast(error.message || 'Errore nel caricamento delle analytics utenti.', 'error');
        }
      }
    }

    function handleUserAnalyticsSort(event) {
      const button = event.target instanceof Element ? event.target.closest('.admin-sort') : null;
      if (!button) {
        return;
      }
      const key = button.dataset.sortKey;
      if (!key) {
        return;
      }
      if (userAnalyticsState.sortKey === key) {
        userAnalyticsState.sortDirection = userAnalyticsState.sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        userAnalyticsState.sortKey = key;
        userAnalyticsState.sortDirection = 'desc';
      }
      sortUserAnalyticsItems();
      updateUserAnalyticsSortButtons();
    }

    if (userAnalyticsSection) {
      userAnalyticsTableContainer?.addEventListener('click', handleUserAnalyticsSort);
      userAnalyticsPeriod?.addEventListener('change', () => loadUserAnalytics());
      userAnalyticsTelegram?.addEventListener('change', () => loadUserAnalytics());
      userAnalyticsPremium?.addEventListener('change', () => loadUserAnalytics());
      userAnalyticsRefresh?.addEventListener('click', () => loadUserAnalytics(true));
    }

    if (cronPeriodSelect) {
      cronState.period = cronPeriodSelect.value;
      cronState.ok = cronOkSelect?.value || '';
      cronState.sentGt = Number(cronSentSelect?.value || 0);
      cronPeriodSelect.addEventListener('change', () => {
        cronState.period = cronPeriodSelect.value;
        loadCronRuns({ resetOffset: true });
      });
      cronOkSelect?.addEventListener('change', () => {
        cronState.ok = cronOkSelect.value;
        loadCronRuns({ resetOffset: true });
      });
      cronSentSelect?.addEventListener('change', () => {
        cronState.sentGt = Number(cronSentSelect.value || 0);
        loadCronRuns({ resetOffset: true });
      });
      cronRefreshButton?.addEventListener('click', () => loadCronRuns({ resetOffset: true }));
      cronPrevButton?.addEventListener('click', () => {
        cronState.offset = Math.max(0, cronState.offset - cronState.limit);
        loadCronRuns();
      });
      cronNextButton?.addEventListener('click', () => {
        if (cronState.offset + cronState.limit < cronState.total) {
          cronState.offset += cronState.limit;
          loadCronRuns();
        }
      });
      cronTableBody?.addEventListener('click', (event) => {
        const row = event.target instanceof Element ? event.target.closest('[data-cron-row]') : null;
        if (!row) {
          return;
        }
        const entryId = row.getAttribute('data-cron-row');
        if (entryId) {
          openCronModal(entryId);
        }
      });
      cronModalClose?.forEach((button) => button.addEventListener('click', closeCronModal));
      cronModal?.addEventListener('click', (event) => {
        if (event.target === cronModal) {
          closeCronModal();
        }
      });
    }

    function initAdminAudit() {
      const eventsList = document.getElementById('admin-audit-events');
      const alertsList = document.getElementById('admin-alert-feed');
      const refreshButton = document.querySelector('[data-audit-refresh]');
      const eventsCount = document.querySelector('[data-metric-events-count]');
      const alerts24h = document.querySelector('[data-metric-alerts-24h]');
      const eventsLimit = document.querySelector('[data-metric-events-limit]');
      const updatedLabel = document.getElementById('admin-audit-updated');
      const EVENT_LIMIT = 15;
      const ALERT_LIMIT = 10;

      if (eventsLimit) {
        eventsLimit.textContent = EVENT_LIMIT;
      }

      function describeEvent(event) {
        if (!event) {
          return '';
        }
        if (event.message) {
          return event.message;
        }
        if (event.event_type === 'alert' && typeof event.value === 'number') {
          return `Alert tremore ${event.value.toFixed(2)} mV`;
        }
        if (event.event_type === 'threshold_change' && typeof event.threshold === 'number') {
          return `Soglia aggiornata a ${event.threshold.toFixed(2)} mV`;
        }
        switch (event.event_type) {
          case 'login':
            return 'Accesso effettuato';
          case 'subscription':
            return 'Aggiornamento stato abbonamento';
          case 'test_alert':
            return 'Alert di test inviato';
          default:
            return event.event_type ? event.event_type.replace(/_/g, ' ') : 'Evento sistema';
        }
      }

      function resolveIcon(eventType) {
        switch (eventType) {
          case 'alert':
            return { icon: 'fa-exclamation-triangle', modifier: 'audit-list__item--alert' };
          case 'threshold_change':
            return { icon: 'fa-sliders', modifier: 'audit-list__item--success' };
          case 'login':
            return { icon: 'fa-right-to-bracket', modifier: '' };
          case 'subscription':
            return { icon: 'fa-crown', modifier: 'audit-list__item--success' };
          case 'test_alert':
            return { icon: 'fa-satellite-dish', modifier: '' };
          default:
            return { icon: 'fa-circle-info', modifier: '' };
        }
      }

      function renderList(container, items, emptyMessage) {
        if (!container) {
          return;
        }
        if (!Array.isArray(items) || items.length === 0) {
          container.innerHTML = `<p class="audit-list__empty">${escapeHtml(emptyMessage)}</p>`;
          container.setAttribute('aria-busy', 'false');
          return;
        }
        const markup = items.map((item) => {
          const visuals = resolveIcon(item.event_type);
          const timestamp = formatDateTime(item.timestamp);
          const title = describeEvent(item);
          const userEmail = item.user_email ? `<span><i class="fas fa-user"></i> ${escapeHtml(item.user_email)}</span>` : '';
          return `
            <li class="audit-list__item ${visuals.modifier}">
              <span class="audit-list__icon"><i class="fas ${visuals.icon}"></i></span>
              <div class="audit-list__content">
                <p class="audit-list__title">${escapeHtml(title)}</p>
                <p class="audit-list__meta">
                  ${userEmail}
                  <span><i class="fas fa-clock"></i> ${escapeHtml(timestamp)}</span>
                </p>
              </div>
            </li>
          `;
        }).join('');
        container.innerHTML = markup;
        container.setAttribute('aria-busy', 'false');
      }

      async function refreshAudit(manual = false) {
        try {
          const url = new URL(ADMIN_AUDIT_ENDPOINT, window.location.origin);
          url.searchParams.set('limit', EVENT_LIMIT);
          url.searchParams.set('alerts_limit', ALERT_LIMIT);
          const response = await fetch(url.toString(), {
            credentials: 'same-origin',
            headers: { Accept: 'application/json' },
          });
          const data = await response.json();
          if (!response.ok || !data.ok) {
            throw new Error(data.error || `HTTP ${response.status}`);
          }
          if (Array.isArray(data.events)) {
            renderList(eventsList, data.events, 'Nessun evento registrato.');
            if (eventsCount) {
              eventsCount.textContent = data.events.length;
            }
          }
          if (Array.isArray(data.alerts)) {
            renderList(alertsList, data.alerts, 'Nessun alert recente.');
          }
          if (alerts24h && data.metrics) {
            alerts24h.textContent = data.metrics.alerts_last_24h;
          }
          if (updatedLabel) {
            updatedLabel.textContent = `Aggiornato alle ${formatDateTime(data.generated_at)}`;
          }
          if (auditStatus) {
            auditStatus.textContent = manual ? 'Registro aggiornato manualmente.' : 'Registro aggiornato automaticamente.';
          }
        } catch (error) {
          if (auditStatus) {
            auditStatus.textContent = `Errore aggiornamento registro: ${error.message}`;
          }
          if (manual) {
            createToast(error.message || 'Errore durante l\'aggiornamento del registro.', 'error');
          }
        }
      }

      refreshButton?.addEventListener('click', () => refreshAudit(true));

      refreshAudit();
      auditTimer = window.setInterval(refreshAudit, 60000);
      return refreshAudit;
    }

    auditRefresher = initAdminAudit();

    renderUsers(state.items);
    updateSummary();
    updatePagination();
    loadAdminActions();
    refreshAnalytics();
    loadUserAnalytics();
    loadCronRuns();

    analyticsTimer = window.setInterval(refreshAnalytics, 300000);
    adminActionsTimer = window.setInterval(loadAdminActions, 120000);

    window.addEventListener('beforeunload', () => {
      window.clearInterval(analyticsTimer);
      window.clearInterval(adminActionsTimer);
      window.clearInterval(auditTimer);
    });
  })();
</script>
{% endblock %}
