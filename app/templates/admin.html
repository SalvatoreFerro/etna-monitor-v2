{% extends "layout.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
<style>
@media only screen and (max-width: 393px) and (-webkit-min-device-pixel-ratio: 3) {
  .admin-container {
    padding: 12px max(4px, env(safe-area-inset-right)) 12px max(4px, env(safe-area-inset-left));
    width: 100%;
    box-sizing: border-box;
  }
  
  .admin-header {
    padding: 16px max(4px, env(safe-area-inset-right)) 16px max(4px, env(safe-area-inset-left));
    margin-bottom: 12px;
    width: 100%;
    box-sizing: border-box;
  }
  
  .admin-header h1 {
    font-size: var(--font-size-xl);
    margin-bottom: var(--space-2);
  }
  
  .admin-content {
    padding: 16px max(4px, env(safe-area-inset-right)) 16px max(4px, env(safe-area-inset-left));
    width: 100%;
    box-sizing: border-box;
  }
  
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    box-sizing: border-box;
  }
  
  .table-premium {
    font-size: var(--font-size-xs);
    min-width: 100%;
  }
  
  .table-premium th,
  .table-premium td {
    padding: var(--space-1) var(--space-2);
    font-size: var(--font-size-xs);
  }
  
  .action-buttons {
    flex-direction: column;
    gap: var(--space-1);
  }
  
  .action-buttons .btn {
    font-size: var(--font-size-xs);
    padding: var(--space-1) var(--space-2);
    width: 100%;
  }
  
  .badge {
    font-size: var(--font-size-xs);
    padding: 2px 6px;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
  <div class="admin-header card-premium animate-premium-fade">
    <h1><i class="fas fa-users-cog"></i> Admin Panel</h1>
    <p>Manage users and system settings</p>
  </div>
  
  <div class="admin-content card-premium animate-premium-slide">
    <div style="margin-bottom: 20px;">
      <button onclick="testAlert()" class="btn btn-premium">
        <i class="fas fa-bell"></i> Test Alert
      </button>
      <small style="color: #888; margin-left: 10px;">Esegue immediatamente il controllo degli alert Telegram</small>
    </div>
    
    <div class="table-container">
      <table class="table table-premium">
        <thead>
          <tr>
            <th>Email</th>
            <th>Tipo Account</th>
            <th>Soglia Personalizzata</th>
            <th>ID Chat</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
            <tr>
              <td>{{ user.email }}</td>
              <td>
                <span class="badge {{ 'premium' if user.premium else 'free' }}">
                  {{ 'Premium ⭐' if user.premium else 'Free' }}
                </span>
                {% if user.is_admin %}
                  <span class="badge admin">Admin</span>
                {% endif %}
              </td>
              <td>{{ user.threshold or 'Predefinita (2.0)' }} mV</td>
              <td>{{ user.chat_id or 'Non impostato' }}</td>
              <td>
                <div class="action-buttons">
                  <button onclick="togglePremium({{ user.id }})" class="btn btn-premium btn-sm">
                    <i class="fas fa-{{ 'star' if not user.premium else 'star-half-alt' }}"></i>
                    {{ 'Aggiorna' if not user.premium else 'Declassa' }}
                  </button>
                  {% if not user.is_admin %}
                    <button onclick="deleteUser({{ user.id }})" class="btn btn-danger btn-sm">
                      <i class="fas fa-trash"></i> Elimina
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  function togglePremium(userId) {
    fetch(`/admin/toggle_premium/${userId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    });
  }

  function deleteUser(userId) {
    if (confirm('Sei sicuro di voler eliminare questo utente? Questa azione non può essere annullata.')) {
      fetch(`/admin/delete_user/${userId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert(data.message);
        }
      });
    }
  }

  function testAlert(event) {
    const button = event ? event.target : document.querySelector('button[onclick="testAlert()"]');
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Controllo in corso...';
    button.disabled = true;
    
    fetch('/admin/test-alert', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      button.innerHTML = originalText;
      button.disabled = false;
      
      if (data.success) {
        alert('✅ Controllo alert eseguito con successo!\n\n' + data.message);
      } else {
        alert('❌ Errore durante il controllo: ' + data.message);
      }
    })
    .catch(error => {
      button.innerHTML = originalText;
      button.disabled = false;
      alert('❌ Errore di connessione: ' + error.message);
    });
  }
</script>
{% endblock %}
