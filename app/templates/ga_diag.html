{% extends "layout.html" %}

{% block content %}
  <section class="container ga-diagnostics" aria-labelledby="ga-diagnostics-title">
    <div class="content">
      <h1 id="ga-diagnostics-title">GA4 Diagnostics</h1>
      <p>Measurement ID attivo: <code>{{ analytics.ga_measurement_id or 'missing' }}</code></p>
      <p>ID Google Ads configurato: <code>{{ analytics.google_ads_id or 'non configurato' }}</code></p>
      <p>Usa questa pagina per verificare che gli script GA4 siano caricati correttamente con la CSP attuale.</p>
      <p id="ga-loader-status">Stato caricamento gtag.js: <span>verifica in corso…</span></p>
      <p id="ga-container-status">Stato google_tag_manager: <span>verifica in corso…</span></p>
      <details>
        <summary>Snapshot dataLayer</summary>
        <pre id="ga-datalayer-dump" class="ga-diagnostics__dump" aria-live="polite">Caricamento…</pre>
      </details>
      <details>
        <summary>Snapshot google_tag_manager</summary>
        <pre id="ga-gtm-dump" class="ga-diagnostics__dump" aria-live="polite">Caricamento…</pre>
      </details>
      <details>
        <summary>Come abilitare il debug GA in pagina</summary>
        <div class="ga-diagnostics__instructions">
          <ol>
            <li>Aggiungi <code>?ga_debug=1</code> alla URL per forzare il <em>debug_mode</em> nelle chiamate GA.</li>
            <li>Apri il pannello Network e filtra per <code>collect</code> per verificare le richieste verso Google Analytics.</li>
            <li>Apri DebugView in GA4 per monitorare gli eventi <code>page_view</code> e <code>ga_diag_visit</code>.</li>
          </ol>
        </div>
      </details>
    </div>
  </section>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script nonce="{{ script_nonce }}">
    console.log("GA ID:", "{{ analytics.ga_measurement_id }}");
    (async () => {
      try {
        await fetch("https://www.google-analytics.com/g/collect", { mode: "no-cors" });
        console.log("GA fetch: OK");
      } catch (error) {
        console.error("GA fetch error", error);
      }
    })();
    const dataLayerDumpEl = document.getElementById("ga-datalayer-dump");
    const gtmDumpEl = document.getElementById("ga-gtm-dump");
    const loaderStatusEl = document.querySelector("#ga-loader-status span");
    const containerStatusEl = document.querySelector("#ga-container-status span");

    const updateStatus = (el, message, status) => {
      if (!el) {
        return;
      }
      el.textContent = message;
      el.dataset.status = status;
    };

    const gtagScript = document.querySelector('script[src^="https://www.googletagmanager.com/gtag/js"]');
    if (gtagScript) {
      gtagScript.addEventListener("load", () => {
        updateStatus(loaderStatusEl, "caricato correttamente", "success");
      }, { once: true });
      gtagScript.addEventListener("error", () => {
        updateStatus(loaderStatusEl, "errore nel caricamento (controlla la CSP)", "error");
      }, { once: true });
      if (gtagScript.dataset && gtagScript.dataset.loaded === "true") {
        updateStatus(loaderStatusEl, "caricato (evento load già emesso)", "success");
      }
      setTimeout(() => {
        if (loaderStatusEl && !loaderStatusEl.dataset.status) {
          updateStatus(loaderStatusEl, "caricamento in attesa…", "pending");
        }
      }, 1000);
    } else {
      updateStatus(loaderStatusEl, "tag script non trovato nel DOM", "error");
    }

    if (dataLayerDumpEl) {
      const snapshot = Array.isArray(window.dataLayer) ? window.dataLayer.slice() : "(dataLayer non disponibile)";
      try {
        dataLayerDumpEl.textContent = JSON.stringify(snapshot, null, 2);
      } catch (error) {
        console.warn("Impossibile serializzare dataLayer", error);
        dataLayerDumpEl.textContent = "(errore durante la serializzazione del dataLayer)";
      }
    }

    const refreshContainerSnapshot = () => {
      const container = window.google_tag_manager || null;
      if (containerStatusEl) {
        if (container && container["{{ analytics.ga_measurement_id }}"]) {
          updateStatus(containerStatusEl, "istanza attiva per {{ analytics.ga_measurement_id }}", "success");
        } else if (container) {
          updateStatus(containerStatusEl, "oggetto presente ma senza istanza per l'ID attivo", "warning");
        } else {
          updateStatus(containerStatusEl, "oggetto non inizializzato", "warning");
        }
      }

      if (gtmDumpEl) {
        try {
          gtmDumpEl.textContent = JSON.stringify(container, null, 2);
        } catch (error) {
          console.warn("Impossibile serializzare google_tag_manager", error);
          gtmDumpEl.textContent = "(errore durante la serializzazione di google_tag_manager)";
        }
      }
    };

    refreshContainerSnapshot();
    window.addEventListener("load", refreshContainerSnapshot, { once: false });
    if (typeof gtag === "function" && {{ 'true' if analytics.ga_measurement_id else 'false' }}) {
      gtag("event", "ga_diag_visit", {
        event_category: "diagnostics",
        event_label: window.location.href,
        debug_mode: true,
      });
    }
  </script>
{% endblock %}
