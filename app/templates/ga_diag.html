{% extends "layout.html" %}

{% block content %}
  <section class="container ga-diagnostics" aria-labelledby="ga-diagnostics-title">
    <div class="content">
      <h1 id="ga-diagnostics-title">GA4 Diagnostics</h1>
      <p>Measurement ID attivo: <code>{{ analytics.ga_measurement_id or 'missing' }}</code></p>
      <p>ID Google Ads configurato: <code>{{ analytics.google_ads_id or 'non configurato' }}</code></p>
      <p>Usa questa pagina per verificare che gli script GA4 siano caricati correttamente con la CSP attuale.</p>
      <details>
        <summary>Snapshot dataLayer</summary>
        <pre id="ga-datalayer-dump" class="ga-diagnostics__dump" aria-live="polite">Caricamentoâ€¦</pre>
      </details>
    </div>
  </section>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script nonce="{{ script_nonce }}">
    console.log("GA ID:", "{{ analytics.ga_measurement_id }}");
    (async () => {
      try {
        await fetch("https://www.google-analytics.com/g/collect", { mode: "no-cors" });
        console.log("GA fetch: OK");
      } catch (error) {
        console.error("GA fetch error", error);
      }
    })();
    const dataLayerDumpEl = document.getElementById("ga-datalayer-dump");
    if (dataLayerDumpEl) {
      const snapshot = Array.isArray(window.dataLayer) ? window.dataLayer.slice() : "(dataLayer non disponibile)";
      try {
        dataLayerDumpEl.textContent = JSON.stringify(snapshot, null, 2);
      } catch (error) {
        console.warn("Impossibile serializzare dataLayer", error);
        dataLayerDumpEl.textContent = "(errore durante la serializzazione del dataLayer)";
      }
    }
    if (typeof gtag === "function" && {{ 'true' if analytics.ga_measurement_id else 'false' }}) {
      gtag("event", "ga_diag_visit", {
        event_category: "diagnostics",
        event_label: window.location.href,
        debug_mode: true,
      });
    }
  </script>
{% endblock %}
