{% extends "layout.html" %}

{% set page_title = "Forum Community" %}
{% set page_description = "Domande, risposte e discussioni tra gli appassionati di EtnaMonitor." %}

{% block content %}
<section class="forum-hero" aria-labelledby="forum-hero-title">
  <div class="container forum-hero__inner">
    <div class="forum-hero__copy" data-animate>
      <span class="pill pill--glow">Community</span>
      <h1 id="forum-hero-title">Forum Q&amp;A</h1>
      <p class="lead">
        Condividi dubbi, best practice e suggerimenti: la community ti aiuta a interpretare i dati e usare al meglio la piattaforma.
      </p>
      <ul class="forum-highlights" role="list">
        <li class="forum-highlights__item" role="listitem">
          <i class="fas fa-mountain" aria-hidden="true"></i>
          <span>Workflow commentati dalle nostre guide.</span>
        </li>
        <li class="forum-highlights__item" role="listitem">
          <i class="fas fa-chart-line" aria-hidden="true"></i>
          <span>Alert dedicati alle discussioni più attive.</span>
        </li>
        <li class="forum-highlights__item" role="listitem">
          <i class="fas fa-medal" aria-hidden="true"></i>
          <span>Badge e punti per chi aiuta la community.</span>
        </li>
      </ul>
    </div>
    <div class="forum-hero__card" data-animate>
      <div class="forum-hero__card-inner">
        <strong>Pronto a partecipare?</strong>
        <p>Accedi con il tuo account EtnaMonitor e pubblica domande o risposte in pochi secondi.</p>
        {% if current_user.is_authenticated %}
          <a class="btn btn-primary btn-sm" href="#new-thread">Apri una discussione</a>
        {% else %}
          <a class="btn btn-primary btn-sm" href="{{ url_for('auth.login', next=request.path) }}">Effettua l'accesso</a>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<section class="forum-submit" aria-label="Apri nuova discussione">
  <div class="container">
    {% if current_user.is_authenticated %}
      <form method="post" class="card" id="new-thread" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <h2><i class="fas fa-plus"></i> Avvia una nuova domanda</h2>
        <div class="forum-identity" role="status">
          <i class="fas fa-user-circle" aria-hidden="true"></i>
          <div>
            <span class="forum-identity__label">Pubblicherai come</span>
            <strong>{{ display_name }}</strong>
          </div>
        </div>
        <label>
          <span>Titolo</span>
          <input type="text" name="title" minlength="10" maxlength="160" required placeholder="Es. Come interpretare un picco improvviso?" />
        </label>
        <label>
          <span>Messaggio</span>
          <textarea name="body" rows="5" minlength="20" required placeholder="Descrivi il contesto, allega link o schermate…"></textarea>
        </label>
        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Pubblica</button>
      </form>
    {% else %}
      <div class="card">
        <h2><i class="fas fa-lock"></i> Accedi per aprire una discussione</h2>
        <p>Per mantenere il forum libero dallo spam, solo gli utenti registrati possono pubblicare nuove domande.</p>
        <a class="btn btn-primary" href="{{ url_for('auth.login', next=request.path) }}"><i class="fas fa-sign-in-alt"></i> Effettua l'accesso</a>
      </div>
    {% endif %}
  </div>
</section>

<section class="forum-threads" aria-label="Discussioni attive">
  <div class="container">
    {% if threads %}
      <ul class="forum-thread-list">
        {% for thread in threads %}
          <li class="forum-thread-card">
            <h2><a href="{{ url_for('community.thread_detail', slug=thread.slug) }}">{{ thread.title }}</a></h2>
            <p>{{ thread.body[:220] }}{% if thread.body|length > 220 %}…{% endif %}</p>
            <footer>
              <span><i class="fas fa-user"></i> {{ thread.author_name or 'Anonimo' }}</span>
              <span><i class="fas fa-clock"></i> {{ thread.updated_at.strftime('%d/%m/%Y %H:%M') }}</span>
              <span><i class="fas fa-comments"></i> {{ thread.replies.count() }}</span>
              <span class="badge {{ 'success' if thread.status == 'resolved' else 'info' }}">{{ 'Risolta' if thread.status == 'resolved' else 'In corso' }}</span>
            </footer>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="lead">Sii il primo ad aprire una discussione! I nostri esperti monitorano costantemente la sezione.</p>
    {% endif %}
  </div>
</section>
{% endblock %}
