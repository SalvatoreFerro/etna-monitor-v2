{% extends "layout.html" %}

{% block content %}
<section class="page page--experience" aria-label="Etna Experience">
  <div class="experience-hero experience-hero--compact" data-animate>
    <div class="container experience-hero__inner">
      <div class="experience-hero__copy">
        <span class="experience-hero__eyebrow">Etna Experience</span>
        <h1>Vivi l'Etna con itinerari selezionati</h1>
        <p class="experience-hero__subtitle">
          Tour curati da guide locali, tra crateri, vigneti e borghi autentici. Seleziona la categoria che preferisci e prenota
          in pochi clic.
        </p>
        <div class="experience-hero__actions experience-hero__actions--wrap">
          <a class="btn btn-primary" href="#experience-grid">Scopri le esperienze</a>
          <a
            class="btn btn-ghost"
            href="mailto:{{ concierge_email }}?subject={{ 'Richiesta Etna Experience' |urlencode }}"
            data-lead-trigger
          >
            Parla con il concierge
          </a>
        </div>
        <ul class="experience-hero__highlights" role="list">
          <li class="experience-hero__highlight-item">
            <i class="fas fa-hiking" aria-hidden="true"></i>
            <span>Guide certificate e briefing personalizzati</span>
          </li>
          <li class="experience-hero__highlight-item">
            <i class="fas fa-compass" aria-hidden="true"></i>
            <span>Itinerari aggiornati ogni settimana</span>
          </li>
          <li class="experience-hero__highlight-item">
            <i class="fas fa-wine-glass-alt" aria-hidden="true"></i>
            <span>Esperienze gourmet tra cantine e borghi</span>
          </li>
        </ul>
      </div>
      <figure class="experience-hero__art" aria-hidden="true">
        <img
          src="{{ url_for('static', filename='images/etna-experience-hero.svg') }}"
          loading="lazy"
          decoding="async"
          alt=""
        />
      </figure>
    </div>
  </div>

  <div class="container experience-container">
    <section class="experience-directory" id="experience-grid" aria-labelledby="experience-directory-title">
      <header class="experience-directory__header" data-animate>
        <div>
          <h2 id="experience-directory-title">Seleziona la tua esperienza</h2>
          <p class="muted">Stai esplorando <strong>{{ category_label }}</strong></p>
        </div>
        <p class="experience-directory__results">
          {{ pagination.total }} {{ 'proposta' if pagination.total == 1 else 'proposte' }} disponibili ora.
        </p>
      </header>

      <div class="experience-directory__filters" role="tablist" aria-label="Filtra per categoria">
        {% for value, label in filter_labels %}
          {% set is_active = (not selected_category and value == 'all') or (selected_category == value) %}
          <button
            type="button"
            class="filter-chip {{ 'is-active' if is_active }}"
            data-filter="{{ value }}"
            role="tab"
            aria-selected="{{ 'true' if is_active else 'false' }}"
          >
            {{ label }}
          </button>
        {% endfor %}
      </div>

      <div class="experience-card-grid">
        {% if partners %}
          {% for partner in partners %}
            {% set actions = contact_actions.get(partner.id, []) %}
            {% set primary_action = actions[0] if actions else None %}
            <article class="experience-card" data-animate>
              <div class="experience-card__media">
                {% if partner.image_url %}
                  <img
                    src="{{ partner.image_url }}"
                    alt="{{ partner.name }}"
                    loading="lazy"
                    decoding="async"
                    onerror="this.src='{{ url_for('static', filename='images/experience-placeholder.svg') }}'"
                  />
                {% else %}
                  <img
                    src="{{ url_for('static', filename='images/experience-placeholder.svg') }}"
                    alt="Illustrazione Etna Experience"
                    loading="lazy"
                    decoding="async"
                  />
                {% endif %}
                {% if partner.description %}
                  <div class="experience-card__hover" aria-hidden="true">
                    <p>{{ partner.description }}</p>
                  </div>
                {% endif %}
              </div>
              <div class="experience-card__body">
                <div class="experience-card__meta">
                  <span class="pill">{{ partner.category_label() }}</span>
                  {% if partner.verified %}
                    <span class="badge badge--success">Verificato</span>
                  {% endif %}
                </div>
                <h3>{{ partner.name }}</h3>
                <p class="experience-card__info">
                  {{ partner.contact or 'Durata e prezzo su richiesta' }}
                </p>
              </div>
              <div class="experience-card__actions">
                {% if partner.website %}
                  <a
                    href="{{ partner.website }}"
                    class="btn btn-primary"
                    target="_blank"
                    rel="noopener"
                  >
                    Dettagli
                  </a>
                {% else %}
                  <button
                    class="btn btn-primary"
                    type="button"
                    data-lead-trigger
                    data-partner-name="{{ partner.name }}"
                  >
                    Dettagli
                  </button>
                {% endif %}

                {% if primary_action %}
                  {% set is_external = primary_action.href.startswith('http') %}
                  <a
                    href="{{ primary_action.href }}"
                    class="btn btn-ghost"
                    {% if is_external %}target="_blank" rel="noopener"{% endif %}
                  >
                    {{ primary_action.label }}
                  </a>
                {% else %}
                  <button
                    class="btn btn-ghost"
                    type="button"
                    data-lead-trigger
                    data-partner-name="{{ partner.name }}"
                  >
                    Contatta
                  </button>
                {% endif %}
              </div>
            </article>
          {% endfor %}
        {% else %}
          <div class="experience-card experience-card--empty" data-animate>
            <h3>Nessuna esperienza disponibile</h3>
            <p>Stiamo caricando nuove proposte curate: torna a trovarci a breve.</p>
          </div>
        {% endif %}
      </div>

      {% if pagination.pages > 1 %}
        <nav class="pagination" aria-label="Navigazione pagine esperienze">
          {% set category_param = selected_category if selected_category else None %}
          {% if pagination.page > 1 %}
            <a
              class="pagination__link"
              href="{{ url_for('experience.experience_home', category=category_param, page=pagination.page - 1) }}"
              rel="prev"
            >
              â€¹ Precedente
            </a>
          {% endif %}
          {% for number in range(1, pagination.pages + 1) %}
            <a
              class="pagination__link {{ 'is-active' if number == pagination.page }}"
              href="{{ url_for('experience.experience_home', category=category_param, page=number) }}"
            >
              {{ number }}
            </a>
          {% endfor %}
          {% if pagination.page < pagination.pages %}
            <a
              class="pagination__link"
              href="{{ url_for('experience.experience_home', category=category_param, page=pagination.page + 1) }}"
              rel="next"
            >
              Successiva â€º
            </a>
          {% endif %}
        </nav>
      {% endif %}
    </section>

    <section class="experience-section" aria-labelledby="experience-how" data-animate>
      <header class="experience-section__header">
        <h2 id="experience-how">Come funziona</h2>
        <p>Tre passaggi rapidi per costruire la tua Etna Experience perfetta.</p>
      </header>
      <div class="experience-steps">
        <article class="experience-step">
          <div class="experience-step__icon" aria-hidden="true">ðŸ§­</div>
          <h3>Seleziona la proposta</h3>
          <p>Scegli tra trekking, jeep tour, shooting o momenti relax con filtri intuitivi.</p>
        </article>
        <article class="experience-step">
          <div class="experience-step__icon" aria-hidden="true">ðŸ“ž</div>
          <h3>Parla con la guida</h3>
          <p>Ricevi disponibilitÃ , briefing sicurezza e suggerimenti logistici in poche ore.</p>
        </article>
        <article class="experience-step">
          <div class="experience-step__icon" aria-hidden="true">ðŸ”¥</div>
          <h3>Vivi il vulcano</h3>
          <p>Arriva preparato con itinerario personalizzato e supporto continuo sul territorio.</p>
        </article>
      </div>
    </section>

    <section class="experience-section experience-section--reasons" aria-labelledby="experience-why" data-animate>
      <header class="experience-section__header">
        <h2 id="experience-why">PerchÃ© scegliere guide EtnaMonitor</h2>
        <p>Affidati a una rete locale curata con verifiche periodiche e strumenti digitali.</p>
      </header>
      <div class="experience-reasons">
        <article class="experience-reason">
          <h3>Curatela indipendente</h3>
          <p>Ogni partner Ã¨ verificato sul campo con audit trimestrali e feedback reali.</p>
        </article>
        <article class="experience-reason">
          <h3>Monitoraggio vulcanico</h3>
          <p>Le guide ricevono aggiornamenti dai modelli EtnaMonitor per pianificare in sicurezza.</p>
        </article>
        <article class="experience-reason">
          <h3>Esperienze modulari</h3>
          <p>Combina piÃ¹ attivitÃ  grazie a calendari sincronizzati e supporto concierge.</p>
        </article>
        <article class="experience-reason">
          <h3>SostenibilitÃ  concreta</h3>
          <p>Promuoviamo filiere locali, mobilitÃ  leggera e protocolli ambientali condivisi.</p>
        </article>
      </div>
    </section>

    <section class="experience-section experience-section--faq" aria-labelledby="experience-faq" data-animate>
      <header class="experience-section__header">
        <h2 id="experience-faq">FAQ rapide</h2>
        <p>Le risposte essenziali per organizzare la tua prossima uscita sull'Etna.</p>
      </header>
      <div class="experience-faq">
        {% for entry in faq_entries %}
          <details>
            <summary>{{ entry.question }}</summary>
            <p>{{ entry.answer }}</p>
          </details>
        {% endfor %}
      </div>
    </section>
  </div>

  <a
    class="experience-sticky-cta"
    href="mailto:{{ concierge_email }}?subject={{ 'Prenotazione Etna Experience' |urlencode }}"
    data-lead-trigger
  >
    Prenota o Contatta guide
  </a>
</section>

{% endblock %}

{% block page_structured_data %}
  {{ super() }}
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', () => {
      const filterButtons = Array.from(document.querySelectorAll('[data-filter]'));
      if (filterButtons.length) {
        filterButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const category = button.dataset.filter;
            const url = new URL(window.location.href);
            if (category === 'all') {
              url.searchParams.delete('category');
            } else {
              url.searchParams.set('category', category);
            }
            url.searchParams.delete('page');
            window.location.assign(url.toString());
          });
        });
      }

      const leadButtons = Array.from(document.querySelectorAll('[data-lead-trigger]'));
      leadButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
          const partnerName = button.getAttribute('data-partner-name');
          const subjectBase = partnerName ? `Richiesta dettagli Etna Experience â€“ ${partnerName}` : 'Richiesta Etna Experience';
          const bodyLines = [
            partnerName ? `Esperienza: ${partnerName}` : 'Esperienza: da consigliare',
            'Periodo preferito:',
            'Numero partecipanti:',
            'Note:'
          ];
          const mailto = `mailto:{{ concierge_email }}?subject=${encodeURIComponent(subjectBase)}&body=${encodeURIComponent(bodyLines.join('\n'))}`;
          if (event.currentTarget.tagName === 'A' && event.currentTarget.getAttribute('href').startsWith('mailto:')) {
            return;
          }
          window.location.href = mailto;
        });
      });

      const animatedElements = Array.from(document.querySelectorAll('[data-animate]'));
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries, obs) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add('is-visible');
              obs.unobserve(entry.target);
            }
          });
        }, {
          rootMargin: '0px 0px -10%',
          threshold: 0.2,
        });
        animatedElements.forEach((el) => observer.observe(el));
      } else {
        animatedElements.forEach((el) => el.classList.add('is-visible'));
      }
    });
  </script>
{% endblock %}
