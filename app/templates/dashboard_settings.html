{% extends "layout.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}?v={{ STATIC_ASSET_VERSION }}">
<style>
.settings-container {
  max-width: 960px;
  margin: 0 auto;
  padding: var(--space-7) var(--space-5);
  display: flex;
  flex-direction: column;
  gap: var(--space-5);
}

.settings-header {
  padding: var(--space-6);
  border-radius: var(--radius-2xl);
  background: var(--surface-raised);
  box-shadow: var(--shadow-lg);
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.settings-header h1 {
  margin: 0;
  font-size: clamp(1.75rem, 2vw, 2.5rem);
}

.settings-grid {
  display: grid;
  gap: var(--space-4);
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}

.settings-card {
  padding: var(--space-5);
  border-radius: var(--radius-2xl);
  background: rgba(24, 26, 32, 0.65);
  backdrop-filter: blur(12px);
  box-shadow: var(--shadow-md);
  display: flex;
  flex-direction: column;
  gap: var(--space-4);
}

.account-details {
  display: grid;
  gap: var(--space-3);
}

.account-details dl {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: var(--space-2) var(--space-4);
  margin: 0;
}

.account-details dt {
  color: var(--text-muted);
  font-size: var(--font-size-sm);
}

.account-details dd {
  margin: 0;
  font-weight: 600;
}

.pill {
  display: inline-flex;
  align-items: center;
  gap: var(--space-2);
  padding: 6px 14px;
  border-radius: 999px;
  font-size: var(--font-size-sm);
  background: rgba(79, 70, 229, 0.12);
  color: var(--accent);
  width: fit-content;
}

.feature-list {
  display: grid;
  gap: var(--space-3);
  margin: 0;
  padding: 0;
  list-style: none;
}

.feature-list li {
  display: flex;
  gap: var(--space-3);
  align-items: flex-start;
}

.feature-list svg {
  flex-shrink: 0;
  margin-top: 4px;
}

.actions-group {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-3);
}

.secondary-card {
  background: rgba(26, 30, 40, 0.45);
  border: 1px solid rgba(148, 163, 184, 0.12);
}

.secondary-card h3 {
  margin: 0;
}

.muted-text {
  color: var(--text-muted);
  font-size: var(--font-size-sm);
}

.inline-link {
  color: var(--accent);
  text-decoration: none;
}

.inline-link:hover,
.inline-link:focus {
  text-decoration: underline;
}

@media only screen and (max-width: 768px) {
  .settings-container {
    padding: var(--space-6) var(--space-4);
  }

  .settings-header,
  .settings-card {
    padding: var(--space-5);
  }

  .actions-group {
    flex-direction: column;
  }
}

@media only screen and (max-width: 393px) and (-webkit-min-device-pixel-ratio: 3) {
  .settings-container {
    padding: 12px max(4px, env(safe-area-inset-right)) 12px max(4px, env(safe-area-inset-left));
    width: 100%;
    box-sizing: border-box;
  }

  .settings-header {
    padding: 16px max(4px, env(safe-area-inset-right)) 16px max(4px, env(safe-area-inset-left));
  }

  .settings-card {
    padding: 16px max(4px, env(safe-area-inset-right)) 16px max(4px, env(safe-area-inset-left));
  }

  .actions-group {
    width: 100%;
  }

  .actions-group .btn {
    width: 100%;
    justify-content: center;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
  <div class="settings-header animate-premium-fade">
    <span class="pill">Area personale</span>
    <h1>Impostazioni account</h1>
    <p>Gestisci i dettagli del tuo profilo e scopri le funzionalitÃ  disponibili per il tuo piano.</p>
  </div>

  <div class="settings-grid">
    <section class="settings-card animate-premium-slide">
      <header>
        <h2>Riepilogo account</h2>
        <p class="muted-text">Informazioni principali sul tuo profilo e sullo stato dell'abbonamento.</p>
      </header>
      <div class="account-details">
        <div class="pill">
          {% if user.has_premium_access %}
            ðŸŸ¢ Piano Premium attivo
          {% elif not user.free_alert_consumed %}
            âšª Piano Free â€“ alert di prova disponibile
          {% else %}
            ðŸ”´ Piano Free â€“ prova consumata
          {% endif %}
        </div>
        <dl>
          <dt>Email</dt>
          <dd>{{ user.email }}</dd>
          {% if user.name %}
          <dt>Nome</dt>
          <dd>{{ user.name }}</dd>
          {% endif %}
          {% if user.created_at %}
          <dt>Registrato il</dt>
          <dd>{{ user.created_at.strftime('%d/%m/%Y') }}</dd>
          {% endif %}
          <dt>Soglia attuale</dt>
          <dd>
            {% if user.has_premium_access %}
              {{ '%.1f'|format(user.threshold or default_threshold) }} mV Â· gestisci dalla
              <a class="inline-link" href="{{ url_for('dashboard.dashboard_home') }}#threshold-settings">dashboard</a>
            {% else %}
              {{ default_threshold }} mV predefiniti (aggiornabili con Premium)
            {% endif %}
          </dd>
          <dt>Stato prova gratuita</dt>
          <dd>{{ 'Disponibile' if not user.free_alert_consumed else 'Consumata' }}</dd>
          <dt>Notifiche Telegram</dt>
          <dd>
            {% if user.telegram_chat_id or user.chat_id %}
              Connesso (ID {{ user.telegram_chat_id or user.chat_id }})
              {% if user.free_alert_consumed and not user.has_premium_access %}
                Â· Riceverai solo messaggi di servizio finchÃ© non attivi Premium.
              {% endif %}
            {% else %}
              Non collegato Â· collega Telegram dalla <a class="inline-link" href="{{ url_for('dashboard.dashboard_home') }}#alert-settings">dashboard</a>
            {% endif %}
          </dd>
          {% if user.consent_ts %}
          <dt>Consenso Telegram</dt>
          <dd>{{ user.consent_ts.strftime('%d/%m/%Y %H:%M') }} Â· Privacy {{ user.privacy_version or 'corrente' }}</dd>
          {% endif %}
        </dl>
      </div>

      <div class="actions-group">
        <a href="{{ url_for('dashboard.dashboard_home') }}" class="btn btn-secondary glass">Apri Dashboard</a>
        <a href="{{ url_for('dashboard.dashboard_home') }}#threshold-settings" class="btn btn-premium">Gestisci soglia</a>
        <a href="{{ url_for('dashboard.dashboard_home') }}#alert-settings" class="btn btn-secondary glass">Configura avvisi</a>
      </div>
    </section>

    <section class="settings-card secondary-card animate-premium-slide">
      <header>
        <h2>{% if user.has_premium_access %}Strumenti avanzati Premium{% else %}PerchÃ© passare a Premium{% endif %}</h2>
        <p class="muted-text">
          {% if user.has_premium_access %}
            Sfrutta tutte le funzionalitÃ  dedicate al monitoraggio pro avanzato.
          {% else %}
            Sblocca strumenti esclusivi per un monitoraggio completo e in tempo reale.
          {% endif %}
        </p>
      </header>
      <ul class="feature-list">
        <li>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 10.5L7.5 14L16 6" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <h3>Soglie personalizzate</h3>
            <p class="muted-text">Imposta il livello di allerta direttamente dalla dashboard per adattare gli avvisi al tuo scenario.</p>
          </div>
        </li>
        <li>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 10.5L7.5 14L16 6" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <h3>Avvisi in tempo reale</h3>
            <p class="muted-text">Ricevi notifiche email e Telegram sugli eventi critici senza ritardi.</p>
          </div>
        </li>
        <li>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 10.5L7.5 14L16 6" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <h3>Storico eventi</h3>
            <p class="muted-text">Consulta le variazioni recenti registrate dalla piattaforma per un'analisi rapida.</p>
          </div>
        </li>
      </ul>

      {% if not user.has_premium_access %}
      <a href="/pricing" class="btn btn-premium">Scopri i piani Premium</a>
      {% else %}
      <p class="muted-text">Hai giÃ  accesso a tutte le funzionalitÃ  Premium: personalizzale dalla dashboard in qualsiasi momento.</p>
      {% endif %}
    </section>
  </div>

  <section class="settings-card animate-premium-fade">
    <header>
      <h2>Supporto e risorse</h2>
      <p class="muted-text">Consigli pratici per sfruttare al meglio Etna Monitor.</p>
    </header>
    <ul class="feature-list">
      <li>
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 10.5L7.5 14L16 6" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div>
          <h3>Dashboard live</h3>
          <p class="muted-text">Monitora il tremore in tempo reale e aggiorna il grafico con l'intervallo che preferisci.</p>
        </div>
      </li>
      <li>
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 10.5L7.5 14L16 6" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div>
          <h3>Preferenze alert</h3>
          <p class="muted-text">Attiva gli avvisi piÃ¹ importanti per te direttamente dalla dashboard.</p>
        </div>
      </li>
      <li>
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 10.5L7.5 14L16 6" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div>
          <h3>Supporto dedicato</h3>
          <p class="muted-text">Hai bisogno di aiuto? Scrivici a <a class="inline-link" href="mailto:salvoferro16@gmail.com">salvoferro16@gmail.com</a>.</p>
        </div>
      </li>
    </ul>
  </section>
</div>
{% endblock %}
